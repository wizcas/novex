@using Novex.Data.Models
@using AntDesign

<Card Title="聊天记录" Size="@CardSize.Small" Style="height: 100%;">
    <Extra>
        <Space>
            <SpaceItem>
                <AntDesign.InputNumber @bind-Value="CurrentChatLogIndex" Min="1" Max="@TotalChatLogs"
                                     Style="width: 100px;" Placeholder="楼层"/>
            </SpaceItem>
            <SpaceItem>
                <Button OnClick="@(() => OnJumpToChatLog.InvokeAsync(CurrentChatLogIndex))">跳转</Button>
            </SpaceItem>
            <SpaceItem>
                <Button Icon="@IconType.Outline.Left" OnClick="@OnPreviousChatLog"
                        Disabled="@(CurrentChatLogIndex <= 1)">上一条</Button>
            </SpaceItem>
            <SpaceItem>
                <Button Icon="@IconType.Outline.Right" OnClick="@OnNextChatLog"
                        Disabled="@(CurrentChatLogIndex >= TotalChatLogs)">下一条</Button>
            </SpaceItem>
            <SpaceItem>
                <Button Type="@ButtonType.Primary" Icon="@IconType.Outline.Plus"
                        OnClick="@OnInsertToChapter" Disabled="@(SelectedChapter == null || CurrentChatLog == null)">
                    插入到章节
                </Button>
            </SpaceItem>
        </Space>
    </Extra>
    <ChildContent>
        @if (CurrentChatLog != null)
        {
            <div style="height: calc(100% - 80px); overflow-y: auto; padding: 16px;">
                @if (!string.IsNullOrEmpty(CurrentAnalysisResult?.Title))
                {
                    <div style="margin-bottom: 16px;">
                        <Text Strong="true" Style="font-size: 16px; color: #1890ff;">📝 标题：</Text>
                        <div style="background: #f6f8ff; padding: 12px; border-radius: 6px; margin-top: 6px; border-left: 4px solid #1890ff;">
                            <Text Strong="true" Style="font-size: 15px; color: #1890ff;">@CurrentAnalysisResult.Title</Text>
                        </div>
                    </div>
                }

                @if (!string.IsNullOrEmpty(CurrentAnalysisResult?.Summary))
                {
                    <div style="margin-bottom: 16px;">
                        <Text Strong="true" Style="font-size: 16px; color: #52c41a;">📋 摘要：</Text>
                        <div style="background: #f6ffed; padding: 12px; border-radius: 6px; margin-top: 6px; border-left: 4px solid #52c41a;">
                            <Text Style="font-size: 14px; line-height: 1.6;">@CurrentAnalysisResult.Summary</Text>
                        </div>
                    </div>
                }

                @if (!string.IsNullOrEmpty(CurrentAnalysisResult?.MainBody))
                {
                    <div style="margin-bottom: 16px;">
                        <Text Strong="true" Style="font-size: 16px; color: #fa8c16;">📄 正文内容：</Text>
                        <div style="background: #fff7e6; padding: 12px; border-radius: 6px; margin-top: 6px; border-left: 4px solid #fa8c16; white-space: pre-wrap; overflow-y:auto; height: 130px;">
                                <Text Style="font-size: 14px; line-height: 1.8;">@CurrentAnalysisResult.MainBody</Text>
                        </div>
                    </div>
                }

                @if (CurrentAnalysisResult == null)
                {
                    <div style="text-align: center; padding: 32px;">
                        <Empty Description="@("该聊天记录尚未分析")">
                            <ChildContent>
                                <Button Type="@ButtonType.Primary"
                                        OnClick="@(() => OnNavigateTo.InvokeAsync($"/chatlogs/{BookId}/{CurrentChatLog.Id}/analyze"))">
                                    前往分析
                                </Button>
                            </ChildContent>
                        </Empty>
                    </div>
                }

                <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid #f0f0f0;">
                    <Text Type="@TextElementType.Secondary" Style="font-size: 12px;">
                        楼层 @CurrentChatLog.Index | @CurrentChatLog.Name | @CurrentChatLog.SendDate.ToString("yyyy-MM-dd HH:mm:ss")
                    </Text>
                </div>
            </div>
        }
        else if (TotalChatLogs == 0)
        {
            <div style="height: calc(100% - 80px); display: flex; align-items: center; justify-content: center;">
                <Empty Description="@("该书目暂无聊天记录分析结果。\n请先导入并分析聊天记录。")">
                    <ChildContent>
                        <Button Type="@ButtonType.Primary"
                                OnClick="@(() => OnNavigateTo.InvokeAsync($"/import/{BookId}"))">
                            导入聊天记录
                        </Button>
                    </ChildContent>
                </Empty>
            </div>
        }
        else
        {
            <div style="height: calc(100% - 80px); display: flex; align-items: center; justify-content: center;">
                <Spin Size="@SpinSize.Large"/>
            </div>
        }
    </ChildContent>
</Card>

@code {
    [Parameter] public int BookId { get; set; }
    [Parameter] public BookChapter? SelectedChapter { get; set; }
    [Parameter] public ChatLog? CurrentChatLog { get; set; }
    [Parameter] public ChatLogAnalysisResult? CurrentAnalysisResult { get; set; }
    [Parameter] public int CurrentChatLogIndex { get; set; }
    [Parameter] public EventCallback<int> CurrentChatLogIndexChanged { get; set; }
    [Parameter] public int TotalChatLogs { get; set; }

    [Parameter] public EventCallback OnPreviousChatLog { get; set; }
    [Parameter] public EventCallback OnNextChatLog { get; set; }
    [Parameter] public EventCallback<int> OnJumpToChatLog { get; set; }
    [Parameter] public EventCallback OnInsertToChapter { get; set; }
    [Parameter] public EventCallback<string> OnNavigateTo { get; set; }
}
