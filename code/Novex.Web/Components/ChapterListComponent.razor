@using Microsoft.AspNetCore.Components.Web
@using Novex.Data.Models
@using AntDesign
@using Novex.Data.Services
@using System.Text.Json.Serialization
@inject IAiTitleGenerationService AiTitleGenerationService
@inject IBookChapterService BookChapterService
@inject IMessageService MessageService
@inject IAITitlePromptService PromptService
@inject IJSRuntime JSRuntime
@implements IDisposable

<!-- 章节列表卡片 -->

<Card Title="章节列表" Size="@CardSize.Small" Style="height: 100%;" BodyStyle="height: 100%;">
    <Extra>
        <Button Type="@ButtonType.Primary" Size="@ButtonSize.Small" Icon="@IconType.Outline.Plus"
            OnClick="AddChapterDirectly">
            新增章节
        </Button>
    </Extra>
    <ChildContent>
        <div style="height: calc(100% - 36px); min-height: 0; overflow-y: auto;">
            @if (Chapters.Any())
            {
                <div id="chapter-list">
                    @foreach (var chapter in Chapters)
                    {
                        <div class="chapter-item @(SelectedChapter?.Id == chapter.Id ? "selected" : "")"
                            @onclick="@(() => OnSelectChapter.InvokeAsync(chapter))" data-chapter-id="@chapter.Id">
                            <div class="chapter-content">
                                <Text Strong="@(SelectedChapter?.Id == chapter.Id)">
                                    第@(chapter.Order)章 @chapter.Title
                                </Text>
                                <div class="chapter-actions">
                                    <span @onclick:stopPropagation="true">
                                        <Button Type="@ButtonType.Text" Size="@ButtonSize.Small" Icon="@IconType.Outline.Edit"
                                            OnClick="@(() => ShowEditChapterModal(chapter))" />
                                    </span>
                                    <span @onclick:stopPropagation="true">
                                        <Popconfirm Title="确定要删除这个章节吗？"
                                            OnConfirm="@(() => OnDeleteChapter.InvokeAsync(chapter))" Icon="delete">
                                            <span>
                                                <Button Type="@ButtonType.Text" Size="@ButtonSize.Small"
                                                    Icon="@IconType.Outline.Delete" Danger="true" />
                                            </span>
                                        </Popconfirm>
                                    </span>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            }
            else
            {
                <Empty Description="@("暂无章节")">
                    <ChildContent>
                        <Button Type="@ButtonType.Primary" OnClick="AddChapterDirectly">
                            创建第一个章节
                        </Button>
                    </ChildContent>
                </Empty>
            }
        </div>
    </ChildContent>
</Card>

<!-- 新增章节模态框 -->
<Modal Title="新增章节" @bind-Visible="showAddChapterModal" OnOk="AddChapter"
    OnCancel="@(() => showAddChapterModal = false)">
    <Form Model="@newChapterForm">
        <FormItem Label="章节标题">
            <Input @bind-Value="newChapterForm.Title" Placeholder="请输入章节标题" />
        </FormItem>
    </Form>
</Modal>

<!-- 编辑章节标题模态框 -->
<Modal Title="编辑章节标题" @bind-Visible="showEditChapterModal" OnOk="UpdateChapterTitle"
    OnCancel="@(() => showEditChapterModal = false)">
    <Form Model="@editChapterForm">
        <!-- 章节标题输入框 -->
        <FormItem Label="章节标题">
            <Input @bind-Value="editChapterForm.Title" Placeholder="请输入章节标题" />
        </FormItem>
        <!-- AI 辅助功能区 -->
        <div style="border: 1px solid #f0f0f0; border-radius: 4px; padding: 16px; margin-top: 24px;">
            <Row Gutter="8" Align="RowAlign.Middle" Wrap="false">
                <AntDesign.Col Flex="@("auto")">
                    <Select TItem="PromptChoice" TItemValue="string" DataSource="@_promptChoices"
                        @bind-Value="@_selectedPromptId" ItemValue="@(c => c.Id)"
                        ItemLabel="@(c => c.DisplayText.Length > 25 ? c.DisplayText.Substring(0, 25) + "..." : c.DisplayText)"
                        OnSelectedItemChanged="async (_) => await OnPromptSelectionChanged()" Placeholder="选择一个提示词风格"
                        Style="width: 100%;">
                        <ItemTemplate Context="choice">
                            <div style="text-overflow: ellipsis; white-space: nowrap; overflow: hidden;">
                                @choice.DisplayText</div>
                            @if (!choice.IsDefault)
                            {
                                <AntDesign.Text Type="TextElementType.Secondary">更新于:
                                    @choice.UpdatedAt.ToLocalTime().ToString("yy-MM-dd HH:mm")</AntDesign.Text>
                            }
                        </ItemTemplate>
                    </Select>
                </AntDesign.Col>
                <AntDesign.Col Flex="@("32px")">
                    <Button Icon="@IconType.Outline.Sync" OnClick="@(() => LoadAvailablePromptsAsync(false))" />
                </AntDesign.Col>
            </Row>
            <Space Direction="SpaceDirection.Horizontal" Align="SpaceAlign.Center" Style="margin-top: 16px;">
                <SpaceItem>
                    @if (isGeneratingTitles)
                    {
                        <Button OnClick="CancelAiGeneration" Danger>
                            <Icon Type="stop" /> 取消生成
                        </Button>
                    }
                    else
                    {
                        <Button OnClick="GenerateTitlesWithAI">
                            <Icon Type="experiment" /> AI 生成
                        </Button>
                    }
                </SpaceItem>
                <SpaceItem>
                    <a href="/settings#prompt-settings" target="_blank">
                        管理提示词
                        <Icon Type="link" />
                    </a>
                </SpaceItem>
            </Space>
            @if (suggestedTitles.Any())
            {
                <div style="margin-top: 16px;">
                    <Text Type="@TextElementType.Secondary">建议标题：</Text>
                    <div style="margin-top: 8px;">
                        @foreach (var title in suggestedTitles)
                        {
                            <Tag Color="TagColor.Blue" OnClick="@(() => SelectSuggestedTitle(title))"
                                Style="cursor: pointer; margin-bottom: 8px;">
                                @title
                            </Tag>
                        }
                    </div>
                </div>
            }
        </div>
    </Form>
</Modal>

<style>
    .chapter-item {
        padding: 8px 12px;
        margin-bottom: 4px;
        border-radius: 6px;
        cursor: move;
        transition: all 0.3s;
        border: 1px solid transparent;
        position: relative;
    }

    .chapter-item:hover {
        background-color: #f5f5f5;
    }

    .chapter-item.selected {
        background-color: #e6f7ff;
        border-color: #1890ff;
    }

    .chapter-item.dragging {
        opacity: 0.5;
        background-color: #f0f0f0;
    }

    .chapter-item.drag-over-top::before {
        content: '';
        position: absolute;
        top: -2px;
        left: 0;
        right: 0;
        height: 3px;
        background-color: #1890ff;
        border-radius: 2px;
    }

    .chapter-item.drag-over-bottom::after {
        content: '';
        position: absolute;
        bottom: -2px;
        left: 0;
        right: 0;
        height: 3px;
        background-color: #1890ff;
        border-radius: 2px;
    }

    .chapter-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .chapter-actions {
        opacity: 0;
        transition: opacity 0.3s;
    }

    .chapter-item:hover .chapter-actions {
        opacity: 1;
    }
</style>

@code {
    [Parameter] public List<BookChapter> Chapters { get; set; } = new();
    [Parameter] public int BookId { get; set; }
    [Parameter] public BookChapter? SelectedChapter { get; set; }
    [Parameter] public EventCallback<BookChapter> OnSelectChapter { get; set; }
    [Parameter] public EventCallback<BookChapter> OnDeleteChapter { get; set; }
    [Parameter] public EventCallback<BookChapter> OnChapterAdded { get; set; }
    [Parameter] public EventCallback<BookChapter> OnChapterUpdated { get; set; }
    [Parameter] public EventCallback OnChaptersReordered { get; set; }

    // 模态框相关
    private bool showAddChapterModal = false;
    private bool showEditChapterModal = false;
    private NewChapterForm newChapterForm = new();
    private EditChapterForm editChapterForm = new();
    private BookChapter? editingChapter;

    // AI 生成标题相关
    private bool isGeneratingTitles = false;
    private List<string> suggestedTitles = new();
    private List<PromptChoice> _promptChoices = new();
    private string _selectedPromptId = "default";
    private const string LocalStorageKey = "selectedAiTitlePromptId";
    private CancellationTokenSource? _generationCts;

    // 拖放相关
    private DotNetObjectReference<ChapterListComponent>? _dotNetHelper;

    public class PromptChoice
    {
        public string Id { get; set; } = string.Empty;
        public string DisplayText { get; set; } = string.Empty;
        public DateTime UpdatedAt { get; set; }
        public bool IsDefault { get; set; }
        public string OriginalStylePrompt { get; set; } = string.Empty;
    }

    public class NewChapterForm
    {
        public string Title { get; set; } = string.Empty;
    }

    public class EditChapterForm
    {
        public string Title { get; set; } = string.Empty;
    }

    private async Task AddChapterDirectly()
    {
        var nextOrder = await BookChapterService.GetNextOrderAsync(BookId);
        var newChapter = await BookChapterService.CreateChapterAsync(BookId, "无标题", nextOrder);

        await OnChapterAdded.InvokeAsync(newChapter);
        MessageService.Success("章节创建成功");
    }

    private void ShowAddChapterModal()
    {
        newChapterForm = new NewChapterForm();
        suggestedTitles.Clear();
        showAddChapterModal = true;
    }

    private async Task AddChapter()
    {
        if (string.IsNullOrWhiteSpace(newChapterForm.Title))
        {
            MessageService.Error("请输入章节标题");
            return;
        }

        var nextOrder = await BookChapterService.GetNextOrderAsync(BookId);
        var newChapter = await BookChapterService.CreateChapterAsync(BookId, newChapterForm.Title, nextOrder);

        showAddChapterModal = false;
        await OnChapterAdded.InvokeAsync(newChapter);
        MessageService.Success("章节创建成功");
    }

    private async Task ShowEditChapterModal(BookChapter chapter)
    {
        editingChapter = chapter;
        editChapterForm = new EditChapterForm { Title = chapter.Title };
        suggestedTitles.Clear();

        // 加载提示词并设置默认选项
        await LoadAvailablePromptsAsync(true);
        var savedPromptId = await JSRuntime.InvokeAsync<string>("localStorage.getItem", LocalStorageKey);

        if (!string.IsNullOrEmpty(savedPromptId) && _promptChoices.Any(p => p.Id == savedPromptId))
        {
            _selectedPromptId = savedPromptId;
        }
        else
        {
            _selectedPromptId = "default";
        }

        showEditChapterModal = true;
    }

    private async Task LoadAvailablePromptsAsync(bool isInitial)
    {
        var promptsFromDb = await PromptService.GetAllPromptsAsync();
        var choices = promptsFromDb.Select(p => new PromptChoice
        {
            Id = p.Id.ToString(),
            DisplayText = p.StylePrompt,
            UpdatedAt = p.UpdatedAt,
            OriginalStylePrompt = p.StylePrompt
        }).ToList();

        choices.Insert(0, new PromptChoice
        {
            Id = "default",
            DisplayText = "默认提示词",
            IsDefault = true,
            OriginalStylePrompt =
        string.Empty
        });
        _promptChoices = choices;

        if (!isInitial)
        {
            MessageService.Success("提示词列表已刷新");
        }
        StateHasChanged();
    }

    private async Task UpdateChapterTitle()
    {
        if (editingChapter == null || string.IsNullOrWhiteSpace(editChapterForm.Title)) return;

        editingChapter.Title = editChapterForm.Title;
        await BookChapterService.UpdateChapterAsync(editingChapter);

        showEditChapterModal = false;
        await OnChapterUpdated.InvokeAsync(editingChapter);
        MessageService.Success("章节标题更新成功");
    }

    private void SelectSuggestedTitle(string title)
    {
        editChapterForm.Title = title;
    }

    private async Task OnPromptSelectionChanged()
    {
        await JSRuntime.InvokeVoidAsync("localStorage.setItem", LocalStorageKey, _selectedPromptId);
    }

    private void CancelAiGeneration()
    {
        _generationCts?.Cancel();
        MessageService.Info("AI 标题生成已取消。");
    }

    private async Task GenerateTitlesWithAI()
    {
        if (editingChapter == null || string.IsNullOrWhiteSpace(editingChapter.Content))
        {
            MessageService.Warning("章节内容为空，无法生成标题。");
            return;
        }

        isGeneratingTitles = true;
        suggestedTitles.Clear();
        _generationCts = new CancellationTokenSource();
        StateHasChanged();

        try
        {
            string promptTemplate = string.Empty;
            if (_selectedPromptId != "default")
            {
                var selectedChoice = _promptChoices.FirstOrDefault(p => p.Id == _selectedPromptId);
                if (selectedChoice != null)
                {
                    promptTemplate = selectedChoice.OriginalStylePrompt;
                }
            }
            // The service interface will be updated to accept a CancellationToken
            suggestedTitles = await AiTitleGenerationService.GenerateTitlesAsync(editingChapter.Content, promptTemplate,
            _generationCts.Token);
        }
        catch (OperationCanceledException)
        {
            // This is expected on cancellation, the CancelAiGeneration method already shows an info message.
        }
        catch (Exception ex)
        {
            MessageService.Error($"AI 标题生成时发生错误: {ex.Message}");
        }
        finally
        {
            isGeneratingTitles = false;
            _generationCts?.Dispose();
            StateHasChanged();
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _dotNetHelper = DotNetObjectReference.Create(this);
            await JSRuntime.InvokeVoidAsync("chapterDragDrop.initializeDragDrop", _dotNetHelper);
        }
    }

    [JSInvokable]
    public async Task HandleChapterReorder(int draggedChapterId, int targetChapterId, bool insertBefore)
    {
        var draggedChapter = Chapters.FirstOrDefault(c => c.Id == draggedChapterId);
        var targetChapter = Chapters.FirstOrDefault(c => c.Id == targetChapterId);

        if (draggedChapter == null || targetChapter == null || draggedChapter.Id == targetChapter.Id)
        {
            return;
        }

        // 保存原始章节顺序用于失败回滚
        var originalChapters = new List<BookChapter>(Chapters);

        try
        {
            // 从列表中移除被拖动的章节
            Chapters.Remove(draggedChapter);

            // 找到目标位置
            var targetIndex = Chapters.IndexOf(targetChapter);
            if (!insertBefore)
            {
                targetIndex++;
            }

            // 插入到新位置
            Chapters.Insert(targetIndex, draggedChapter);

            // 立即更新 UI（乐观更新）
            StateHasChanged();

            // 获取新的章节顺序（仅获取 ID）
            var chapterIds = Chapters.Select(c => c.Id).ToList();

            // 调用服务保存到数据库
            var (success, updatedChapters) = await BookChapterService.ReorderChaptersAsync(BookId, chapterIds);

            if (success)
            {
                // 用返回的数据更新本地列表，确保 Order 值与数据库同步
                Chapters.Clear();
                foreach (var chapter in updatedChapters)
                {
                    Chapters.Add(chapter);
                }

                MessageService.Success("章节顺序已更新");
                await OnChaptersReordered.InvokeAsync();
                StateHasChanged();
            }
            else
            {
                // 失败时恢复原始顺序
                Chapters.Clear();
                foreach (var chapter in originalChapters)
                {
                    Chapters.Add(chapter);
                }

                MessageService.Error("章节顺序更新失败，已恢复原始顺序");
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            // 异常时恢复原始顺序
            Chapters.Clear();
            foreach (var chapter in originalChapters)
            {
                Chapters.Add(chapter);
            }

            MessageService.Error($"章节顺序更新出错：{ex.Message}");
            StateHasChanged();
        }
    }

    public void Dispose()
    {
        _dotNetHelper?.Dispose();
        _generationCts?.Dispose();
    }
}