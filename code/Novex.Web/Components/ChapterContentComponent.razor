@using Novex.Data.Models
@using AntDesign

<Card Title="@(SelectedChapter != null ? $"第{SelectedChapter.Order}章 {SelectedChapter.Title}" : "章节内容")"
      Size="@CardSize.Small" Style="height: 100%;">
    <Extra>
        @if (SelectedChapter != null)
        {
            <Space Size="@("middle")">
                <SpaceItem>
                    <Text Type="@TextElementType.Secondary" Style="font-size: 13px;">
                        字数：<Text Strong="true" Style="color: #1890ff;">@WordCount</Text>
                    </Text>
                </SpaceItem>
                <SpaceItem>
                    <Button Type="@ButtonType.Default"
                            Size="@ButtonSize.Small"
                            Icon="@IconType.Outline.Fullscreen"
                            OnClick="@OpenFullscreenEditor">
                        展开编辑
                    </Button>
                </SpaceItem>
            </Space>
        }
    </Extra>
    <ChildContent>
        @if (SelectedChapter != null)
        {
            <CodeMirrorEditor @ref="editorRef"
                              @key="@($"editor-{SelectedChapter.Id}")"
                              Value="@Value"
                              OnContentChanged="@((newValue) => ValueChanged.InvokeAsync(newValue))"
                              Style="height: 425px;"
                              LineNumbers="false" />
        }
        else
        {
            <div style="height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                <Text Type="@TextElementType.Secondary">请选择一个章节开始编辑</Text>
            </div>
        }
    </ChildContent>
</Card>

<!-- 全屏编辑器 Modal -->
<Modal Title="@(SelectedChapter != null ? $"第{SelectedChapter.Order}章 {SelectedChapter.Title}" : "章节内容")"
       @bind-Visible="@_isFullscreenVisible"
       Width="@("95vw")"
       Style="top: 20px;"
       BodyStyle="height: calc(95vh - 110px); padding: 0;"
       Footer="null"
       Maximizable="true"
       Draggable="true">
    <div style="height: 100%; display: flex; flex-direction: column;">
        <div style="padding: 12px 24px; background: #fafafa; border-bottom: 1px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center;">
            <Text Type="@TextElementType.Secondary" Style="font-size: 13px;">
                字数：<Text Strong="true" Style="color: #1890ff;">@WordCount</Text>
            </Text>
            <Button Type="@ButtonType.Primary"
                    Size="@ButtonSize.Small"
                    Icon="@IconType.Outline.Check"
                    OnClick="@CloseFullscreenEditor">
                完成编辑
            </Button>
        </div>
        <div style="flex: 1; padding: 16px; overflow: hidden;">
            @if (SelectedChapter != null)
            {
                <CodeMirrorEditor @ref="fullscreenEditorRef"
                                  @key="@($"fullscreen-editor-{SelectedChapter.Id}")"
                                  Value="@Value"
                                  OnContentChanged="@((newValue) => ValueChanged.InvokeAsync(newValue))"
                                  Style="height: 100%;"
                                  Height="100%"
                                  LineNumbers="true" />
            }
        </div>
    </div>
</Modal>

@code {
    [Parameter] public BookChapter? SelectedChapter { get; set; }
    [Parameter] public string Value { get; set; } = string.Empty;
    [Parameter] public EventCallback<string> ValueChanged { get; set; }

    private CodeMirrorEditor? editorRef;
    private CodeMirrorEditor? fullscreenEditorRef;
    private bool _isFullscreenVisible = false;

    private int WordCount => string.IsNullOrEmpty(Value) ? 0 : Value.Length;

    private void OpenFullscreenEditor()
    {
        _isFullscreenVisible = true;
    }

    private void CloseFullscreenEditor()
    {
        _isFullscreenVisible = false;
    }
}
