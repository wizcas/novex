@page "/settings"
@using System.ComponentModel.DataAnnotations

<PageTitle>设置</PageTitle>

<div style="padding: 24px;">
  <Title Level="2">
    <Icon Type="setting" style="margin-right: 8px; color: #1890ff;" /> 设置
  </Title>

  <Divider Orientation="DividerOrientation.Left">LLM API 设置</Divider>

  <div style="max-width: 600px; margin-top: 24px;">
    <Form Model="@model" LabelCol="new ColLayoutParam { Span = 6 }" WrapperCol="new ColLayoutParam { Span = 18 }">
      <FormItem Label="API 地址">
        <Input @bind-Value="@context.ApiUrl" Placeholder="请输入 OpenAI 兼容的 API 地址" />
      </FormItem>

      <FormItem Label="API 密钥">
        <InputPassword @bind-Value="@context.ApiKey" Placeholder="请输入您的 API 密钥" />
      </FormItem>

      <FormItem Label="模型">
        <Row>
          <Col Span="16">
          <Select TItem="string" TItemValue="string" @bind-Value="@context.ModelName" Placeholder="获取模型列表以选择模型"
            Style="width: 100%;">
            @if (_models.Any())
            {
              @foreach (var model in _models)
              {
                <SelectOption TItem="string" TItemValue="string" Value="@model" Label="@model" />
              }
            }
          </Select>
          </Col>
          <Col Span="8">
          <Button OnClick="FetchModels"
            Disabled="string.IsNullOrWhiteSpace(context.ApiUrl) || string.IsNullOrWhiteSpace(context.ApiKey)" Block
            Style="margin-left: 8px;">
            获取模型
          </Button>
          </Col>
        </Row>
      </FormItem>
    </Form>
  </div>

</div>

@code {
  public class Model
  {
    [Required]
    public string? ApiUrl { get; set; }

    [Required]
    public string? ApiKey { get; set; }
    [Required]
    public string? ModelName { get; set; }
  }

  private Model model = new Model();

  private List<string> _models = new();

  private async Task FetchModels()
  {
    // This is a placeholder for the actual logic to fetch models from the API.
    // In a real implementation, you would make an HTTP request here.
    _models = new List<string> { "gpt-4", "gpt-3.5-turbo", "text-davinci-003" };
    if (string.IsNullOrEmpty(model.ModelName) && _models.Any())
    {
      model.ModelName = _models.First();
    }
    await InvokeAsync(StateHasChanged);
  }
}