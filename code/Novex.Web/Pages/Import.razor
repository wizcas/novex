@page "/import"
@using Novex.Data.Services
@using Microsoft.AspNetCore.Components.Forms
@using Novex.Data.Models
@inject IChatLogService ChatLogService
@inject IBookService BookService
@inject IJSRuntime JSRuntime

<PageTitle>å¯¼å…¥èŠå¤©è®°å½•</PageTitle>

<div class="import-page">
    <div style="margin-bottom: 24px;">
        <Title Level="2">
            <Icon Type="upload" style="margin-right: 8px; color: #1890ff;" />
            å¯¼å…¥ SillyTavern èŠå¤©è®°å½•
        </Title>
    </div>

    <div style="margin-bottom: 24px;">
        <Alert Type="@AlertType.Info" Message="ä½¿ç”¨è¯´æ˜" ShowIcon="true">
            <MessageTemplate>
                <div>
                    <strong>ä½¿ç”¨è¯´æ˜ï¼š</strong>
                    <ul style="margin: 8px 0 0 0; padding-left: 20px;">
                        <li>é€‰æ‹© SillyTavern å¯¼å‡ºçš„ JSONL æ–‡ä»¶</li>
                        <li>æ–‡ä»¶ä¸­æ¯è¡Œåº”è¯¥æ˜¯ä¸€ä¸ª JSON å¯¹è±¡ï¼ŒåŒ…å« nameã€mesã€send_date å­—æ®µ</li>
                        <li>åªæœ‰åŒ…å« name å­—æ®µçš„è®°å½•ä¼šè¢«å¯¼å…¥</li>
                        <li>å¯¼å…¥ä¼šæ›¿æ¢ç°æœ‰çš„æ‰€æœ‰èŠå¤©è®°å½•</li>
                    </ul>
                </div>
            </MessageTemplate>
        </Alert>
    </div>

    <div style="margin-bottom: 24px;">
        <div style="margin-bottom: 8px;">
            <Text Strong="true">é€‰æ‹©ä¹¦ç›®ï¼š</Text>
        </div>
        <Select DataSource="@filteredBooks" Value="@selectedBookId"
                ValueChanged="@((int? value) => OnBookIdChanged(value))" ItemValue="b => b.Id" ItemLabel="b => b.Name"
                Placeholder="æœç´¢æˆ–é€‰æ‹©ä¹¦ç›®..." EnableSearch="true" AutoClearSearchValue="false" AllowClear="true"
                Disabled="@isImporting" Size="@InputSize.Large" OnSearch="OnBookSearch" Style="width: 100%;">
            <DropdownRender Context="originNode">
                <div>
                    @if (!string.IsNullOrWhiteSpace(bookSearchTerm) && !filteredBooks.Any(b => string.Equals(b.Name,
                                                                                                             bookSearchTerm, StringComparison.OrdinalIgnoreCase)))
                    {
                        <div style="padding: 8px;">
                            <Button Type="@ButtonType.Link" Icon="@IconType.Outline.Plus"
                                    OnClick="@(() => CreateNewBookFromSearch())" Style="width: 100%; text-align: left;">
                                åˆ›å»ºä¹¦ç›®ï¼š@bookSearchTerm
                            </Button>
                        </div>
                        <Divider Style="margin: 4px 0;"></Divider>
                    }
                    @originNode
                </div>
            </DropdownRender>
        </Select>

        @if (selectedBook != null)
        {
            <div style="margin-top: 8px;">
                <Text Type="@TextElementType.Secondary">
                    <Icon Type="check-circle" style="color: #52c41a; margin-right: 4px;"/>
                    å·²é€‰æ‹©ä¹¦ç›®ï¼š
                    <Text Strong="true">@selectedBook.Name</Text>
                </Text>
            </div>
        }
    </div>

    <div style="margin-bottom: 24px;">
        <div style="margin-bottom: 8px;">
            <Text Strong="true">é€‰æ‹©JSONLæ–‡ä»¶ï¼š</Text>
        </div>
        <div
            style="border: 2px dashed #d9d9d9; border-radius: 6px; padding: 16px; text-align: center; background: #fafafa;">
            <InputFile OnChange="@OnFileSelected" accept=".jsonl" style="display: none;" id="fileInput"/>
            <label for="fileInput" style="cursor: pointer; display: block;">
                <Icon Type="inbox" style="font-size: 48px; color: #d9d9d9;"/>
                <div style="margin-top: 8px; color: #666;">
                    ç‚¹å‡»æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤åŒºåŸŸä¸Šä¼ 
                </div>
                <div style="margin-top: 4px; color: #999; font-size: 12px;">
                    æ”¯æŒå•ä¸ª .jsonl æ–‡ä»¶ä¸Šä¼ 
                </div>
            </label>
        </div>

        @if (selectedFile != null)
        {
            <div style="margin-top: 8px;">
                <Text Type="@TextElementType.Secondary">
                    <Icon Type="file-text" style="color: #1890ff; margin-right: 4px;"/>
                    å·²é€‰æ‹©æ–‡ä»¶ï¼š
                    <Text Strong="true">@selectedFile.Name</Text>
                    <Text Type="@TextElementType.Secondary">(@FormatFileSize(selectedFile.Size))</Text>
                </Text>
            </div>
        }
    </div>

    <div style="margin-bottom: 24px;">
        <Button Type="@ButtonType.Primary" Size="@ButtonSize.Large" Loading="@isImporting"
                Disabled="@(selectedFile == null || selectedBook == null || isImporting)" OnClick="ImportFile">
            <Icon Type="upload"/>
            @if (isImporting)
            {
                <text>å¯¼å…¥ä¸­...</text>
            }
            else
            {
                <text>å¼€å§‹å¯¼å…¥</text>
            }
        </Button>

        @if (selectedFile == null || selectedBook == null)
        {
            <div style="margin-top: 8px;">
                @if (selectedBook == null)
                {
                    <div style="color: #ff4d4f; font-size: 12px;">
                        <Icon Type="exclamation-circle"/>
                        è¯·å…ˆé€‰æ‹©ä¸€ä¸ªä¹¦ç›®
                    </div>
                }
                @if (selectedFile == null)
                {
                    <div style="color: #ff4d4f; font-size: 12px;">
                        <Icon Type="exclamation-circle"/>
                        è¯·å…ˆé€‰æ‹©ä¸€ä¸ªJSONLæ–‡ä»¶
                    </div>
                }
            </div>
        }
    </div>

    @if (!string.IsNullOrEmpty(message))
    {
        <div style="margin-bottom: 24px;">
            <Alert Type="@(isSuccess ? AlertType.Success : AlertType.Error)" ShowIcon="true" Closable="true"
                   OnClose="() => { message = string.Empty; statisticsMessage = string.Empty; }">
                <MessageTemplate>
                    <div>@message</div>
                    @if (!string.IsNullOrEmpty(statisticsMessage))
                    {
                        <div style="margin-top: 12px; padding: 12px; background: rgba(0,0,0,0.02); border-radius: 4px;">
                            <pre
                                style="background: none; border: none; color: inherit; margin: 0; padding: 0; white-space: pre-line; font-family: inherit;">@statisticsMessage</pre>
                        </div>
                    }
                </MessageTemplate>
            </Alert>
        </div>
    }
</div>

@code {
    private IBrowserFile? selectedFile;
    private bool isImporting;
    private string message = string.Empty;
    private string statisticsMessage = string.Empty;
    private bool isSuccess;

    // ä¹¦ç›®ç›¸å…³
    private List<Novex.Data.Models.Book> allBooks = new();
    private List<Novex.Data.Models.Book> filteredBooks = new();
    private Novex.Data.Models.Book? selectedBook;
    private int? selectedBookId;
    private string bookSearchTerm = string.Empty;
    private bool showBookDropdown;

    protected async override Task OnInitializedAsync()
    {
        await LoadBooks();
    }

    private async Task LoadBooks()
    {
        allBooks = await BookService.GetAllBooksAsync();
        filteredBooks = allBooks;
    }

    private void OnBookSelected(Novex.Data.Models.Book book)
    {
        selectedBook = book;
        selectedBookId = book?.Id;
        StateHasChanged();
    }

    // å¤„ç†Selectç»„ä»¶çš„å€¼å˜åŒ–
    private void OnSelectedBookIdChanged(int? bookId)
    {
        selectedBookId = bookId;
        selectedBook = bookId.HasValue ? allBooks.FirstOrDefault(b => b.Id == bookId.Value) : null;
        StateHasChanged();
    }

    // å¤„ç†æœç´¢è¾“å…¥
    private void OnBookSearch(string searchValue)
    {
        bookSearchTerm = searchValue;

        if (string.IsNullOrWhiteSpace(searchValue))
        {
            filteredBooks = allBooks;
        }
        else
        {
            filteredBooks = allBooks.Where(b => b.Name.Contains(searchValue, StringComparison.OrdinalIgnoreCase)).ToList();
        }
        StateHasChanged();
    }


    // åˆ›å»ºæ–°ä¹¦ç›®
    private async Task CreateNewBook(string bookName)
    {
        if (string.IsNullOrWhiteSpace(bookName)) return;

        try
        {
            Book newBook = await BookService.CreateBookAsync(bookName);

            // é‡æ–°åŠ è½½ä¹¦ç›®åˆ—è¡¨
            await LoadBooks();

            // è‡ªåŠ¨é€‰æ‹©æ–°åˆ›å»ºçš„ä¹¦ç›®
            selectedBook = allBooks.FirstOrDefault(b => b.Name == bookName);
            selectedBookId = selectedBook?.Id;
        }
        catch (Exception ex)
        {
            message = $"åˆ›å»ºä¹¦ç›®å¤±è´¥ï¼š{ex.Message}";
            isSuccess = false;
        }
    }

    // ä»æœç´¢è¯åˆ›å»ºæ–°ä¹¦ç›®
    private async Task CreateNewBookFromSearch()
    {
        if (!string.IsNullOrWhiteSpace(bookSearchTerm))
        {
            await CreateNewBook(bookSearchTerm);
        }
    }

    // å¤„ç†ä¹¦ç›®IDå˜åŒ–
    private void OnBookIdChanged(int? bookId)
    {
        selectedBookId = bookId;
        selectedBook = bookId.HasValue ? allBooks.FirstOrDefault(b => b.Id == bookId.Value) : null;
        StateHasChanged();
    }

    private void OnFileSelected(InputFileChangeEventArgs e)
    {
        selectedFile = e.File;
        message = string.Empty;
        statisticsMessage = string.Empty;
    }


    private string FormatFileSize(long bytes)
    {
        string[] suffixes = { "B", "KB", "MB", "GB" };
        var counter = 0;
        decimal number = bytes;
        while (Math.Round(number / 1024) >= 1)
        {
            number /= 1024;
            counter++;
        }
        return string.Format("{0:n1} {1}", number, suffixes[counter]);
    }

    private async Task OnBookSearchInput(ChangeEventArgs e)
    {
        bookSearchTerm = e.Value?.ToString() ?? string.Empty;
        await FilterBooks();
        showBookDropdown = true;
        StateHasChanged();
    }

    private void OnDocumentClick()
    {
        showBookDropdown = false;
        StateHasChanged();
    }

    private Task FilterBooks()
    {
        if (string.IsNullOrWhiteSpace(bookSearchTerm))
        {
            filteredBooks = allBooks;
        }
        else
        {
            filteredBooks = allBooks.Where(b => b.Name.Contains(bookSearchTerm, StringComparison.OrdinalIgnoreCase)).ToList();
        }
        return Task.CompletedTask;
    }

    private void ShowBookDropdown()
    {
        showBookDropdown = true;
        StateHasChanged();
    }

    private void ToggleBookDropdown()
    {
        showBookDropdown = !showBookDropdown;
        StateHasChanged();
    }

    private Task SelectBook(Novex.Data.Models.Book book)
    {
        selectedBook = book;
        bookSearchTerm = book.Name;
        showBookDropdown = false;
        StateHasChanged();
        return Task.CompletedTask;
    }

    private async Task SelectNewBook(string bookName)
    {
        try
        {
            Book newBook = await BookService.CreateBookAsync(bookName.Trim());
            await LoadBooks();
            await SelectBook(newBook);
        }
        catch (Exception ex)
        {
            message = $"åˆ›å»ºä¹¦ç›®å¤±è´¥ï¼š{ex.Message}";
            isSuccess = false;
            StateHasChanged();
        }
    }

    private async Task ImportFile()
    {
        if (selectedFile == null || selectedBook == null) return;

        isImporting = true;
        message = string.Empty;
        StateHasChanged();

        try
        {
            // åˆ›å»ºä¸´æ—¶æ–‡ä»¶
            var tempPath = Path.GetTempFileName();

            await using Stream stream = selectedFile.OpenReadStream(100 * 1024 * 1024); // 100MBé™åˆ¶
            await using FileStream fileStream = File.Create(tempPath);
            await stream.CopyToAsync(fileStream);
            fileStream.Close();

            // å¯¼å…¥æ•°æ®
            ImportResult result = await ChatLogService.ImportChatLogsFromJsonlAsync(tempPath, selectedBook.Id);

            // æ¸…ç†ä¸´æ—¶æ–‡ä»¶
            File.Delete(tempPath);

            if (result.Success)
            {
                message = "èŠå¤©è®°å½•å¯¼å…¥æˆåŠŸï¼";
                statisticsMessage = $"ğŸ“Š å¯¼å…¥ç»Ÿè®¡ï¼š\n" +
                                    $"â€¢ è¯»å–è¡Œæ•°: {result.TotalLinesRead}\n" +
                                    $"â€¢ æœ‰æ•ˆè®°å½•: {result.ValidRecordsFound}\n" +
                                    $"â€¢ æˆåŠŸå¯¼å…¥: {result.ImportedRecords}";
                isSuccess = true;
            }
            else
            {
                message = $"å¯¼å…¥å¤±è´¥ï¼š{result.ErrorMessage ?? "æœªçŸ¥é”™è¯¯"}";
                statisticsMessage = $"ğŸ“Š å¤„ç†ç»Ÿè®¡ï¼š\n" +
                                    $"â€¢ è¯»å–è¡Œæ•°: {result.TotalLinesRead}\n" +
                                    $"â€¢ æœ‰æ•ˆè®°å½•: {result.ValidRecordsFound}\n" +
                                    $"â€¢ æˆåŠŸå¯¼å…¥: {result.ImportedRecords}";
                isSuccess = false;
            }
        }
        catch (Exception ex)
        {
            message = $"å¯¼å…¥è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯ï¼š{ex.Message}";
            isSuccess = false;
        }
        finally
        {
            isImporting = false;
            StateHasChanged();
        }
    }

}