@page "/import"
@using Novex.Data.Services
@using Microsoft.AspNetCore.Components.Forms
@inject IChatLogService ChatLogService
@inject IBookService BookService
@inject IJSRuntime JSRuntime

<PageTitle>å¯¼å…¥èŠå¤©è®°å½•</PageTitle>

<h3>å¯¼å…¥ SillyTavern èŠå¤©è®°å½•</h3>

<div class="mb-3">
    <div class="alert alert-info">
        <h5>ä½¿ç”¨è¯´æ˜ï¼š</h5>
        <ul>
            <li>é€‰æ‹© SillyTavern å¯¼å‡ºçš„ JSONL æ–‡ä»¶</li>
            <li>æ–‡ä»¶ä¸­æ¯è¡Œåº”è¯¥æ˜¯ä¸€ä¸ª JSON å¯¹è±¡ï¼ŒåŒ…å« nameã€mesã€send_date å­—æ®µ</li>
            <li>åªæœ‰åŒ…å« name å­—æ®µçš„è®°å½•ä¼šè¢«å¯¼å…¥</li>
            <li>å¯¼å…¥ä¼šæ›¿æ¢ç°æœ‰çš„æ‰€æœ‰èŠå¤©è®°å½•</li>
        </ul>
    </div>
</div>

<div class="mb-3">
    <label class="form-label">é€‰æ‹©ä¹¦ç›®ï¼š</label>
    <div class="input-group">
        <input type="text" class="form-control" placeholder="æœç´¢æˆ–è¾“å…¥æ–°ä¹¦ç›®åç§°..."
               @bind="bookSearchTerm" @oninput="OnBookSearchInput" @onfocus="ShowBookDropdown" />
        <button type="button" class="btn btn-outline-secondary dropdown-toggle"
                @onclick="ToggleBookDropdown" disabled="@isImporting"></button>
    </div>

    @if (showBookDropdown)
    {
        <div class="dropdown-menu show w-100" style="max-height: 200px; overflow-y: auto;">
            @if (filteredBooks.Any())
            {
                @foreach (var book in filteredBooks)
                {
                    <a href="#" class="dropdown-item" @onclick="() => SelectBook(book)" @onclick:preventDefault="true">
                        @book.Name
                    </a>
                }
            }

            @if (!string.IsNullOrWhiteSpace(bookSearchTerm) && !filteredBooks.Any(b => b.Name.Equals(bookSearchTerm, StringComparison.OrdinalIgnoreCase)))
            {
                <a href="#" class="dropdown-item text-primary" @onclick="() => SelectNewBook(bookSearchTerm)" @onclick:preventDefault="true">
                    <i class="oi oi-plus"></i> åˆ›å»ºæ–°ä¹¦ç›®ï¼š@bookSearchTerm
                </a>
            }

            @if (!filteredBooks.Any() && string.IsNullOrWhiteSpace(bookSearchTerm))
            {
                <div class="dropdown-item-text text-muted">æš‚æ— ä¹¦ç›®</div>
            }
        </div>
    }

    @if (selectedBook != null)
    {
        <div class="mt-2">
            <small class="text-success">å·²é€‰æ‹©ä¹¦ç›®ï¼š<strong>@selectedBook.Name</strong></small>
        </div>
    }
</div>

<div class="mb-3">
    <label class="form-label">é€‰æ‹©JSONLæ–‡ä»¶ï¼š</label>
    <InputFile OnChange="@OnFileSelected" class="form-control" accept=".jsonl" />
</div>

<div class="mb-3">
    <button class="btn btn-primary" @onclick="ImportFile" disabled="@(selectedFile == null || selectedBook == null || isImporting)">
        @if (isImporting)
        {
            <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
            <text> å¯¼å…¥ä¸­...</text>
        }
        else
        {
            <text>å¼€å§‹å¯¼å…¥</text>
        }
    </button>

    @if (selectedFile == null || selectedBook == null)
    {
        <div class="form-text text-muted">
            @if (selectedBook == null) { <div>è¯·å…ˆé€‰æ‹©ä¸€ä¸ªä¹¦ç›®</div> }
            @if (selectedFile == null) { <div>è¯·å…ˆé€‰æ‹©ä¸€ä¸ªJSONLæ–‡ä»¶</div> }
        </div>
    }
</div>

@if (!string.IsNullOrEmpty(message))
{
    <div class="alert @(isSuccess ? "alert-success" : "alert-danger")">
        <div>@message</div>
        @if (!string.IsNullOrEmpty(statisticsMessage))
        {
            <div class="mt-2">
                <pre style="background: none; border: none; color: inherit; margin: 0; padding: 0; white-space: pre-line;">@statisticsMessage</pre>
            </div>
        }
    </div>
}

@code {
    private IBrowserFile? selectedFile;
    private bool isImporting = false;
    private string message = string.Empty;
    private string statisticsMessage = string.Empty;
    private bool isSuccess = false;

    // ä¹¦ç›®ç›¸å…³
    private List<Novex.Data.Models.Book> allBooks = new();
    private List<Novex.Data.Models.Book> filteredBooks = new();
    private Novex.Data.Models.Book? selectedBook;
    private string bookSearchTerm = string.Empty;
    private bool showBookDropdown = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadBooks();
    }

    private async Task LoadBooks()
    {
        allBooks = await BookService.GetAllBooksAsync();
        filteredBooks = allBooks;
    }

    private void OnFileSelected(InputFileChangeEventArgs e)
    {
        selectedFile = e.File;
        message = string.Empty;
        statisticsMessage = string.Empty;
    }

    private async Task OnBookSearchInput(ChangeEventArgs e)
    {
        bookSearchTerm = e.Value?.ToString() ?? string.Empty;
        await FilterBooks();
        showBookDropdown = true;
        StateHasChanged();
    }

    private void OnDocumentClick()
    {
        showBookDropdown = false;
        StateHasChanged();
    }

    private Task FilterBooks()
    {
        if (string.IsNullOrWhiteSpace(bookSearchTerm))
        {
            filteredBooks = allBooks;
        }
        else
        {
            filteredBooks = allBooks.Where(b => b.Name.Contains(bookSearchTerm, StringComparison.OrdinalIgnoreCase)).ToList();
        }
        return Task.CompletedTask;
    }

    private void ShowBookDropdown()
    {
        showBookDropdown = true;
        StateHasChanged();
    }

    private void ToggleBookDropdown()
    {
        showBookDropdown = !showBookDropdown;
        StateHasChanged();
    }

    private Task SelectBook(Novex.Data.Models.Book book)
    {
        selectedBook = book;
        bookSearchTerm = book.Name;
        showBookDropdown = false;
        StateHasChanged();
        return Task.CompletedTask;
    }

    private async Task SelectNewBook(string bookName)
    {
        try
        {
            var newBook = await BookService.CreateBookAsync(bookName.Trim());
            await LoadBooks();
            await SelectBook(newBook);
        }
        catch (Exception ex)
        {
            message = $"åˆ›å»ºä¹¦ç›®å¤±è´¥ï¼š{ex.Message}";
            isSuccess = false;
            StateHasChanged();
        }
    }

    private async Task ImportFile()
    {
        if (selectedFile == null || selectedBook == null) return;

        isImporting = true;
        message = string.Empty;
        StateHasChanged();

        try
        {
            // åˆ›å»ºä¸´æ—¶æ–‡ä»¶
            var tempPath = Path.GetTempFileName();

            await using var stream = selectedFile.OpenReadStream(maxAllowedSize: 100 * 1024 * 1024); // 100MBé™åˆ¶
            await using var fileStream = File.Create(tempPath);
            await stream.CopyToAsync(fileStream);
            fileStream.Close();

            // å¯¼å…¥æ•°æ®
            var result = await ChatLogService.ImportChatLogsFromJsonlAsync(tempPath, selectedBook.Id);

            // æ¸…ç†ä¸´æ—¶æ–‡ä»¶
            File.Delete(tempPath);

            if (result.Success)
            {
                message = "èŠå¤©è®°å½•å¯¼å…¥æˆåŠŸï¼";
                statisticsMessage = $"ğŸ“Š å¯¼å…¥ç»Ÿè®¡ï¼š\n" +
                                   $"â€¢ è¯»å–è¡Œæ•°: {result.TotalLinesRead}\n" +
                                   $"â€¢ æœ‰æ•ˆè®°å½•: {result.ValidRecordsFound}\n" +
                                   $"â€¢ æˆåŠŸå¯¼å…¥: {result.ImportedRecords}";
                isSuccess = true;
            }
            else
            {
                message = $"å¯¼å…¥å¤±è´¥ï¼š{result.ErrorMessage ?? "æœªçŸ¥é”™è¯¯"}";
                statisticsMessage = $"ğŸ“Š å¤„ç†ç»Ÿè®¡ï¼š\n" +
                                   $"â€¢ è¯»å–è¡Œæ•°: {result.TotalLinesRead}\n" +
                                   $"â€¢ æœ‰æ•ˆè®°å½•: {result.ValidRecordsFound}\n" +
                                   $"â€¢ æˆåŠŸå¯¼å…¥: {result.ImportedRecords}";
                isSuccess = false;
            }
        }
        catch (Exception ex)
        {
            message = $"å¯¼å…¥è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯ï¼š{ex.Message}";
            isSuccess = false;
        }
        finally
        {
            isImporting = false;
            StateHasChanged();
        }
    }
}