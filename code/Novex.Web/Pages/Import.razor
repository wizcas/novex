@page "/import"
@using Novex.Data.Services
@using Microsoft.AspNetCore.Components.Forms
@inject IChatLogService ChatLogService
@inject IJSRuntime JSRuntime

<PageTitle>å¯¼å…¥èŠå¤©è®°å½•</PageTitle>

<h3>å¯¼å…¥ SillyTavern èŠå¤©è®°å½•</h3>

<div class="mb-3">
    <div class="alert alert-info">
        <h5>ä½¿ç”¨è¯´æ˜ï¼š</h5>
        <ul>
            <li>é€‰æ‹© SillyTavern å¯¼å‡ºçš„ JSONL æ–‡ä»¶</li>
            <li>æ–‡ä»¶ä¸­æ¯è¡Œåº”è¯¥æ˜¯ä¸€ä¸ª JSON å¯¹è±¡ï¼ŒåŒ…å« nameã€mesã€send_date å­—æ®µ</li>
            <li>åªæœ‰åŒ…å« name å­—æ®µçš„è®°å½•ä¼šè¢«å¯¼å…¥</li>
            <li>å¯¼å…¥ä¼šæ›¿æ¢ç°æœ‰çš„æ‰€æœ‰èŠå¤©è®°å½•</li>
        </ul>
    </div>
</div>

<div class="mb-3">
    <InputFile OnChange="@OnFileSelected" class="form-control" accept=".jsonl" />
</div>

<div class="mb-3">
    <button class="btn btn-primary" @onclick="ImportFile" disabled="@(selectedFile == null || isImporting)">
        @if (isImporting)
        {
            <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
            <text> å¯¼å…¥ä¸­...</text>
        }
        else
        {
            <text>å¼€å§‹å¯¼å…¥</text>
        }
    </button>
</div>

@if (!string.IsNullOrEmpty(message))
{
    <div class="alert @(isSuccess ? "alert-success" : "alert-danger")">
        <div>@message</div>
        @if (!string.IsNullOrEmpty(statisticsMessage))
        {
            <div class="mt-2">
                <pre style="background: none; border: none; color: inherit; margin: 0; padding: 0; white-space: pre-line;">@statisticsMessage</pre>
            </div>
        }
    </div>
}

@code {
    private IBrowserFile? selectedFile;
    private bool isImporting = false;
    private string message = string.Empty;
    private string statisticsMessage = string.Empty;
    private bool isSuccess = false;

    private void OnFileSelected(InputFileChangeEventArgs e)
    {
        selectedFile = e.File;
        message = string.Empty;
        statisticsMessage = string.Empty;
    }

    private async Task ImportFile()
    {
        if (selectedFile == null) return;

        isImporting = true;
        message = string.Empty;
        StateHasChanged();

        try
        {
            // åˆ›å»ºä¸´æ—¶æ–‡ä»¶
            var tempPath = Path.GetTempFileName();
            
            await using var stream = selectedFile.OpenReadStream(maxAllowedSize: 100 * 1024 * 1024); // 100MBé™åˆ¶
            await using var fileStream = File.Create(tempPath);
            await stream.CopyToAsync(fileStream);
            fileStream.Close();

            // å¯¼å…¥æ•°æ®
            var result = await ChatLogService.ImportChatLogsFromJsonlAsync(tempPath);
            
            // æ¸…ç†ä¸´æ—¶æ–‡ä»¶
            File.Delete(tempPath);

            if (result.Success)
            {
                message = "èŠå¤©è®°å½•å¯¼å…¥æˆåŠŸï¼";
                statisticsMessage = $"ğŸ“Š å¯¼å…¥ç»Ÿè®¡ï¼š\n" +
                                   $"â€¢ è¯»å–è¡Œæ•°: {result.TotalLinesRead}\n" +
                                   $"â€¢ æœ‰æ•ˆè®°å½•: {result.ValidRecordsFound}\n" +
                                   $"â€¢ æˆåŠŸå¯¼å…¥: {result.ImportedRecords}";
                isSuccess = true;
            }
            else
            {
                message = $"å¯¼å…¥å¤±è´¥ï¼š{result.ErrorMessage ?? "æœªçŸ¥é”™è¯¯"}";
                statisticsMessage = $"ğŸ“Š å¤„ç†ç»Ÿè®¡ï¼š\n" +
                                   $"â€¢ è¯»å–è¡Œæ•°: {result.TotalLinesRead}\n" +
                                   $"â€¢ æœ‰æ•ˆè®°å½•: {result.ValidRecordsFound}\n" +
                                   $"â€¢ æˆåŠŸå¯¼å…¥: {result.ImportedRecords}";
                isSuccess = false;
            }
        }
        catch (Exception ex)
        {
            message = $"å¯¼å…¥è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯ï¼š{ex.Message}";
            isSuccess = false;
        }
        finally
        {
            isImporting = false;
            StateHasChanged();
        }
    }
}