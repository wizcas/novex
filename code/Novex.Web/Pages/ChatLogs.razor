@page "/chatlogs/{bookId:int}"
@page "/chatlogs/{bookId:int}/{page:int?}"
@using Novex.Data.Services
@inject IChatLogService ChatLogService
@inject IBookService BookService
@inject NavigationManager Navigation

<PageTitle>聊天记录</PageTitle>

<div class="d-flex justify-content-between align-items-center mb-3">
  <div>
    <h3>聊天记录列表</h3>
    @if (currentBook != null)
    {
      <p class="text-muted mb-0">书目：<strong>@currentBook.Name</strong></p>
    }
  </div>
  <div>
    <a href="/books" class="btn btn-outline-secondary">返回书目管理</a>
  </div>
</div>

<style>
  .chat-preview {
    font-size: 0.85em;
    line-height: 1.3;
  }
  
  .chat-name {
    color: #007bff;
    font-weight: 600;
  }
  
  .chat-date {
    color: #6c757d;
    font-weight: 500;
  }
  
  .chat-message {
    color: #495057;
  }
  
  .character-row {
    transition: background-color 0.2s ease;
  }
  
  .character-row:hover {
    background-color: rgba(0, 0, 0, 0.05) !important;
  }
</style>

<div class="row mb-3">
  <div class="col-md-6">
    <div class="input-group">
      <input type="text" class="form-control" placeholder="按角色名筛选..." @bind="nameFilter" @onkeypress="@OnKeyPress" />
      <button class="btn btn-outline-secondary" @onclick="SearchByName">搜索</button>
      <button class="btn btn-outline-secondary" @onclick="ClearFilter">清除</button>
    </div>
  </div>
  <div class="col-md-6 text-end">
    <span class="text-muted">共 @totalCount 条记录</span>
  </div>
</div>

@if (isLoading)
{
  <div class="text-center">
    <div class="spinner-border" role="status">
      <span class="visually-hidden">加载中...</span>
    </div>
  </div>
}
else if (chatLogs.Any())
{
  <div class="table-responsive">
    <table class="table table-striped table-hover">
      <thead>
        <tr>
          <th>ID</th>
          <th>角色名</th>
          <th>发送时间</th>
          <th>预览</th>
          <th>操作</th>
        </tr>
      </thead>
      <tbody>
        @foreach (var log in chatLogs)
        {
          <tr class="character-row" style="background-color: @GetCharacterBackgroundColor(log.Name);">
            <td>@log.Id</td>
            <td><strong>@log.Name</strong></td>
            <td>@log.SendDate.ToString("yyyy-MM-dd HH:mm:ss")</td>
            <td class="text-truncate chat-preview" style="max-width: 300px;">
              @((MarkupString)FormatPreview(log.Name, log.SendDate, log.Preview))
            </td>
            <td>
              <button class="btn btn-sm btn-primary" @onclick="() => ViewDetail(log.Id)">
                查看详情
              </button>
            </td>
          </tr>
        }
      </tbody>
    </table>
  </div>

  <!-- 分页控件 -->
  <nav aria-label="分页导航">
    <ul class="pagination justify-content-center">
      <li class="page-item @(currentPage <= 1 ? "disabled" : "")">
        <button class="page-link" @onclick="() => GoToPage(currentPage - 1)" disabled="@(currentPage <= 1)">
          上一页
        </button>
      </li>

      @for (int i = Math.Max(1, currentPage - 2); i <= Math.Min(totalPages, currentPage + 2); i++)
      {
        <li class="page-item @(i == currentPage ? "active" : "")">
          <button class="page-link" @onclick="() => GoToPage(i)">@i</button>
        </li>
      }

      <li class="page-item @(currentPage >= totalPages ? "disabled" : "")">
        <button class="page-link" @onclick="() => GoToPage(currentPage + 1)" disabled="@(currentPage >= totalPages)">
          下一页
        </button>
      </li>
    </ul>
  </nav>
}
else
{
  <div class="alert alert-info">
    <h5>暂无聊天记录</h5>
    <p>请先<a href="/import">导入聊天记录</a>。</p>
  </div>
}

<!-- 详情模态框 -->
@if (selectedChatLog != null)
{
  <div class="modal fade show" style="display: block;" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">聊天记录详情 - ID: @selectedChatLog.Id</h5>
          <button type="button" class="btn-close" @onclick="CloseDetail"></button>
        </div>
        <div class="modal-body">
          <div class="row mb-3">
            <div class="col-sm-3"><strong>角色名:</strong></div>
            <div class="col-sm-9">@selectedChatLog.Name</div>
          </div>
          <div class="row mb-3">
            <div class="col-sm-3"><strong>发送时间:</strong></div>
            <div class="col-sm-9">@selectedChatLog.SendDate.ToString("yyyy-MM-dd HH:mm:ss")</div>
          </div>
          <div class="row">
            <div class="col-sm-3"><strong>内容:</strong></div>
            <div class="col-sm-9">
              <div class="border p-3" style="max-height: 400px; overflow-y: auto; white-space: pre-wrap;">
                @selectedChatLog.Mes</div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <div class="me-auto">
            <button type="button" class="btn btn-outline-secondary me-2" @onclick="GoToPreviousRecord" disabled="@isNavigating">
              <i class="oi oi-chevron-left"></i> 上一条
            </button>
            <button type="button" class="btn btn-outline-secondary" @onclick="GoToNextRecord" disabled="@isNavigating">
              下一条 <i class="oi oi-chevron-right"></i>
            </button>
          </div>
          <button type="button" class="btn btn-secondary" @onclick="CloseDetail">关闭</button>
        </div>
      </div>
    </div>
  </div>
  <div class="modal-backdrop fade show"></div>
}

@code {
  [Parameter] public int BookId { get; set; }
  [Parameter] public int? Page { get; set; }

  private List<ChatLogSummary> chatLogs = new();
  private bool isLoading = false;
  private bool isNavigating = false;
  private int currentPage = 1;
  private int totalCount = 0;
  private int totalPages = 0;
  private const int pageSize = 50;
  private string nameFilter = string.Empty;
  private string currentNameFilter = string.Empty;
  private Novex.Data.Models.ChatLog? selectedChatLog;
  private Novex.Data.Models.Book? currentBook;
  private readonly Dictionary<string, string> characterColors = new();
  private readonly string[] backgroundColors = new[]
  {
    "#f8f9fa", "#e3f2fd", "#f3e5f5", "#e8f5e8", "#fff3e0",
    "#fce4ec", "#e0f2f1", "#f1f8e9", "#fff8e1", "#fafafa"
  };

  protected override async Task OnInitializedAsync()
  {
    currentPage = Page ?? 1;
    currentBook = await BookService.GetBookByIdAsync(BookId);
    await LoadChatLogs();
  }

  protected override async Task OnParametersSetAsync()
  {
    if (Page.HasValue && Page != currentPage)
    {
      currentPage = Page.Value;
      await LoadChatLogs();
    }
  }

  private async Task LoadChatLogs()
  {
    isLoading = true;
    StateHasChanged();

    try
    {
      if (string.IsNullOrWhiteSpace(currentNameFilter))
      {
        chatLogs = await ChatLogService.GetAllChatLogsAsync(BookId, currentPage, pageSize);
        totalCount = await ChatLogService.GetTotalCountAsync(BookId);
      }
      else
      {
        chatLogs = await ChatLogService.GetChatLogsByNameAsync(currentNameFilter, BookId, currentPage, pageSize);
        totalCount = await ChatLogService.GetTotalCountByNameAsync(currentNameFilter, BookId);
      }

      totalPages = (int)Math.Ceiling((double)totalCount / pageSize);
    }
    finally
    {
      isLoading = false;
      StateHasChanged();
    }
  }

  private async Task SearchByName()
  {
    currentNameFilter = nameFilter;
    currentPage = 1;
    Navigation.NavigateTo($"/chatlogs/{BookId}");
    await LoadChatLogs();
  }

  private async Task ClearFilter()
  {
    nameFilter = string.Empty;
    currentNameFilter = string.Empty;
    currentPage = 1;
    Navigation.NavigateTo($"/chatlogs/{BookId}");
    await LoadChatLogs();
  }

  private async Task OnKeyPress(KeyboardEventArgs e)
  {
    if (e.Key == "Enter")
    {
      await SearchByName();
    }
  }

  private void GoToPage(int page)
  {
    if (page >= 1 && page <= totalPages)
    {
      Navigation.NavigateTo($"/chatlogs/{BookId}/{page}");
    }
  }

  private async Task ViewDetail(int id)
  {
    selectedChatLog = await ChatLogService.GetChatLogByIdAsync(id);
    StateHasChanged();
  }

  private void CloseDetail()
  {
    selectedChatLog = null;
    StateHasChanged();
  }

  private async Task GoToPreviousRecord()
  {
    if (selectedChatLog == null || isNavigating) return;

    isNavigating = true;
    StateHasChanged();

    try
    {
      var previousId = await ChatLogService.GetPreviousChatLogIdAsync(selectedChatLog.Id);
      if (previousId.HasValue)
      {
        selectedChatLog = await ChatLogService.GetChatLogByIdAsync(previousId.Value);
      }
    }
    finally
    {
      isNavigating = false;
      StateHasChanged();
    }
  }

  private async Task GoToNextRecord()
  {
    if (selectedChatLog == null || isNavigating) return;

    isNavigating = true;
    StateHasChanged();

    try
    {
      var nextId = await ChatLogService.GetNextChatLogIdAsync(selectedChatLog.Id);
      if (nextId.HasValue)
      {
        selectedChatLog = await ChatLogService.GetChatLogByIdAsync(nextId.Value);
      }
    }
    finally
    {
      isNavigating = false;
      StateHasChanged();
    }
  }

  private string GetCharacterBackgroundColor(string characterName)
  {
    if (!characterColors.ContainsKey(characterName))
    {
      var index = characterColors.Count % backgroundColors.Length;
      characterColors[characterName] = backgroundColors[index];
    }
    return characterColors[characterName];
  }

  private string FormatPreview(string name, DateTime sendDate, string preview)
  {
    // 提取预览中的消息部分（去掉角色名和时间）
    var expectedPrefix = $"{name} {sendDate:yyyy-MM-dd HH:mm} ";
    var message = preview.StartsWith(expectedPrefix) ? preview[expectedPrefix.Length..] : preview;
    
    return $"<span class='chat-name'>{name}</span> " +
           $"<span class='chat-date'>{sendDate:yyyy-MM-dd HH:mm}</span> " +
           $"<span class='chat-message'>{message}</span>";
  }
}