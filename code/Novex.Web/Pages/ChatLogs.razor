@page "/chatlogs/{bookId:int}"
@page "/chatlogs/{bookId:int}/{page:int?}"
@using Novex.Data.Services
@inject IChatLogService ChatLogService
@inject IBookService BookService
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime
@implements IAsyncDisposable

<PageTitle>聊天记录</PageTitle>

<style>
  .chat-name {
    color: #1890ff;
    font-weight: 600;
  }

  .chat-date {
    color: #6c757d;
    font-weight: 500;
  }

  .chat-message {
    color: #495057;
  }

  /* 角色行背景色 */
  .character-row {
    transition: background-color 0.3s ease;
  }

  .character-row:hover {
    background-color: rgba(24, 144, 255, 0.1) !important;
  }
</style>

<div class="chatlogs-page">
  <div style="margin-bottom: 24px;">
    <Row Justify="@RowJustify.SpaceBetween" Align="@RowAlign.Middle">
      <AntDesign.Col>
        <Title Level="2">
          <Icon Type="message" style="margin-right: 8px; color: #1890ff;" />
          聊天记录列表
        </Title>
        @if (currentBook != null)
        {
          <div>
            <Text Type="@TextElementType.Secondary">书目：</Text>
            <Text Strong="true">@currentBook.Name</Text>
          </div>
        }
      </AntDesign.Col>
      <AntDesign.Col>
        <Button Type="@ButtonType.Default" Icon="@IconType.Outline.ArrowLeft"
          OnClick="@(() => Navigation.NavigateTo("/books"))">
          返回书目管理
        </Button>
      </AntDesign.Col>
    </Row>
  </div>

  <div style="margin-bottom: 24px;">
    <Row Gutter="16" Style="margin-bottom: 16px;">
      <AntDesign.Col Span="24">
        <Card Title="查询选项" Size="@CardSize.Small">
          <Tabs DefaultActiveKey="1">
            <TabPane Key="1" Tab="按角色筛选">
              <Space>
                <SpaceItem>
                  <Input @bind-Value="nameFilter" Placeholder="按角色名筛选..." OnPressEnter="@OnKeyPress"
                    Size="@InputSize.Large" Style="width: 300px;">
                  <Prefix>
                    <Icon Type="search" />
                  </Prefix>
                  </Input>
                </SpaceItem>
                <SpaceItem>
                  <Button Type="@ButtonType.Primary" Icon="@IconType.Outline.Search" OnClick="SearchByName"
                    Size="@ButtonSize.Large">
                    搜索
                  </Button>
                </SpaceItem>
                <SpaceItem>
                  <Button Type="@ButtonType.Default" Icon="@IconType.Outline.Clear" OnClick="ClearFilter"
                    Size="@ButtonSize.Large">
                    清除
                  </Button>
                </SpaceItem>
              </Space>
            </TabPane>
            <TabPane Key="2" Tab="按楼层范围">
              <Space>
                <SpaceItem>
                  <Text>楼层范围：</Text>
                </SpaceItem>
                <SpaceItem>
                  <AntDesign.InputNumber @bind-Value="startIndex" Placeholder="起始楼层" Min="@minIndex" Max="@maxIndex"
                    Style="width: 120px;" />
                </SpaceItem>
                <SpaceItem>
                  <Text>-</Text>
                </SpaceItem>
                <SpaceItem>
                  <AntDesign.InputNumber @bind-Value="endIndex" Placeholder="结束楼层" Min="@minIndex" Max="@maxIndex"
                    Style="width: 120px;" />
                </SpaceItem>
                <SpaceItem>
                  <Button Type="@ButtonType.Primary" Icon="@IconType.Outline.Search" OnClick="SearchByIndexRange"
                    Size="@ButtonSize.Large">
                    查询
                  </Button>
                </SpaceItem>
                <SpaceItem>
                  <Button Type="@ButtonType.Default" Icon="@IconType.Outline.Clear" OnClick="ClearFilter"
                    Size="@ButtonSize.Large">
                    清除
                  </Button>
                </SpaceItem>
              </Space>
              @if (minIndex > 0 || maxIndex > 0)
              {
                <div style="margin-top: 8px;">
                  <Text Type="@TextElementType.Secondary" Style="font-size: 12px;">
                    可用楼层范围：@minIndex - @maxIndex
                  </Text>
                </div>
              }
            </TabPane>
          </Tabs>
        </Card>
      </AntDesign.Col>
    </Row>
    <Row Gutter="16">
      <AntDesign.Col Span="24" Style="text-align: right; line-height: 40px;">
        <Text Type="@TextElementType.Secondary">
          共 <Text Strong="true" style="color: #1890ff;">@totalCount</Text> 条记录
        </Text>
      </AntDesign.Col>
    </Row>
  </div>

  @if (isLoading)
  {
    <div style="text-align: center; padding: 48px;">
      <Spin Size="@SpinSize.Large" />
      <div style="margin-top: 16px;">
        <Text Type="@TextElementType.Secondary">加载中...</Text>
      </div>
    </div>
  }
  else if (chatLogs.Any())
  {
    <div style="overflow-x: auto;">
      <Table TItem="ChatLogSummary" DataSource="@chatLogs" Size="@TableSize.Middle" Bordered="true" ScrollX="900">
        <Column TData="ChatLogSummary" Title="楼层" Width="40px">
          <Template>
            <Tag Color="@("blue")">@context.Index</Tag>
          </Template>
        </Column>
        <Column TData="ChatLogSummary" Title="角色名" Width="150px">
          <Template>
            <Text Strong="true"
              Style="@($"color: {GetCharacterColor(context.Name)}; background-color: {GetCharacterBackgroundColor(context.Name)}")">@context.Name</Text>
          </Template>
        </Column>
        <Column TData="ChatLogSummary" Title="发送时间" Width="80px">
          <Template>
            @context.SendDate.ToString("yyyy-MM-dd HH:mm:ss")
          </Template>
        </Column>
        <Column TData="ChatLogSummary" Title="预览" Width="400px">
          <Template>
            <div style="max-width: 400px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
              @((MarkupString)FormatPreview(context.Name, context.SendDate, context.Preview))
            </div>
          </Template>
        </Column>
        <ActionColumn Title="操作" Width="120px" Fixed="@ColumnFixPlacement.Right">
          <Template>
            <Button Type="@ButtonType.Primary" Size="@ButtonSize.Small" Icon="@IconType.Outline.Eye"
              OnClick="@(() => ViewDetail(context.Id))">
              查看详情
            </Button>
          </Template>
        </ActionColumn>
      </Table>
    </div>

    <!-- 分页控件 -->
    <div style="text-align: center; margin-top: 24px;">
      <Pagination Current="@currentPage" Total="@totalCount" PageSize="@pageSize" OnChange="@OnPageChange"
        ShowSizeChanger="false" ShowQuickJumper="true" />
    </div>
  }
  else
  {
    <Empty>
      <DescriptionTemplate>
        <Text Type="@TextElementType.Secondary">暂无聊天记录</Text>
        <br />
        <Text Type="@TextElementType.Secondary">请先导入聊天记录。</Text>
      </DescriptionTemplate>
      <ChildContent>
        <Button Type="@ButtonType.Primary" Icon="@IconType.Outline.Import"
          OnClick="@(() => Navigation.NavigateTo("/import"))">
          导入聊天记录
        </Button>
      </ChildContent>
    </Empty>
  }

  <!-- 详情模态框 -->
  @if (selectedChatLog != null)
  {
    RenderFragment detailFooter = @<Template>
      <div style="display: flex; justify-content: space-between; width: 100%;">
        <div>
          <Button Icon="@IconType.Outline.Left" OnClick="GoToPreviousRecord"
            Disabled="@(isNavigating || !hasPreviousRecord)" Loading="@isNavigating" @key="@("prev")">
            上一条
          </Button>
          <Button Icon="@IconType.Outline.Right" OnClick="GoToNextRecord" Disabled="@(isNavigating || !hasNextRecord)"
            Loading="@isNavigating" Style="margin-left: 8px;" @key="@("next")">
            下一条
          </Button>
        </div>
        <Button OnClick="CloseDetail" @key="@("close")">关闭</Button>
      </div>
    </Template>;

    <Modal Title="@($"聊天记录详情 - ID: {selectedChatLog.Id}")" Visible="true" OnCancel="CloseDetail" Footer="@detailFooter"
      Width="800" Keyboard="true">
      <div>
        <Alert Type="@AlertType.Info" Message="键盘操作提示" Description="使用左右方向键切换上一条/下一条记录，ESC键关闭详情窗口。" ShowIcon="true"
          Style="margin-bottom: 16px;" />
        <Row Style="margin-bottom: 16px;">
          <AntDesign.Col Span="4">
            <Text Strong="true">角色名:</Text>
          </AntDesign.Col>
          <AntDesign.Col Span="20">
            <Text>@selectedChatLog.Name</Text>
          </AntDesign.Col>
        </Row>
        <Row Style="margin-bottom: 16px;">
          <AntDesign.Col Span="4">
            <Text Strong="true">发送时间:</Text>
          </AntDesign.Col>
          <AntDesign.Col Span="20">
            <Text>@selectedChatLog.SendDate.ToString("yyyy-MM-dd HH:mm:ss")</Text>
          </AntDesign.Col>
        </Row>
        <Row>
          <AntDesign.Col Span="4">
            <Text Strong="true">内容:</Text>
          </AntDesign.Col>
          <AntDesign.Col Span="20">
            <div
              style="border: 1px solid #d9d9d9; padding: 12px; border-radius: 6px; background: #fafafa; max-height: 400px; overflow-y: auto; white-space: pre-wrap; font-family: monospace;">
              @selectedChatLog.Mes
            </div>
          </AntDesign.Col>
        </Row>
      </div>
    </Modal>
  }
</div>

@code {
  [Parameter] public int BookId { get; set; }
  [Parameter] public int? Page { get; set; }

  private List<ChatLogSummary> chatLogs = new();
  private bool isLoading = false;
  private bool isNavigating = false;
  private int currentPage = 1;
  private int totalCount = 0;
  private int totalPages = 0;
  private const int pageSize = 50;
  private string nameFilter = string.Empty;
  private string currentNameFilter = string.Empty;
  private Novex.Data.Models.ChatLog? selectedChatLog;
  private Novex.Data.Models.Book? currentBook;
  private IJSObjectReference? jsModule;
  private DotNetObjectReference<ChatLogs>? objRef;
  private bool hasPreviousRecord = false;
  private bool hasNextRecord = false;
  private int? startIndex = null;
  private int? endIndex = null;
  private int minIndex = 0;
  private int maxIndex = 0;
  private bool isIndexRangeQuery = false;
  private readonly Dictionary<string, string> characterColors = new();
  private readonly string[] backgroundColors = new[]
  {
"#f8f9fa", "#e3f2fd", "#f3e5f5", "#e8f5e8", "#fff3e0",
"#fce4ec", "#e0f2f1", "#f1f8e9", "#fff8e1", "#fafafa"
};

  protected override async Task OnInitializedAsync()
  {
    currentPage = Page ?? 1;
    currentBook = await BookService.GetBookByIdAsync(BookId);

    // 获取Index范围
    var range = await ChatLogService.GetIndexRangeAsync(BookId);
    minIndex = range.MinIndex;
    maxIndex = range.MaxIndex;

    await LoadChatLogs();
  }

  protected override async Task OnParametersSetAsync()
  {
    if (Page.HasValue && Page != currentPage)
    {
      currentPage = Page.Value;
      await LoadChatLogs();
    }
  }

  private async Task LoadChatLogs()
  {
    isLoading = true;
    StateHasChanged();

    try
    {
      if (isIndexRangeQuery && startIndex.HasValue && endIndex.HasValue)
      {
        // 按Index范围查询
        chatLogs = await ChatLogService.GetChatLogsByIndexRangeAsync(BookId, startIndex.Value, endIndex.Value);
        totalCount = chatLogs.Count;
        totalPages = 1; // Index范围查询不分页
      }
      else if (string.IsNullOrWhiteSpace(currentNameFilter))
      {
        chatLogs = await ChatLogService.GetAllChatLogsAsync(BookId, currentPage, pageSize);
        totalCount = await ChatLogService.GetTotalCountAsync(BookId);
        totalPages = (int)Math.Ceiling((double)totalCount / pageSize);
      }
      else
      {
        chatLogs = await ChatLogService.GetChatLogsByNameAsync(currentNameFilter, BookId, currentPage, pageSize);
        totalCount = await ChatLogService.GetTotalCountByNameAsync(currentNameFilter, BookId);
        totalPages = (int)Math.Ceiling((double)totalCount / pageSize);
      }
    }
    finally
    {
      isLoading = false;
      StateHasChanged();
    }
  }

  private async Task SearchByName()
  {
    currentNameFilter = nameFilter;
    currentPage = 1;
    Navigation.NavigateTo($"/chatlogs/{BookId}");
    await LoadChatLogs();
  }

  private async Task ClearFilter()
  {
    nameFilter = string.Empty;
    currentNameFilter = string.Empty;
    startIndex = null;
    endIndex = null;
    isIndexRangeQuery = false;
    currentPage = 1;
    Navigation.NavigateTo($"/chatlogs/{BookId}");
    await LoadChatLogs();
  }

  private async Task SearchByIndexRange()
  {
    if (startIndex.HasValue && endIndex.HasValue && startIndex <= endIndex)
    {
      isIndexRangeQuery = true;
      currentNameFilter = string.Empty;
      nameFilter = string.Empty;
      await LoadChatLogs();
    }
  }

  private async Task OnKeyPress(KeyboardEventArgs e)
  {
    if (e.Key == "Enter")
    {
      await SearchByName();
    }
  }

  private void GoToPage(int page)
  {
    if (page >= 1 && page <= totalPages)
    {
      Navigation.NavigateTo($"/chatlogs/{BookId}/{page}");
    }
  }

  private void OnPageChange(PaginationEventArgs args)
  {
    GoToPage(args.Page);
  }

  private async Task ViewDetail(int id)
  {
    selectedChatLog = await ChatLogService.GetChatLogByIdAsync(id);

    // 检查是否有上一条/下一条记录
    hasPreviousRecord = await HasPreviousRecord();
    hasNextRecord = await HasNextRecord();

    StateHasChanged();

    // 添加键盘事件监听
    await EnsureJSModule();
    if (jsModule != null && objRef != null)
    {
      await jsModule.InvokeVoidAsync("addKeyboardListener", objRef);
    }
  }

  private async Task CloseDetail()
  {
    // 移除键盘事件监听
    if (jsModule != null)
    {
      await jsModule.InvokeVoidAsync("removeKeyboardListener");
    }

    selectedChatLog = null;
    StateHasChanged();
  }

  private async Task GoToPreviousRecord()
  {
    if (selectedChatLog == null || isNavigating) return;

    isNavigating = true;
    StateHasChanged();

    try
    {
      var previousId = await ChatLogService.GetPreviousChatLogIdAsync(selectedChatLog.Id);
      if (previousId.HasValue)
      {
        selectedChatLog = await ChatLogService.GetChatLogByIdAsync(previousId.Value);
        // 更新导航状态
        hasPreviousRecord = await HasPreviousRecord();
        hasNextRecord = await HasNextRecord();
      }
    }
    finally
    {
      isNavigating = false;
      StateHasChanged();
    }
  }

  private async Task GoToNextRecord()
  {
    if (selectedChatLog == null || isNavigating) return;

    isNavigating = true;
    StateHasChanged();

    try
    {
      var nextId = await ChatLogService.GetNextChatLogIdAsync(selectedChatLog.Id);
      if (nextId.HasValue)
      {
        selectedChatLog = await ChatLogService.GetChatLogByIdAsync(nextId.Value);
        // 更新导航状态
        hasPreviousRecord = await HasPreviousRecord();
        hasNextRecord = await HasNextRecord();
      }
    }
    finally
    {
      isNavigating = false;
      StateHasChanged();
    }
  }

  private async Task<bool> HasPreviousRecord()
  {
    if (selectedChatLog == null) return false;
    var previousId = await ChatLogService.GetPreviousChatLogIdAsync(selectedChatLog.Id);
    return previousId.HasValue;
  }

  private async Task<bool> HasNextRecord()
  {
    if (selectedChatLog == null) return false;
    var nextId = await ChatLogService.GetNextChatLogIdAsync(selectedChatLog.Id);
    return nextId.HasValue;
  }

  private string GetCharacterBackgroundColor(string characterName)
  {
    if (!characterColors.ContainsKey(characterName))
    {
      var index = characterColors.Count % backgroundColors.Length;
      characterColors[characterName] = backgroundColors[index];
    }
    return characterColors[characterName];
  }

  private string GetCharacterColor(string characterName)
  {
    // 为不同角色提供不同的文字颜色
    var hash = characterName.GetHashCode();
    var colors = new[] { "#1890ff", "#52c41a", "#fa8c16", "#eb2f96", "#722ed1", "#13c2c2", "#f5222d" };
    return colors[Math.Abs(hash) % colors.Length];
  }

  private string FormatPreview(string name, DateTime sendDate, string preview)
  {
    // 提取预览中的消息部分（去掉角色名和时间）
    var expectedPrefix = $"{name} {sendDate:yyyy-MM-dd HH:mm} ";
    var message = preview.StartsWith(expectedPrefix) ? preview[expectedPrefix.Length..] : preview;

    return $"<span class='chat-name'>{name}</span> " +
    $"<span class='chat-date'>{sendDate:yyyy-MM-dd HH:mm}</span> " +
    $"<span class='chat-message'>{message}</span>";
  }

  [JSInvokable]
  public async Task OnKeyDown(string key)
  {
    if (selectedChatLog == null || isNavigating) return;

    switch (key)
    {
      case "ArrowLeft":
        await GoToPreviousRecord();
        break;
      case "ArrowRight":
        await GoToNextRecord();
        break;
      case "Escape":
        await CloseDetail();
        break;
    }
  }

  private async Task EnsureJSModule()
  {
    if (jsModule == null)
    {
      jsModule = await JSRuntime.InvokeAsync<IJSObjectReference>("import", "./js/chatLogs.js");
    }
    if (objRef == null)
    {
      objRef = DotNetObjectReference.Create(this);
    }
  }

  protected override async Task OnAfterRenderAsync(bool firstRender)
  {
    if (firstRender)
    {
      await EnsureJSModule();
    }
  }

  public async ValueTask DisposeAsync()
  {
    if (jsModule != null)
    {
      await jsModule.InvokeVoidAsync("removeKeyboardListener");
      await jsModule.DisposeAsync();
    }
    objRef?.Dispose();
  }
}