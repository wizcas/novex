@page "/chatlogs/{bookId:int}"
@inject IChatLogService ChatLogService
@inject IBookService BookService
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime
@inject IMessageService MessageService
@using Novex.Data.Models
@using Novex.Data.Services
@using Novex.Web.Shared.Components
@implements IAsyncDisposable

<PageTitle>聊天记录</PageTitle>

<style>
  .chat-name {
    color: #1890ff;
    font-weight: 600;
  }

  .chat-date {
    color: #6c757d;
    font-weight: 500;
  }

  .chat-message {
    color: #495057;
  }

  /* 角色行背景色 */
  .character-row {
    transition: background-color 0.3s ease;
  }

  .character-row:hover {
    background-color: rgba(24, 144, 255, 0.1) !important;
  }
</style>

<div class="chatlogs-page">
  <div style="margin-bottom: 24px;">
    <Row Justify="@RowJustify.SpaceBetween" Align="@RowAlign.Middle">
      <AntDesign.Col>
        <Title Level="2">
          <Icon Type="message" style="margin-right: 8px; color: #1890ff;" />
          聊天记录列表
        </Title>
        @if (currentBook != null)
        {
          <div style="display: flex; align-items: center; gap: 12px;">
            <div>
              <Text Type="@TextElementType.Secondary">书目：</Text>
              <Text Strong="true">@currentBook.Name</Text>
            </div>
            <a href="/import/@BookId" style="color: #1890ff; text-decoration: none; font-size: 14px;">
              <Icon Type="upload" style="margin-right: 4px;" />
              导入记录
            </a>
          </div>
        }
      </AntDesign.Col>
      <AntDesign.Col>
        <Button Type="@ButtonType.Default" Icon="@IconType.Outline.ArrowLeft"
                OnClick="@(() => Navigation.NavigateTo("/books"))">
          返回书目管理
        </Button>
      </AntDesign.Col>
    </Row>
  </div>

  <div style="margin-bottom: 24px;">
    <Row Gutter="16" Style="margin-bottom: 16px;">
      <AntDesign.Col Span="24">
        <Card Title="筛选条件" Size="@CardSize.Small">
          <Form Model="@filterModel" OnFinish="OnFormSubmit" WrapperCol="GetFormWrapperCol()"
                LabelCol="GetFormLabelCol()">
            <FormItem Label="角色名"><Select TItemValue="string" TItem="string" @bind-Value="nameFilter"
                                             Placeholder="请选择角色" AllowClear="true">
                @foreach (var name in characterNames)
                {
                  <SelectOption TItemValue="string" TItem="string" Value="@name" Label="@name"/>
                }
              </Select>
            </FormItem>
            <FormItem Label="楼层范围">
              <Row>
                <AntDesign.Col Span="24">
                  <Slider Range="true" @bind-Value="floorRange" Min="@minIndex" Max="@maxIndex" InputNumberLeft="true"
                          InputNumberRight="true"/>
                </AntDesign.Col>
              </Row>
              <Row Gutter="16" Style="margin-top: 12px;">
                <Col Span="6">
                  <AntDesign.InputNumber @bind-Value="startIndex"
                                         @bind-Value:after="SyncToSlider"
                                         Min="@minIndex" Max="@maxIndex"
                                         Style="width: 100%; margin-top: 4px;" />
                </Col>
                <Col Span="6" Offset="12">
                  <AntDesign.InputNumber @bind-Value="endIndex"
                                         @bind-Value:after="SyncToSlider"
                                         Min="@minIndex" Max="@maxIndex"
                                         Style="width: 100%; margin-top: 4px;" />
                </Col>
              </Row>
            </FormItem>
            <FormItem>
              <Space>
                <SpaceItem>
                  <Button Type="@ButtonType.Primary" Icon="@IconType.Outline.Search" HtmlType="submit"
                          Size="@ButtonSize.Default">
                    应用筛选
                  </Button>
                </SpaceItem>
                <SpaceItem>
                  <Button Type="@ButtonType.Default" Icon="@IconType.Outline.Clear" OnClick="ClearFilter"
                          Size="@ButtonSize.Default">
                    清除筛选
                  </Button>
                </SpaceItem>
                <SpaceItem>
                  <Button Type="@ButtonType.Default" Icon="@IconType.Outline.Experiment" OnClick="ShowBatchAnalysisModal"
                          Size="@ButtonSize.Default">
                    批量分析
                  </Button>
                </SpaceItem>
              </Space>
            </FormItem>
          </Form>
        </Card>
      </AntDesign.Col>
    </Row>
    <Row Gutter="16">
      <AntDesign.Col Span="24" Style="text-align: right; line-height: 40px;">
        <Text Type="@TextElementType.Secondary">
          共
          <Text Strong="true" style="color: #1890ff;">@totalCount</Text>
          条记录
        </Text>
      </AntDesign.Col>
    </Row>
  </div>

  @if (isLoading)
  {
    <div style="text-align: center; padding: 48px;">
      <Spin Size="@SpinSize.Large"/>
      <div style="margin-top: 16px;">
        <Text Type="@TextElementType.Secondary">加载中...</Text>
      </div>
    </div>
  }
  else if (chatLogs.Any())
  {
    <div style="overflow-x: auto;">
      <Table TItem="ChatLogSummary"
             DataSource="@chatLogs"
             Size="@TableSize.Small"
             ScrollX="900"
             Total="@totalCount"
             Loading="@isLoading"
             PageIndex="@currentPage"
             PageSize="@pageSize"
             >
        <ChildContent>
        <Column TData="ChatLogSummary" Title="楼层" Width="60px">
          <Template>
            <Text Type="@TextElementType.Secondary">@context.Index</Text>
          </Template>
        </Column>
        <Column TData="ChatLogSummary" Title="角色名" Width="150px">
          <Template>
            <Text Style="@($"color: {GetCharacterColor(context.Name)}")">@context.Name</Text>
          </Template>
        </Column>
        <Column TData="ChatLogSummary" Title="发送时间" Width="100px">
          <Template>
            @context.SendDate.ToString("yyyy-MM-dd HH:mm:ss")
          </Template>
        </Column>
        <Column TData="ChatLogSummary" Title="预览">
          <Template>
            <div style="max-width: 400px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
              @if (!string.IsNullOrEmpty(context.Summary))
              {
                <span>@context.Summary</span>
              }
              else
              {
                <span style="color: #999; font-style: italic;">暂无摘要</span>
              }
            </div>
          </Template>
        </Column>
        <ActionColumn Title="操作" Width="160px" Fixed="@ColumnFixPlacement.Right">
          <Template>
            <Space>
              <SpaceItem>
                <Button Type="@ButtonType.Primary" Size="@ButtonSize.Small" Icon="@IconType.Outline.Eye"
                        OnClick="@(() => ViewDetail(context.Id))">
                  详情
                </Button>
              </SpaceItem>
              <SpaceItem>
                <Button Type="@ButtonType.Default" Size="@ButtonSize.Small" Icon="@IconType.Outline.Experiment"
                        OnClick="@(() => AnalyzeContent(context.Id))">
                  分析
                </Button>
              </SpaceItem>
            </Space>
          </Template>
        </ActionColumn>
        </ChildContent>
        <PaginationTemplate>
          <div style="text-align: center; padding: 16px 0;">
            <Pagination Current="@currentPage" Total="@totalCount" PageSize="@pageSize"
                        OnChange="@OnPageChange"
                        ShowSizeChanger="true"
                        OnShowSizeChange="@OnPaginationSizeChange"
                        PageSizeOptions="@(new[] { 10, 20, 50, 100 })"
                        ShowQuickJumper="true"/>
          </div>
        </PaginationTemplate>
      </Table>
    </div>


  }
  else
  {
    <Empty>
      <DescriptionTemplate>
        <Text Type="@TextElementType.Secondary">暂无聊天记录</Text>
        <br/>
        <Text Type="@TextElementType.Secondary">请先导入聊天记录。</Text>
      </DescriptionTemplate>
      <ChildContent>
        <Button Type="@ButtonType.Primary" Icon="@IconType.Outline.Import"
                OnClick="@(() => Navigation.NavigateTo("/import"))">
          导入聊天记录
        </Button>
      </ChildContent>
    </Empty>
  }

  <!-- 详情模态框 -->
  @if (selectedChatLog != null)
  {
    RenderFragment detailFooter = @<Template>
      <div style="display: flex; justify-content: space-between; width: 100%;">
        <div>
          <Button Icon="@IconType.Outline.Left" OnClick="GoToPreviousRecord"
                  Disabled="@(isNavigating || !hasPreviousRecord)" Loading="@isNavigating" @key="@("prev")">
            上一条
          </Button>
          <Button Icon="@IconType.Outline.Right" OnClick="GoToNextRecord" Disabled="@(isNavigating || !hasNextRecord)"
                  Loading="@isNavigating" Style="margin-left: 8px;" @key="@("next")">
            下一条
          </Button>
        </div>
        <Button OnClick="CloseDetail" @key="@("close")">关闭</Button>
      </div>
    </Template>;

    <Modal Title="@($"聊天记录详情 - ID: {selectedChatLog.Id}")" Visible="true" OnCancel="CloseDetail"
           Footer="@detailFooter"
           Width="800" Keyboard="true">
      <div>
        <Alert Type="@AlertType.Info" Message="键盘操作提示"
               Description="使用左右方向键切换上一条/下一条记录，ESC键关闭详情窗口。" ShowIcon="true"
               Style="margin-bottom: 16px;"/>
        <Row Style="margin-bottom: 16px;">
          <AntDesign.Col Span="4">
            <Text Strong="true">角色名:</Text>
          </AntDesign.Col>
          <AntDesign.Col Span="20">
            <Text>@selectedChatLog.Name</Text>
          </AntDesign.Col>
        </Row>
        <Row Style="margin-bottom: 16px;">
          <AntDesign.Col Span="4">
            <Text Strong="true">发送时间:</Text>
          </AntDesign.Col>
          <AntDesign.Col Span="20">
            <Text>@selectedChatLog.SendDate.ToString("yyyy-MM-dd HH:mm:ss")</Text>
          </AntDesign.Col>
        </Row>
        <Row>
          <AntDesign.Col Span="4">
            <Text Strong="true">内容:</Text>
          </AntDesign.Col>
          <AntDesign.Col Span="20">
            <div
              style="border: 1px solid #d9d9d9; padding: 12px; border-radius: 6px; background: #fafafa; max-height: 400px; overflow-y: auto; white-space: pre-wrap; font-family: monospace;">
              @selectedChatLog.Mes
            </div>
          </AntDesign.Col>
        </Row>
      </div>
    </Modal>
  }

  <!-- 批量分析模态框 -->
  <BatchAnalysisModal IsVisible="@showBatchAnalysisModal"
                      IsVisibleChanged="@((visible) => showBatchAnalysisModal = visible)"
                      OnCancel="@(() => showBatchAnalysisModal = false)"
                      OnCompleted="OnBatchAnalysisCompleted"
                      BookId="@BookId" />
</div>

@code {

  [Parameter]
  public int BookId { get; set; }

  [SupplyParameterFromQuery]
  public int? Page { get; set; }

  [SupplyParameterFromQuery]
  public int? Size { get; set; }

  [SupplyParameterFromQuery(Name = "char")]
  public string? Char { get; set; }

  [SupplyParameterFromQuery(Name = "range")]
  public string? Range { get; set; }

  private List<ChatLogSummary> chatLogs = new();
  private bool isLoading;
  private bool isNavigating;
  private int currentPage = 1;
  private int totalCount;
  private int totalPages;
  private int pageSize = 20;
  private string nameFilter = string.Empty;
  private string currentNameFilter = string.Empty;
  private ChatLog? selectedChatLog;
  private Book? currentBook;
  private IJSObjectReference? jsModule;
  private DotNetObjectReference<ChatLogs>? objRef;
  private bool hasPreviousRecord;
  private bool hasNextRecord;
  private int _startIndex;
  private int _endIndex;
  private int? currentStartIndex;
  private int? currentEndIndex;
  private (double, double) _floorRange = (0, 0);
  private bool _hasInitialized = false;

  // 批量分析相关变量
  private bool showBatchAnalysisModal = false;

  private int startIndex
  {
    get => _startIndex;
    set
    {
      var newValue = ValidateAndAdjustStartIndex(value);
      if (_startIndex != newValue)
      {
        _startIndex = newValue;
        // 确保结束楼层不小于起始楼层
        if (_endIndex < _startIndex)
        {
          _endIndex = _startIndex;
        }
      }
    }
  }

  private int endIndex
  {
    get => _endIndex;
    set
    {
      var newValue = ValidateAndAdjustEndIndex(value);
      if (_endIndex != newValue)
      {
        _endIndex = newValue;
        // 确保起始楼层不大于结束楼层
        if (_startIndex > _endIndex)
        {
          _startIndex = _endIndex;
        }
      }
    }
  }

  private (double, double) floorRange
  {
    get => _floorRange;
    set
    {
      _floorRange = value;
      var newStart = ValidateAndAdjustStartIndex((int)value.Item1);
      var newEnd = ValidateAndAdjustEndIndex((int)value.Item2);

      // 确保范围有效性
      if (newStart > newEnd)
      {
        newEnd = newStart;
      }

      if (_startIndex != newStart || _endIndex != newEnd)
      {
        _startIndex = newStart;
        _endIndex = newEnd;
        StateHasChanged();
      }
    }
  }

  // 验证和调整起始楼层值
  private int ValidateAndAdjustStartIndex(int value)
  {
    if (value < minIndex) return minIndex;
    if (value > maxIndex) return maxIndex;
    return value;
  }

  // 验证和调整结束楼层值
  private int ValidateAndAdjustEndIndex(int value)
  {
    if (value < minIndex) return minIndex;
    if (value > maxIndex) return maxIndex;
    return value;
  }

  // 当 InputNumber 值改变时同步到 slider
  private void SyncToSlider()
  {
    _floorRange = (_startIndex, _endIndex);
    StateHasChanged();
  }

  private int minIndex;
  private int maxIndex;
  private readonly string[] characterColors = new[] {
    "#828a00",
    "#f29f05",
    "#ff5ca3",
    "#4d8584",
    "#a62f03",
  };

  private List<string> characterNames = new();

  // 表单模型
  private FilterModel filterModel = new();

  public class FilterModel
  {
    public string? Name { get; set; }
    public int? StartIndex { get; set; }
    public int? EndIndex { get; set; }
  }

  protected async override Task OnInitializedAsync()
  {
    currentPage = Page ?? 1;
    pageSize = Size ?? 20;
    currentBook = await BookService.GetBookByIdAsync(BookId);

    // 获取Index范围
    (int MinIndex, int MaxIndex) range = await ChatLogService.GetIndexRangeAsync(BookId);
    minIndex = range.MinIndex;
    maxIndex = range.MaxIndex;

    // 初始化楼层范围滑块的默认值
    if (_floorRange.Item1 == 0 && _floorRange.Item2 == 0)
    {
      _startIndex = minIndex;
      _endIndex = maxIndex;
      _floorRange = (minIndex, maxIndex);
    }

    // 获取所有角色名
    characterNames = await ChatLogService.GetCharacterNamesAsync(BookId);

    // 从URL参数初始化过滤器
    InitializeFiltersFromUrl();

    await LoadChatLogs();
    _hasInitialized = true;
  }

  protected async override Task OnParametersSetAsync()
  {
    if (!_hasInitialized) return;

    var shouldReload = false;

    // 检查页面参数变化
    if (Page.HasValue && Page.Value != currentPage)
    {
      currentPage = Page.Value;
      shouldReload = true;
    }

    // 检查页面大小参数变化
    if (Size.HasValue && Size.Value != pageSize)
    {
      pageSize = Size.Value;
      shouldReload = true;
    }

    // 检查过滤器参数变化
    var urlCharFilter = Char ?? string.Empty;
    if (urlCharFilter != currentNameFilter)
    {
      nameFilter = urlCharFilter;
      currentNameFilter = urlCharFilter;
      shouldReload = true;
    }

    // 检查楼层范围参数变化
    if (!string.IsNullOrEmpty(Range))
    {
      var (start, end) = ParseRangeParameter(Range);
      var newStartIndex = start.HasValue ? start.Value : (int?)null;
      var newEndIndex = end.HasValue ? end.Value : (int?)null;

      if (newStartIndex != currentStartIndex || newEndIndex != currentEndIndex)
      {
        if (newStartIndex.HasValue)
        {
          _startIndex = ValidateAndAdjustStartIndex(newStartIndex.Value);
          currentStartIndex = _startIndex;
        }
        else
        {
          _startIndex = minIndex;
          currentStartIndex = null;
        }

        if (newEndIndex.HasValue)
        {
          _endIndex = ValidateAndAdjustEndIndex(newEndIndex.Value);
          currentEndIndex = _endIndex;
        }
        else
        {
          _endIndex = maxIndex;
          currentEndIndex = null;
        }

        // 确保范围有效性
        if (_startIndex > _endIndex)
        {
          _endIndex = _startIndex;
          currentEndIndex = _startIndex;
        }

        _floorRange = (_startIndex, _endIndex);
        shouldReload = true;
      }
    }
    else if (currentStartIndex.HasValue || currentEndIndex.HasValue)
    {
      // Range参数被清除
      _startIndex = minIndex;
      _endIndex = maxIndex;
      currentStartIndex = null;
      currentEndIndex = null;
      _floorRange = (minIndex, maxIndex);
      shouldReload = true;
    }

    if (shouldReload)
    {
      await LoadChatLogs();
    }
  }

  private async Task LoadChatLogs()
  {
    isLoading = true;
    StateHasChanged();

    try
    {
      // 使用统一的筛选方法
      chatLogs = await ChatLogService.GetChatLogsWithFiltersAsync(
        BookId,
        string.IsNullOrWhiteSpace(currentNameFilter) ? null : currentNameFilter,
        currentStartIndex,
        currentEndIndex,
        currentPage,
        pageSize);

      totalCount = await ChatLogService.GetTotalCountWithFiltersAsync(
        BookId,
        string.IsNullOrWhiteSpace(currentNameFilter) ? null : currentNameFilter,
        currentStartIndex,
        currentEndIndex);

      totalPages = (int)Math.Ceiling((double)totalCount / pageSize);
    }
    finally
    {
      isLoading = false;
      StateHasChanged();
    }
  }

  private async Task ApplyFilters()
  {
    // 应用当前的筛选条件
    currentNameFilter = nameFilter;
    // 只有当值不等于全范围时才设置筛选条件
    currentStartIndex = (startIndex == minIndex && endIndex == maxIndex) ? null : startIndex;
    currentEndIndex = (startIndex == minIndex && endIndex == maxIndex) ? null : endIndex;
    currentPage = 1;

    // 构建URL参数
    var charFilter = string.IsNullOrEmpty(currentNameFilter) ? null : currentNameFilter;
    var rangeFilter = (currentStartIndex.HasValue || currentEndIndex.HasValue)
                      ? BuildRangeParameter(currentStartIndex, currentEndIndex)
                      : null;

    var url = BuildUrl(1, pageSize, charFilter, rangeFilter);
    Navigation.NavigateTo(url, false);
    await LoadChatLogs();
  }

  private async Task ClearFilter()
  {
    nameFilter = string.Empty;
    currentNameFilter = string.Empty;
    startIndex = minIndex;
    endIndex = maxIndex;
    currentStartIndex = null;
    currentEndIndex = null;
    currentPage = 1;
    _floorRange = (minIndex, maxIndex);

    // 清除过滤器时只保留page和size参数
    var url = BuildUrl(1, pageSize);
    Navigation.NavigateTo(url, false);
    await LoadChatLogs();
  }

  private async Task OnKeyPress(KeyboardEventArgs e)
  {
    if (e.Key == "Enter")
    {
      Console.WriteLine("Enter key pressed, applying filters...");
      await ApplyFilters();
    }
  }

  private async Task OnEnterPressed()
  {
    Console.WriteLine("AntDesign Enter event triggered, applying filters...");
    await ApplyFilters();
  }

  private async Task OnFormSubmit()
  {
    Console.WriteLine("Form submitted, applying filters...");
    await ApplyFilters();
  }


  private async Task GoToPage(int page)
  {
    if (page >= 1 && page <= totalPages)
    {
      // 保存当前滚动位置并防止闪烁
      await SaveScrollPosition();
      await PreventScrollFlash();

      // 构建URL参数，保持过滤器状态
      var charFilter = string.IsNullOrEmpty(currentNameFilter) ? null : currentNameFilter;
      var rangeFilter = (currentStartIndex.HasValue || currentEndIndex.HasValue)
                        ? BuildRangeParameter(currentStartIndex, currentEndIndex)
                        : null;

      var url = BuildUrl(page, pageSize, charFilter, rangeFilter);
      Navigation.NavigateTo(url, false);

      // 直接更新currentPage并重新加载数据，避免通过OnParametersSetAsync触发
      currentPage = page;
      await LoadChatLogs();

      // 释放滚动锁定并恢复滚动位置
      await ReleaseScrollLock();
      await RestoreScrollPosition();
    }
  }

  private async Task OnPageChange(PaginationEventArgs args)
  {
    await GoToPage(args.Page);
  }

  private async Task OnPaginationSizeChange(PaginationEventArgs args)
  {
    pageSize = args.PageSize;
    currentPage = 1; // 重置到第一页

    // 保存当前滚动位置并防止闪烁
    await SaveScrollPosition();
    await PreventScrollFlash();

    // 构建URL参数，保持过滤器状态
    var charFilter = string.IsNullOrEmpty(currentNameFilter) ? null : currentNameFilter;
    var rangeFilter = (currentStartIndex.HasValue || currentEndIndex.HasValue)
                      ? BuildRangeParameter(currentStartIndex, currentEndIndex)
                      : null;

    var url = BuildUrl(1, pageSize, charFilter, rangeFilter);
    Navigation.NavigateTo(url, false);

    // 重新加载数据
    await LoadChatLogs();

    // 释放滚动锁定并恢复滚动位置
    await ReleaseScrollLock();
    await RestoreScrollPosition();
  }

  private async Task ViewDetail(int id)
  {
    selectedChatLog = await ChatLogService.GetChatLogByIdAsync(id);

    // 检查是否有上一条/下一条记录
    hasPreviousRecord = await HasPreviousRecord();
    hasNextRecord = await HasNextRecord();

    StateHasChanged();

    // 添加键盘事件监听
    await EnsureJSModule();
    if (jsModule != null && objRef != null)
    {
      await jsModule.InvokeVoidAsync("addKeyboardListener", objRef);
    }
  }

  private void AnalyzeContent(int id)
  {
    Navigation.NavigateTo($"/chatlogs/{BookId}/{id}/analyze");
  }

  private async Task CloseDetail()
  {
    // 移除键盘事件监听
    if (jsModule != null)
    {
      await jsModule.InvokeVoidAsync("removeKeyboardListener");
    }

    selectedChatLog = null;
    StateHasChanged();
  }

  private async Task GoToPreviousRecord()
  {
    if (selectedChatLog == null || isNavigating) return;

    isNavigating = true;
    StateHasChanged();

    try
    {
      var previousId = await ChatLogService.GetPreviousChatLogIdAsync(selectedChatLog.Id);
      if (previousId.HasValue)
      {
        selectedChatLog = await ChatLogService.GetChatLogByIdAsync(previousId.Value);
        // 更新导航状态
        hasPreviousRecord = await HasPreviousRecord();
        hasNextRecord = await HasNextRecord();
      }
    }
    finally
    {
      isNavigating = false;
      StateHasChanged();
    }
  }

  private async Task GoToNextRecord()
  {
    if (selectedChatLog == null || isNavigating) return;

    isNavigating = true;
    StateHasChanged();

    try
    {
      var nextId = await ChatLogService.GetNextChatLogIdAsync(selectedChatLog.Id);
      if (nextId.HasValue)
      {
        selectedChatLog = await ChatLogService.GetChatLogByIdAsync(nextId.Value);
        // 更新导航状态
        hasPreviousRecord = await HasPreviousRecord();
        hasNextRecord = await HasNextRecord();
      }
    }
    finally
    {
      isNavigating = false;
      StateHasChanged();
    }
  }

  private async Task<bool> HasPreviousRecord()
  {
    if (selectedChatLog == null) return false;
    var previousId = await ChatLogService.GetPreviousChatLogIdAsync(selectedChatLog.Id);
    return previousId.HasValue;
  }

  private async Task<bool> HasNextRecord()
  {
    if (selectedChatLog == null) return false;
    var nextId = await ChatLogService.GetNextChatLogIdAsync(selectedChatLog.Id);
    return nextId.HasValue;
  }

  private string GetCharacterColor(string characterName)
  {
    // 使用更好的哈希分布算法避免颜色冲突
    // 1. 使用多重哈希来增加随机性
    var hash1 = characterName.GetHashCode();
    var hash2 = characterName.Length * 31;

    // 2. 对每个字符进行累积哈希
    uint hash = 0;
    foreach (char c in characterName)
    {
      hash = hash * 31 + (uint)c;
    }

    // 3. 使用FNV-1a哈希算法进一步混合
    const uint FNV_PRIME = 16777619;
    const uint FNV_OFFSET_BASIS = 2166136261;

    uint fnvHash = FNV_OFFSET_BASIS;
    foreach (byte b in System.Text.Encoding.UTF8.GetBytes(characterName))
    {
      fnvHash ^= b;
      fnvHash *= FNV_PRIME;
    }

    // 4. 组合多个哈希值并映射到颜色索引
    var combinedHash = (int)((hash ^ fnvHash ^ (uint)hash1 ^ (uint)hash2) & 0x7FFFFFFF);
    var idx = combinedHash % characterColors.Length;

    return characterColors[idx];
  }



  [JSInvokable]
  public async Task OnKeyDown(string key)
  {
    if (selectedChatLog == null || isNavigating) return;

    switch (key)
    {
      case "ArrowLeft":
        await GoToPreviousRecord();
        break;
      case "ArrowRight":
        await GoToNextRecord();
        break;
      case "Escape":
        await CloseDetail();
        break;
    }
  }

  private async Task EnsureJSModule()
  {
    if (jsModule == null)
    {
      jsModule = await JSRuntime.InvokeAsync<IJSObjectReference>("import", $"./js/chatLogs.js?v={DateTime.Now.Ticks}");
    }
    if (objRef == null)
    {
      objRef = DotNetObjectReference.Create(this);
    }
  }

  private async Task SaveScrollPosition()
  {
    await EnsureJSModule();
    if (jsModule != null)
    {
      await jsModule.InvokeVoidAsync("saveScrollPosition");
    }
  }

  private async Task RestoreScrollPosition()
  {
    await EnsureJSModule();
    if (jsModule != null)
    {
      await jsModule.InvokeVoidAsync("restoreScrollPosition");
    }
  }

  private async Task PreventScrollFlash()
  {
    await EnsureJSModule();
    if (jsModule != null)
    {
      await jsModule.InvokeVoidAsync("preventScrollFlash");
    }
  }

  private async Task ReleaseScrollLock()
  {
    await EnsureJSModule();
    if (jsModule != null)
    {
      await jsModule.InvokeVoidAsync("releaseScrollLock");
    }
  }

  protected async override Task OnAfterRenderAsync(bool firstRender)
  {
    if (firstRender)
    {
      await EnsureJSModule();
    }
  }

  public async ValueTask DisposeAsync()
  {
    if (jsModule != null)
    {
      try
      {
        await jsModule.InvokeVoidAsync("removeKeyboardListener");
        await jsModule.DisposeAsync();
      }
      catch (JSDisconnectedException)
      {
        // Circuit已断开，忽略JS互操作错误
      }
      jsModule = null;
    }
    objRef?.Dispose();
  }

  // Form 布局配置
  private ColLayoutParam GetFormLabelCol()
  {
    return new ColLayoutParam {
      Xs = new EmbeddedProperty { Span = 24 },
      Sm = new EmbeddedProperty { Span = 6 },
      Md = new EmbeddedProperty { Span = 4 },
      Lg = new EmbeddedProperty { Span = 3 },
      Xl = new EmbeddedProperty { Span = 3 }
    };
  }

  private ColLayoutParam GetFormWrapperCol()
  {
    return new ColLayoutParam {
      Xs = new EmbeddedProperty { Span = 24 },
      Sm = new EmbeddedProperty { Span = 18 },
      Md = new EmbeddedProperty { Span = 20 },
      Lg = new EmbeddedProperty { Span = 21 },
      Xl = new EmbeddedProperty { Span = 21 }
    };
  }

  private ColLayoutParam GetButtonItemLayout()
  {
    return new ColLayoutParam {
      Xs = new EmbeddedProperty { Span = 24, Offset = 0 },
      Sm = new EmbeddedProperty { Span = 18, Offset = 6 },
      Md = new EmbeddedProperty { Span = 20, Offset = 4 },
      Lg = new EmbeddedProperty { Span = 21, Offset = 3 },
      Xl = new EmbeddedProperty { Span = 21, Offset = 3 }
    };
  }

  private void InitializeFiltersFromUrl()
  {
    // 从URL参数初始化角色名过滤器
    if (!string.IsNullOrEmpty(Char))
    {
      nameFilter = Char;
      currentNameFilter = Char;
    }

    // 从URL参数初始化楼层范围过滤器
    if (!string.IsNullOrEmpty(Range))
    {
      var (start, end) = ParseRangeParameter(Range);
      if (start.HasValue)
      {
        _startIndex = ValidateAndAdjustStartIndex(start.Value);
        currentStartIndex = _startIndex;
      }
      else
      {
        _startIndex = minIndex;
        currentStartIndex = null;
      }

      if (end.HasValue)
      {
        _endIndex = ValidateAndAdjustEndIndex(end.Value);
        currentEndIndex = _endIndex;
      }
      else
      {
        _endIndex = maxIndex;
        currentEndIndex = null;
      }

      // 确保范围有效性
      if (_startIndex > _endIndex)
      {
        _endIndex = _startIndex;
        currentEndIndex = _startIndex;
      }

      _floorRange = (_startIndex, _endIndex);
    }
  }

  private (int?, int?) ParseRangeParameter(string range)
  {
    if (string.IsNullOrEmpty(range))
      return (null, null);

    var parts = range.Split(',');
    if (parts.Length != 2)
      return (null, null);

    int? start = null;
    int? end = null;

    // 解析起始值
    if (!string.IsNullOrEmpty(parts[0]) && int.TryParse(parts[0], out var startValue))
    {
      start = startValue;
    }

    // 解析结束值
    if (!string.IsNullOrEmpty(parts[1]) && int.TryParse(parts[1], out var endValue))
    {
      end = endValue;
    }

    return (start, end);
  }

  private string BuildUrl(int page, int size, string? charFilter = null, string? rangeFilter = null)
  {
    var url = $"/chatlogs/{BookId}?page={page}&size={size}";

    if (!string.IsNullOrEmpty(charFilter))
    {
      url += $"&char={Uri.EscapeDataString(charFilter)}";
    }

    if (!string.IsNullOrEmpty(rangeFilter))
    {
      url += $"&range={Uri.EscapeDataString(rangeFilter)}";
    }

    return url;
  }

  private string BuildRangeParameter(int? startIndex, int? endIndex)
  {
    if (!startIndex.HasValue && !endIndex.HasValue)
      return string.Empty;

    var start = startIndex?.ToString() ?? "";
    var end = endIndex?.ToString() ?? "";
    return $"{start},{end}";
  }

  // 批量分析相关方法
  private void ShowBatchAnalysisModal()
  {
    showBatchAnalysisModal = true;
  }

  private async Task OnBatchAnalysisCompleted(BatchAnalysisModal.BatchAnalysisResult result)
  {
    // 刷新页面数据
    await LoadChatLogs();
    
    // 显示完成消息
    if (result.ErrorCount > 0)
    {
      MessageService.Warning($"批量分析完成！成功处理 {result.SuccessCount}/{result.ProcessedCount} 条记录，{result.ErrorCount} 个错误");
    }
    else
    {
      MessageService.Success($"批量分析完成！成功处理 {result.SuccessCount} 条记录");
    }
  }

}