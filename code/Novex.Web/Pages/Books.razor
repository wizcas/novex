@page "/books"
@using Novex.Data.Models
@using Novex.Data.Services
@inject IBookService BookService
@inject NavigationManager Navigation

<PageTitle>书目管理</PageTitle>

<div class="books-page">
    <div style="margin-bottom: 24px;">
        <Title Level="2">
            <Icon Type="book" style="margin-right: 8px; color: #1890ff;" />
            书目管理
        </Title>
    </div>

    <div style="margin-bottom: 24px;">
        <Row Gutter="16">
            <AntDesign.Col Span="12">
                <Input Placeholder="输入新书目名称..." @bind-Value="newBookName" OnPressEnter="OnEnterKeyPressed"
                       OnInput="OnBookNameInput" Size="@InputSize.Large">
                <Prefix>
                    <Icon Type="plus-circle"/>
                </Prefix>
                </Input>
            </AntDesign.Col>
            <AntDesign.Col Span="6">
                <Button Type="@ButtonType.Primary" Size="@ButtonSize.Large" Loading="@isCreating"
                        Disabled="@(string.IsNullOrWhiteSpace(newBookName) || isCreating)" OnClick="CreateBook">
                    <Icon Type="plus"/>
                    创建书目
                </Button>
            </AntDesign.Col>
        </Row>
    </div>

    @if (isLoading)
    {
        <div style="text-align: center; padding: 48px;">
            <Spin Size="@SpinSize.Large"/>
            <div style="margin-top: 16px;">
                <Text Type="@TextElementType.Secondary">加载中...</Text>
            </div>
        </div>
    }
    else if (books.Any())
    {
        <Table TItem="BookSummary" DataSource="@books" Size="@TableSize.Middle" Bordered="true">
            <Column TData="BookSummary" Title="ID" Width="80px">
                <Template>
                    @context.Id
                </Template>
            </Column>
            <Column TData="BookSummary" Title="书目名称">
                <Template>
                    <Text Strong="true">@context.Name</Text>
                </Template>
            </Column>
            <Column TData="BookSummary" Title="对话数量" Width="120px">
                <Template>
                    <div style="text-align: center;">
                        @if (context.ChatLogCount > 0)
                        {
                            <strong style="color: #1890ff;">@context.ChatLogCount</strong>
                        }
                        else
                        {
                            <span style="color: #999;">0</span>
                        }
                    </div>
                </Template>
            </Column>
            <Column TData="BookSummary" Title="创建时间" Width="180px">
                <Template>
                    @context.CreatedDate.ToString("yyyy-MM-dd HH:mm:ss")
                </Template>
            </Column>
            <ActionColumn Title="操作" Width="300px">
                <Template>
                    <Space Size="@SpaceSize.Small">
                        <SpaceItem>
                            <Button Type="@ButtonType.Primary" Size="@ButtonSize.Small"
                                    OnClick="() => ViewChatLogs(context.Id)">
                                <Icon Type="eye"/>
                                查看聊天记录
                            </Button>
                        </SpaceItem>
                        <SpaceItem>
                            <Button Type="@ButtonType.Default" Size="@ButtonSize.Small" Danger="false"
                                    Disabled="@isOperating" OnClick="() => ShowClearConfirm(context)">
                                <Icon Type="clear"/>
                                清空记录
                            </Button>
                        </SpaceItem>
                        <SpaceItem>
                            <Button Type="@ButtonType.Primary" Size="@ButtonSize.Small" Danger="true"
                                    Disabled="@isOperating" OnClick="() => ShowDeleteConfirm(context)">
                                <Icon Type="delete"/>
                                删除书目
                            </Button>
                        </SpaceItem>
                    </Space>
                </Template>
            </ActionColumn>
        </Table>
    }
    else
    {
        <Empty>
            <DescriptionTemplate>
                <Text Type="@TextElementType.Secondary">暂无书目</Text>
                <br/>
                <Text Type="@TextElementType.Secondary">请创建一个新的书目开始使用。</Text>
            </DescriptionTemplate>
            <ChildContent>
                <Button Type="@ButtonType.Primary" OnClick="() => { }">
                    <Icon Type="plus"/>
                    创建第一个书目
                </Button>
            </ChildContent>
        </Empty>
    }

    <!-- 确认删除模态框 -->
    @if (bookToDelete != null)
    {
        RenderFragment deleteFooter = @<Template>
            <Button OnClick="CancelDelete" @key="@("cancel")">取消</Button>
            <Button OnClick="ConfirmDelete" @key="@("confirm")" Type="ButtonType.Primary" Danger="true"
                    Loading="@isOperating">
                确认删除
            </Button>
        </Template>;

        <Modal Title="确认删除" Visible="true" OnOk="ConfirmDelete" OnCancel="CancelDelete" Footer="@deleteFooter">
            <p>确定要删除书目 "
                <Text Strong="true">@bookToDelete.Name</Text>
                " 吗？
            </p>
            <Alert Type="@AlertType.Error" Message="⚠️ 此操作将同时删除该书目下的所有聊天记录，且无法恢复！"
                   ShowIcon="true"
                   Style="margin-top: 16px;"/>
        </Modal>
    }

    <!-- 确认清空记录模态框 -->
    @if (bookToClear != null)
    {
        RenderFragment clearFooter = @<Template>
            <Button OnClick="CancelClear" @key="@("cancel-clear")">取消</Button>
            <Button OnClick="ConfirmClear" @key="@("confirm-clear")" Type="ButtonType.Primary" Danger="true"
                    Loading="@isOperating">
                确认清空
            </Button>
        </Template>;

        <Modal Title="确认清空记录" Visible="true" OnOk="ConfirmClear" OnCancel="CancelClear" Footer="@clearFooter">
            <p>确定要清空书目 "
                <Text Strong="true">@bookToClear.Name</Text>
                " 的所有聊天记录吗？
            </p>
            <Alert Type="@AlertType.Warning" Message="⚠️ 此操作将删除该书目下的所有聊天记录，但保留书目本身，且无法恢复！"
                   ShowIcon="true"
                   Style="margin-top: 16px;"/>
        </Modal>
    }

    @if (!string.IsNullOrEmpty(message))
    {
        <div style="margin-bottom: 16px;">
            <Alert Type="@(isError ? AlertType.Error : AlertType.Success)" Message="@message" ShowIcon="true"
                   Closable="true"
                   OnClose="ClearMessage"/>
        </div>
    }
</div>

@code {
    private List<BookSummary> books = new();
    private bool isLoading;
    private bool isCreating;
    private bool isOperating;
    private string newBookName = string.Empty;
    private string message = string.Empty;
    private bool isError;
    private BookSummary? bookToDelete;
    private BookSummary? bookToClear;

    protected async override Task OnInitializedAsync()
    {
        await LoadBooks();
    }

    private async Task LoadBooks()
    {
        isLoading = true;
        StateHasChanged();

        try
        {
            books = await BookService.GetAllBooksWithChatCountAsync();
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task CreateBook()
    {
        // 双重检查防止按钮禁用时仍被点击
        if (string.IsNullOrWhiteSpace(newBookName) || isCreating) return;

        isCreating = true;
        StateHasChanged();

        try
        {
            Book book = await BookService.CreateBookAsync(newBookName.Trim());
            await LoadBooks();
            newBookName = string.Empty;
            ShowMessage($"书目 \"{book.Name}\" 创建成功", false);
        }
        catch (Exception ex)
        {
            ShowMessage($"创建书目失败: {ex.Message}", true);
        }
        finally
        {
            isCreating = false;
            StateHasChanged();
        }
    }

    private void ViewChatLogs(int bookId)
    {
        Navigation.NavigateTo($"/chatlogs/{bookId}");
    }

    private void ShowDeleteConfirm(BookSummary book)
    {
        bookToDelete = book;
        StateHasChanged();
    }

    private void CancelDelete()
    {
        bookToDelete = null;
        StateHasChanged();
    }

    private async Task ConfirmDelete()
    {
        if (bookToDelete == null) return;

        isOperating = true;
        StateHasChanged();

        try
        {
            var bookName = bookToDelete.Name;
            var success = await BookService.DeleteBookAsync(bookToDelete.Id);
            if (success)
            {
                await LoadBooks();
                ShowMessage($"书目 \"{bookName}\" 删除成功", false);
            }
            else
            {
                ShowMessage("删除书目失败", true);
            }
        }
        catch (Exception ex)
        {
            ShowMessage($"删除书目失败: {ex.Message}", true);
        }
        finally
        {
            bookToDelete = null;
            isOperating = false;
            StateHasChanged();
        }
    }

    private void ShowClearConfirm(BookSummary book)
    {
        bookToClear = book;
        StateHasChanged();
    }

    private void CancelClear()
    {
        bookToClear = null;
        StateHasChanged();
    }

    private async Task ConfirmClear()
    {
        if (bookToClear == null) return;

        isOperating = true;
        StateHasChanged();

        try
        {
            var bookName = bookToClear.Name;
            var count = await BookService.ClearBookChatLogsAsync(bookToClear.Id);
            await LoadBooks(); // 刷新表格数据
            ShowMessage($"书目 \"{bookName}\" 的聊天记录清空成功，共删除 {count} 条记录", false);
        }
        catch (Exception ex)
        {
            ShowMessage($"清空聊天记录失败: {ex.Message}", true);
        }
        finally
        {
            bookToClear = null;
            isOperating = false;
            StateHasChanged();
        }
    }

    private void ShowMessage(string msg, bool error)
    {
        message = msg;
        isError = error;
        StateHasChanged();
    }

    private void ClearMessage()
    {
        message = string.Empty;
        StateHasChanged();
    }

    private void OnBookNameInput(ChangeEventArgs e)
    {
        newBookName = e.Value?.ToString() ?? string.Empty;
        StateHasChanged();
    }

    private async Task OnEnterKeyPressed()
    {
        if (!string.IsNullOrWhiteSpace(newBookName) && !isCreating)
        {
            await CreateBook();
        }
    }

}