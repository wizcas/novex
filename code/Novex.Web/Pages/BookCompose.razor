@page "/books/{BookId:int}/compose"
@using Novex.Data.Models
@using Novex.Data.Services
@using AntDesign
@using Novex.Web.Components
@inject IBookService BookService
@inject IBookChapterService BookChapterService
@inject IChatLogService ChatLogService
@inject IAnalysisService AnalysisService
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime
@inject IMessageService MessageService
@implements IDisposable

<PageTitle>编纂书目 - @(currentBook?.Name ?? "加载中...")</PageTitle>

<div class="compose-page">
    <!-- 面包屑导航 -->
    <div style="margin-bottom: 16px;">
        <Breadcrumb>
            <BreadcrumbItem Href="/">
                <Icon Type="home" /> 首页
            </BreadcrumbItem>
            <BreadcrumbItem Href="/books">
                <Icon Type="book" /> 书目管理
            </BreadcrumbItem>
            @if (currentBook != null)
            {
                <BreadcrumbItem>
                    @currentBook.Name
                </BreadcrumbItem>
            }
            <BreadcrumbItem>
                <Icon Type="edit" /> 章节编辑
            </BreadcrumbItem>
        </Breadcrumb>
    </div>

    <!-- 标题栏 -->
    <div style="margin-bottom: 16px;">
        <Title Level="2">
            <Icon Type="edit" style="margin-right: 8px; color: #1890ff;" />
            编纂书目: @(currentBook?.Name ?? "")
        </Title>
    </div>

    <!-- 工具栏 -->
    <div style="margin-bottom: 16px;">
        <Card Size="@CardSize.Small">
            <Space>
                <SpaceItem>
                    <Text>导出格式：</Text>
                </SpaceItem>
                <SpaceItem>
                    <Select TItemValue="string" TItem="string" @bind-Value="exportFormat" Style="width: 120px;">
                        <SelectOption TItemValue="string" TItem="string" Value="@("md")" Label="Markdown" />
                        <SelectOption TItemValue="string" TItem="string" Value="@("txt")" Label="文本" />
                    </Select>
                </SpaceItem>
                <SpaceItem>
                    <Button Type="@ButtonType.Primary" Icon="@IconType.Outline.Download" OnClick="ExportSelectedChapter"
                        Disabled="@(selectedChapter == null)">
                        导出选中章节
                    </Button>
                </SpaceItem>
                <SpaceItem>
                    <Button Type="@ButtonType.Default" Icon="@IconType.Outline.Download" OnClick="ExportAllChapters"
                        Disabled="@(chapters.Count == 0)">
                        导出全部章节
                    </Button>
                </SpaceItem>
                <SpaceItem>
                    <Button Type="@ButtonType.Default" Icon="@IconType.Outline.Download" OnClick="ExportFullBook"
                        Disabled="@(chapters.Count == 0)">
                        导出全书
                    </Button>
                </SpaceItem>
            </Space>
        </Card>
    </div>

    <!-- 主要内容区域 -->
    <Row Gutter="16" >
        <!-- 上半区域 -->
        <AntDesign.Col Span="24" Style="height: 460px;">
            <Row Gutter="16" Style="height: 100%;">
                <!-- 章节列表区域 -->
                <AntDesign.Col Span="6" Style="height: 100%;">
                    <ChapterListComponent BookId="@BookId" Chapters="@chapters" SelectedChapter="@selectedChapter"
                        OnSelectChapter="@SelectChapter" OnChapterAdded="HandleChapterAdded"
                        OnChapterUpdated="HandleChapterUpdated" OnDeleteChapter="@DeleteChapter"
                        OnChaptersReordered="@HandleChaptersReordered" />
                </AntDesign.Col>

                <!-- 章节内容区域 -->
                <AntDesign.Col Span="18" Style="height: 100%;">
                    <ChapterContentComponent SelectedChapter="@selectedChapter" @bind-Value="CurrentEditorValue" />
                </AntDesign.Col>
            </Row>
        </AntDesign.Col>

        <!-- 下半区域：聊天记录区域 -->
        <AntDesign.Col Span="24" Style="height: 80vh; margin-top: 16px;">
            <Row Gutter="16" Style="height: 100%;">
                <AntDesign.Col Span="6" Style="height: 100%; display: flex; flex-direction: column;">
                    <Card Size="@CardSize.Small" Style="margin-bottom: 16px;">
                        <Select TItem="string" TItemValue="string" DataSource="@_characterNames"
                            @bind-Value="@_selectedCharacter"
                            OnSelectedItemChanged="OnCharacterFilterChanged"
                            Placeholder="筛选角色"
                            Style="width: 100%;">
                        </Select>
                    </Card>
                    <ChatLogListComponent ChatLogs="@_filteredChatLogSummaries" SelectedChatLogId="@(currentChatLog?.Id ?? 0)"
                        OnSelectChatLog="@SelectChatLog" />
                </AntDesign.Col>
                <AntDesign.Col Span="18" Style="height: 100%;">
                    <ChatLogComponent BookId="@BookId" SelectedChapter="@selectedChapter"
                        CurrentChatLog="@currentChatLog" CurrentAnalysisResult="@currentAnalysisResult"
                        @bind-CurrentChatLogIndex="currentChatLogIndex" TotalChatLogs="@totalChatLogs"
                        OnPreviousChatLog="@PreviousChatLog" OnNextChatLog="@NextChatLog"
                        OnJumpToChatLog="@JumpToChatLog" OnInsertToChapter="@InsertToChapter"
                        OnNavigateTo="@(url => Navigation.NavigateTo(url))" />
                </AntDesign.Col>
            </Row>
        </AntDesign.Col>
    </Row>
</div>

<style>
    .compose-page {
        padding: 24px;
        overflow: hidden;
    }
</style>

@code {
    [Parameter] public int BookId { get; set; }

    private Book? currentBook;
    private List<BookChapter> chapters = new();
    private BookChapter? selectedChapter;
    private ChatLog? currentChatLog;
    private ChatLogAnalysisResult? currentAnalysisResult;
    private int currentChatLogIndex = 1;
    private int totalChatLogs = 0;
    private string exportFormat = "md";
    private string _currentEditorValue = string.Empty;
    private Timer? _debounceTimer;

    // Chat Log Filtering
    private List<(int ChatLogId, int Index, string Title, string Summary, string CharacterName)> _masterChatLogSummaries = new();
    private List<(int ChatLogId, int Index, string Title, string Summary)> _filteredChatLogSummaries = new();
    private List<string> _characterNames = new();
    private string _selectedCharacter = "全部角色";


    private string CurrentEditorValue
    {
        get => _currentEditorValue;
        set
        {
            if (_currentEditorValue != value)
            {
                _currentEditorValue = value;
                if (selectedChapter != null)
                {
                    selectedChapter.Content = value;
                    _debounceTimer?.Dispose();
                    _debounceTimer = new Timer(async _ =>
                    {
                        await InvokeAsync(SaveChapterContent);
                    }, null, TimeSpan.FromSeconds(1), Timeout.InfiniteTimeSpan);
                }
            }
        }
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadBookData();
        await LoadChapters();
        await LoadChatLogData();

        if (chapters.Any())
        {
            await SelectChapter(chapters.First());
        }
    }

    private async Task LoadBookData()
    {
        currentBook = await BookService.GetBookByIdAsync(BookId);
        if (currentBook == null)
        {
            Navigation.NavigateTo("/books");
        }
    }

    private async Task LoadChapters()
    {
        chapters = await BookChapterService.GetChaptersByBookIdAsync(BookId);
    }

    private async Task LoadChatLogData()
    {
        var allLogs = await ChatLogService.GetChatLogsWithFiltersAsync(BookId, pageSize: int.MaxValue);
        totalChatLogs = allLogs.Count;

        _masterChatLogSummaries.Clear();
        foreach (var log in allLogs)
        {
            var analysis = await AnalysisService.GetAnalysisResultAsync(log.Id);
            _masterChatLogSummaries.Add((log.Id, log.Index, analysis?.Title ?? "未分析", analysis?.Summary ?? "", log.Name));
        }

        _characterNames = _masterChatLogSummaries.Select(s => s.CharacterName).Distinct().ToList();
        _characterNames.Insert(0, "全部角色");

        ApplyCharacterFilter();

        if (totalChatLogs > 0 && currentChatLog == null)
        {
            await LoadCurrentChatLog();
        }
    }

    private void ApplyCharacterFilter()
    {
        var previouslySelectedLogId = currentChatLog?.Id ?? 0;

        var filtered = _masterChatLogSummaries;
        if (_selectedCharacter != "全部角色")
        {
            filtered = _masterChatLogSummaries.Where(s => s.CharacterName == _selectedCharacter).ToList();
        }

        _filteredChatLogSummaries = filtered.Select(s => (s.ChatLogId, s.Index, s.Title, s.Summary)).ToList();

        if (previouslySelectedLogId != 0 && !_filteredChatLogSummaries.Any(s => s.ChatLogId == previouslySelectedLogId))
        {
            if (_filteredChatLogSummaries.Any())
            {
                var originalMasterIndex = _masterChatLogSummaries.FindIndex(s => s.ChatLogId == previouslySelectedLogId);

                var visibleIds = _filteredChatLogSummaries.Select(s => s.ChatLogId).ToHashSet();

                var previous = _masterChatLogSummaries
                    .Take(originalMasterIndex)
                    .LastOrDefault(s => visibleIds.Contains(s.ChatLogId));

                if (previous != default)
                {
                    JumpToChatLog(previous.Index);
                }
                else
                {
                    var next = _masterChatLogSummaries
                        .Skip(originalMasterIndex + 1)
                        .FirstOrDefault(s => visibleIds.Contains(s.ChatLogId));

                    if (next != default)
                    {
                        JumpToChatLog(next.Index);
                    }
                }
            }
            else
            {
                currentChatLog = null;
                currentAnalysisResult = null;
            }
        }

        StateHasChanged();
    }

    private async Task OnCharacterFilterChanged(string value)
    {
        _selectedCharacter = value;
        ApplyCharacterFilter();
        await Task.CompletedTask;
    }


    private async Task LoadCurrentChatLog()
    {
        var chatLogs = await ChatLogService.GetChatLogsWithFiltersAsync(BookId, page: currentChatLogIndex, pageSize: 1);
        currentChatLog = chatLogs.FirstOrDefault() != null
            ? await ChatLogService.GetChatLogByIdAsync(chatLogs.First().Id)
            : null;

        if (currentChatLog != null)
        {
            currentAnalysisResult = await AnalysisService.GetAnalysisResultAsync(currentChatLog.Id);
        }
        else
        {
            currentAnalysisResult = null;
        }
        StateHasChanged();
    }

    private async Task SelectChapter(BookChapter chapter)
    {
        if (selectedChapter != null && selectedChapter.Id != chapter.Id)
        {
            await SaveChapterContent();
        }

        selectedChapter = chapter;
        CurrentEditorValue = chapter.Content ?? string.Empty;
        StateHasChanged();
    }

    private async Task SelectChatLog((int ChatLogId, int Index, string Title, string Summary) item)
    {
        await JumpToChatLog(item.Index);
    }

    private async Task SaveChapterContent()
    {
        if (selectedChapter != null)
        {
            await BookChapterService.UpdateChapterAsync(selectedChapter);
        }
    }

    private async Task HandleChapterAdded(BookChapter newChapter)
    {
        chapters.Add(newChapter);
        await SelectChapter(newChapter);
    }

    private Task HandleChapterUpdated(BookChapter updatedChapter)
    {
        StateHasChanged();
        return Task.CompletedTask;
    }

    private async Task HandleChaptersReordered()
    {
        // 保存当前选中章节的 ID
        var selectedChapterId = selectedChapter?.Id;

        // 重新加载章节列表以确保顺序正确
        await LoadChapters();

        // 如果之前有选中的章节，用新加载的实例替换
        // 这样可以避免 EF Core 的实体跟踪冲突
        if (selectedChapterId.HasValue)
        {
            selectedChapter = chapters.FirstOrDefault(c => c.Id == selectedChapterId.Value);
        }

        StateHasChanged();
    }

    private async Task DeleteChapter(BookChapter chapter)
    {
        await BookChapterService.DeleteChapterAsync(chapter.Id);
        chapters.Remove(chapter);

        if (selectedChapter?.Id == chapter.Id)
        {
            selectedChapter = null;
            CurrentEditorValue = string.Empty;
        }

        MessageService.Success("章节删除成功");
        StateHasChanged();
    }

    private async Task PreviousChatLog()
    {
        if (currentChatLog == null || !_filteredChatLogSummaries.Any()) return;

        var currentFilteredIndex = _filteredChatLogSummaries.FindIndex(s => s.ChatLogId == currentChatLog.Id);

        if (currentFilteredIndex > 0)
        {
            var previousLogSummary = _filteredChatLogSummaries[currentFilteredIndex - 1];
            await JumpToChatLog(previousLogSummary.Index);
        }
    }

    private async Task NextChatLog()
    {
        if (currentChatLog == null || !_filteredChatLogSummaries.Any()) return;

        var currentFilteredIndex = _filteredChatLogSummaries.FindIndex(s => s.ChatLogId == currentChatLog.Id);

        if (currentFilteredIndex != -1 && currentFilteredIndex < _filteredChatLogSummaries.Count - 1)
        {
            var nextLogSummary = _filteredChatLogSummaries[currentFilteredIndex + 1];
            await JumpToChatLog(nextLogSummary.Index);
        }
    }

    private async Task JumpToChatLog(int index)
    {
        if (index >= 1 && index <= totalChatLogs)
        {
            currentChatLogIndex = index;
            await LoadCurrentChatLog();
        }
    }

    private async Task InsertToChapter()
    {
        if (selectedChapter == null || currentAnalysisResult?.MainBody == null) return;

        var newContent = CurrentEditorValue;
        if (!string.IsNullOrEmpty(newContent) && !newContent.EndsWith("\n"))
        {
            newContent += "\n\n";
        }
        else if (!string.IsNullOrEmpty(newContent))
        {
            newContent += "\n";
        }

        newContent += currentAnalysisResult.MainBody;
        CurrentEditorValue = newContent;

        await SaveChapterContent();
        MessageService.Success($"已将楼层{currentChatLog?.Index}的内容插入到章节中");
        await NextChatLog();
    }

    private async Task ExportSelectedChapter()
    {
        if (selectedChapter == null || currentBook == null) return;

        var fileName = $"{currentBook.Name}-{selectedChapter.Order}-{selectedChapter.Title}.{exportFormat}";
        var content = $"# 第{selectedChapter.Order}章 {selectedChapter.Title}\n\n{CurrentEditorValue}";

        if (exportFormat == "txt")
        {
            content = ConvertMarkdownToText(content);
        }

        await DownloadFile(fileName, content);
    }

    private void ExportAllChapters()
    {
        if (chapters.Count == 0 || currentBook == null) return;

        MessageService.Info("导出全部章节功能需要进一步实现");
    }

    private async Task ExportFullBook()
    {
        if (chapters.Count == 0 || currentBook == null) return;

        var fileName = $"{currentBook.Name}.{exportFormat}";
        var content = string.Join("\n\n---\n\n", chapters.Select(c =>
            $"# 第{c.Order}章 {c.Title}\n\n{c.Content}"));

        if (exportFormat == "txt")
        {
            content = ConvertMarkdownToText(content);
        }

        await DownloadFile(fileName, content);
    }

    private string ConvertMarkdownToText(string markdown)
    {
        return markdown
            .Replace("# ", "")
            .Replace("## ", "")
            .Replace("### ", "")
            .Replace("**", "")
            .Replace("*", "")
            .Replace("---", "");
    }

    private async Task DownloadFile(string fileName, string content)
    {
        var bytes = System.Text.Encoding.UTF8.GetBytes(content);
        var base64 = Convert.ToBase64String(bytes);

        await JSRuntime.InvokeVoidAsync("downloadFile", fileName, base64);
    }

    public void Dispose()
    {
        _debounceTimer?.Dispose();
    }
}