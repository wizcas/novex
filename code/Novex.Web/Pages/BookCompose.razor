@page "/books/{BookId:int}/compose"
@using Novex.Data.Models
@using Novex.Data.Services
@using AntDesign
@using Novex.Web.Components
@inject IBookService BookService
@inject IBookChapterService BookChapterService
@inject IChatLogService ChatLogService
@inject IAnalysisService AnalysisService
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime
@inject IMessageService MessageService
@implements IDisposable

<PageTitle>ç¼–çº‚ä¹¦ç›® - @(currentBook?.Name ?? "åŠ è½½ä¸­...")</PageTitle>

<div class="compose-page">
    <!-- æ ‡é¢˜æ  -->
    <div style="margin-bottom: 16px;">
        <Row Justify="@RowJustify.SpaceBetween" Align="@RowAlign.Middle">
            <AntDesign.Col>
                <Title Level="2">
                    <Icon Type="edit" style="margin-right: 8px; color: #1890ff;" />
                    ç¼–çº‚ä¹¦ç›®: @(currentBook?.Name ?? "")
                </Title>
            </AntDesign.Col>
            <AntDesign.Col>
                <Button Type="@ButtonType.Default" Icon="@IconType.Outline.ArrowLeft"
                        OnClick="@(() => Navigation.NavigateTo("/books"))">
                    è¿”å›ä¹¦ç›®ç®¡ç†
                </Button>
            </AntDesign.Col>
        </Row>
    </div>

    <!-- å·¥å…·æ  -->
    <div style="margin-bottom: 16px;">
        <Card Size="@CardSize.Small">
            <Space>
                <SpaceItem>
                    <Text>å¯¼å‡ºæ ¼å¼ï¼š</Text>
                </SpaceItem>
                <SpaceItem>
                    <Select TItemValue="string" TItem="string" @bind-Value="exportFormat" Style="width: 120px;">
                        <SelectOption TItemValue="string" TItem="string" Value="@("md")" Label="Markdown"/>
                        <SelectOption TItemValue="string" TItem="string" Value="@("txt")" Label="æ–‡æœ¬"/>
                    </Select>
                </SpaceItem>
                <SpaceItem>
                    <Button Type="@ButtonType.Primary" Icon="@IconType.Outline.Download"
                            OnClick="ExportSelectedChapter" Disabled="@(selectedChapter == null)">
                        å¯¼å‡ºé€‰ä¸­ç« èŠ‚
                    </Button>
                </SpaceItem>
                <SpaceItem>
                    <Button Type="@ButtonType.Default" Icon="@IconType.Outline.Download"
                            OnClick="ExportAllChapters" Disabled="@(chapters.Count == 0)">
                        å¯¼å‡ºå…¨éƒ¨ç« èŠ‚
                    </Button>
                </SpaceItem>
                <SpaceItem>
                    <Button Type="@ButtonType.Default" Icon="@IconType.Outline.Download"
                            OnClick="ExportFullBook" Disabled="@(chapters.Count == 0)">
                        å¯¼å‡ºå…¨ä¹¦
                    </Button>
                </SpaceItem>
            </Space>
        </Card>
    </div>

    <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
    <Row Gutter="16" Style="height: calc(100vh - 240px);">
        <!-- ä¸ŠåŠåŒºåŸŸ -->
        <AntDesign.Col Span="24" Style="height: 60%;">
            <Row Gutter="16" Style="height: 100%;">
                <!-- ç« èŠ‚åˆ—è¡¨åŒºåŸŸ -->
                <AntDesign.Col Span="6" Style="height: 100%;">
                    <Card Title="ç« èŠ‚åˆ—è¡¨" Size="@CardSize.Small" Style="height: 100%;">
                        <Extra>
                            <Button Type="@ButtonType.Primary" Size="@ButtonSize.Small"
                                    Icon="@IconType.Outline.Plus" OnClick="ShowAddChapterModal">
                                æ–°å¢ç« èŠ‚
                            </Button>
                        </Extra>
                        <ChildContent>
                            <div style="height: calc(100% - 80px); overflow-y: auto;">
                                @if (chapters.Any())
                                {
                                    <div id="chapter-list">
                                        @foreach (var chapter in chapters)
                                        {
                                            <div class="chapter-item @(selectedChapter?.Id == chapter.Id ? "selected" : "")"
                                                 @onclick="@(() => SelectChapter(chapter))"
                                                 data-chapter-id="@chapter.Id">
                                                <div class="chapter-content">
                                                    <Text Strong="@(selectedChapter?.Id == chapter.Id)">
                                                        ç¬¬@(chapter.Order)ç«  @chapter.Title
                                                    </Text>
                                                    <div class="chapter-actions">
                                                        <Button Type="@ButtonType.Text" Size="@ButtonSize.Small"
                                                                Icon="@IconType.Outline.Edit"
                                                                OnClick="@(() => EditChapterTitle(chapter))"/>
                                                        <Button Type="@ButtonType.Text" Size="@ButtonSize.Small"
                                                                Icon="@IconType.Outline.Delete" Danger="true"
                                                                OnClick="@(() => DeleteChapter(chapter))"/>
                                                    </div>
                                                </div>
                                            </div>
                                        }
                                    </div>
                                }
                                else
                                {
                                    <Empty Description="@("æš‚æ— ç« èŠ‚")">
                                        <ChildContent>
                                            <Button Type="@ButtonType.Primary" OnClick="ShowAddChapterModal">
                                                åˆ›å»ºç¬¬ä¸€ä¸ªç« èŠ‚
                                            </Button>
                                        </ChildContent>
                                    </Empty>
                                }
                            </div>
                        </ChildContent>
                    </Card>
                </AntDesign.Col>

                <!-- ç« èŠ‚å†…å®¹åŒºåŸŸ -->
                <AntDesign.Col Span="18" Style="height: 100%;">
                    <Card Title="@(selectedChapter != null ? $"ç¬¬{selectedChapter.Order}ç«  {selectedChapter.Title}" : "ç« èŠ‚å†…å®¹")"
                          Size="@CardSize.Small" Style="height: 100%;">
                        <ChildContent>
                            @if (selectedChapter != null)
                            {
                                <CodeMirrorEditor @ref="editorObj"
                                                  @key="@($"editor-{selectedChapter.Id}")"
                                                  @bind-Value="currentEditorValue"
                                                  OnContentChanged="OnEditorContentChanged"
                                                  Style="height: 425px;"
                                                  LineNumbers="false" />
                            }
                            else
                            {
                                <div style="height: 100%; display: flex; align-items: center; justify-content: center;">
                                    <Text Type="@TextElementType.Secondary">è¯·é€‰æ‹©ä¸€ä¸ªç« èŠ‚å¼€å§‹ç¼–è¾‘</Text>
                                    <br/>
                                    <Text Type="@TextElementType.Secondary">ç« èŠ‚æ•°é‡: @chapters.Count</Text>
                                </div>
                            }
                        </ChildContent>
                    </Card>
                </AntDesign.Col>
            </Row>
        </AntDesign.Col>

        <!-- ä¸‹åŠåŒºåŸŸï¼šèŠå¤©è®°å½•åŒºåŸŸ -->
        <AntDesign.Col Span="24" Style="height: 40%; margin-top: 16px;">
            <Card Title="èŠå¤©è®°å½•" Size="@CardSize.Small" Style="height: 100%;">
                <Extra>
                    <Space>
                        <SpaceItem>
                            <AntDesign.InputNumber @bind-Value="currentChatLogIndex" Min="1" Max="@totalChatLogs"
                                         Style="width: 100px;" Placeholder="æ¥¼å±‚"/>
                        </SpaceItem>
                        <SpaceItem>
                            <Button OnClick="@(() => JumpToChatLog(currentChatLogIndex))">è·³è½¬</Button>
                        </SpaceItem>
                        <SpaceItem>
                            <Button Icon="@IconType.Outline.Left" OnClick="PreviousChatLog"
                                    Disabled="@(currentChatLogIndex <= 1)">ä¸Šä¸€æ¡</Button>
                        </SpaceItem>
                        <SpaceItem>
                            <Button Icon="@IconType.Outline.Right" OnClick="NextChatLog"
                                    Disabled="@(currentChatLogIndex >= totalChatLogs)">ä¸‹ä¸€æ¡</Button>
                        </SpaceItem>
                        <SpaceItem>
                            <Button Type="@ButtonType.Primary" Icon="@IconType.Outline.Plus"
                                    OnClick="InsertToChapter" Disabled="@(selectedChapter == null || currentChatLog == null)">
                                æ’å…¥åˆ°ç« èŠ‚
                            </Button>
                        </SpaceItem>
                    </Space>
                </Extra>
                <ChildContent>
                    @if (currentChatLog != null)
                    {
                        <div style="height: calc(100% - 80px); overflow-y: auto; padding: 16px;">
                            @if (!string.IsNullOrEmpty(currentAnalysisResult?.Title))
                            {
                                <div style="margin-bottom: 16px;">
                                    <Text Strong="true" Style="font-size: 16px; color: #1890ff;">ğŸ“ æ ‡é¢˜ï¼š</Text>
                                    <div style="background: #f6f8ff; padding: 12px; border-radius: 6px; margin-top: 6px; border-left: 4px solid #1890ff;">
                                        <Text Strong="true" Style="font-size: 15px; color: #1890ff;">@currentAnalysisResult.Title</Text>
                                    </div>
                                </div>
                            }

                            @if (!string.IsNullOrEmpty(currentAnalysisResult?.Summary))
                            {
                                <div style="margin-bottom: 16px;">
                                    <Text Strong="true" Style="font-size: 16px; color: #52c41a;">ğŸ“‹ æ‘˜è¦ï¼š</Text>
                                    <div style="background: #f6ffed; padding: 12px; border-radius: 6px; margin-top: 6px; border-left: 4px solid #52c41a;">
                                        <Text Style="font-size: 14px; line-height: 1.6;">@currentAnalysisResult.Summary</Text>
                                    </div>
                                </div>
                            }

                            @if (!string.IsNullOrEmpty(currentAnalysisResult?.MainBody))
                            {
                                <div style="margin-bottom: 16px;">
                                    <Text Strong="true" Style="font-size: 16px; color: #fa8c16;">ğŸ“„ æ­£æ–‡å†…å®¹ï¼š</Text>
                                    <div style="background: #fff7e6; padding: 12px; border-radius: 6px; margin-top: 6px; border-left: 4px solid #fa8c16; white-space: pre-wrap; overflow-y:auto; height: 130px;">
                                            <Text Style="font-size: 14px; line-height: 1.8;">@currentAnalysisResult.MainBody</Text>
                                    </div>
                                </div>
                            }

                            @if (currentAnalysisResult == null)
                            {
                                <div style="text-align: center; padding: 32px;">
                                    <Empty Description="@("è¯¥èŠå¤©è®°å½•å°šæœªåˆ†æ")">
                                        <ChildContent>
                                            <Button Type="@ButtonType.Primary"
                                                    OnClick="@(() => Navigation.NavigateTo($"/chatlogs/{BookId}/{currentChatLog.Id}/analyze"))">
                                                å‰å¾€åˆ†æ
                                            </Button>
                                        </ChildContent>
                                    </Empty>
                                </div>
                            }

                            <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid #f0f0f0;">
                                <Text Type="@TextElementType.Secondary" Style="font-size: 12px;">
                                    æ¥¼å±‚ @currentChatLog.Index | @currentChatLog.Name | @currentChatLog.SendDate.ToString("yyyy-MM-dd HH:mm:ss")
                                </Text>
                            </div>
                        </div>
                    }
                    else if (totalChatLogs == 0)
                    {
                        <div style="height: calc(100% - 80px); display: flex; align-items: center; justify-content: center;">
                            <Empty Description="@("è¯¥ä¹¦ç›®æš‚æ— èŠå¤©è®°å½•åˆ†æç»“æœã€‚\nè¯·å…ˆå¯¼å…¥å¹¶åˆ†æèŠå¤©è®°å½•ã€‚")">
                                <ChildContent>
                                    <Button Type="@ButtonType.Primary"
                                            OnClick="@(() => Navigation.NavigateTo($"/import/{BookId}"))">
                                        å¯¼å…¥èŠå¤©è®°å½•
                                    </Button>
                                </ChildContent>
                            </Empty>
                        </div>
                    }
                    else
                    {
                        <div style="height: calc(100% - 80px); display: flex; align-items: center; justify-content: center;">
                            <Spin Size="@SpinSize.Large"/>
                        </div>
                    }
                </ChildContent>
            </Card>
        </AntDesign.Col>
    </Row>
</div>

<!-- æ–°å¢ç« èŠ‚æ¨¡æ€æ¡† -->
<Modal Title="æ–°å¢ç« èŠ‚" @bind-Visible="showAddChapterModal" OnOk="AddChapter" OnCancel="@(() => showAddChapterModal = false)">
    <Form Model="@newChapterForm">
        <FormItem Label="ç« èŠ‚æ ‡é¢˜">
            <Input @bind-Value="newChapterForm.Title" Placeholder="è¯·è¾“å…¥ç« èŠ‚æ ‡é¢˜"/>
        </FormItem>
    </Form>
</Modal>

<!-- ç¼–è¾‘ç« èŠ‚æ ‡é¢˜æ¨¡æ€æ¡† -->
<Modal Title="ç¼–è¾‘ç« èŠ‚æ ‡é¢˜" @bind-Visible="showEditChapterModal" OnOk="UpdateChapterTitle" OnCancel="@(() => showEditChapterModal = false)">
    <Form Model="@editChapterForm">
        <FormItem Label="ç« èŠ‚æ ‡é¢˜">
            <Input @bind-Value="editChapterForm.Title" Placeholder="è¯·è¾“å…¥ç« èŠ‚æ ‡é¢˜"/>
        </FormItem>
    </Form>
</Modal>

<style>
.compose-page {
    padding: 24px;
    height: 100vh;
    overflow: hidden;
}

.chapter-item {
    padding: 8px 12px;
    margin-bottom: 4px;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.3s;
    border: 1px solid transparent;
}

.chapter-item:hover {
    background-color: #f5f5f5;
}

.chapter-item.selected {
    background-color: #e6f7ff;
    border-color: #1890ff;
}

.chapter-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.chapter-actions {
    opacity: 0;
    transition: opacity 0.3s;
}

.chapter-item:hover .chapter-actions {
    opacity: 1;
}
</style>

@code {
    [Parameter] public int BookId { get; set; }

    private Book? currentBook;
    private List<BookChapter> chapters = new();
    private BookChapter? selectedChapter;
    private CodeMirrorEditor? editorObj;
    private ChatLog? currentChatLog;
    private ChatLogAnalysisResult? currentAnalysisResult;
    private int currentChatLogIndex = 1;
    private int totalChatLogs = 0;
    private string exportFormat = "md";
    private string _currentEditorValue = string.Empty;
    private Timer? _debounceTimer;
    private string currentEditorValue
    {
        get => _currentEditorValue;
        set => _currentEditorValue = value;
    }



    // æ¨¡æ€æ¡†ç›¸å…³
    private bool showAddChapterModal = false;
    private bool showEditChapterModal = false;
    private NewChapterForm newChapterForm = new();
    private EditChapterForm editChapterForm = new();
    private BookChapter? editingChapter;

    public class NewChapterForm
    {
        public string Title { get; set; } = string.Empty;
    }

    public class EditChapterForm
    {
        public string Title { get; set; } = string.Empty;
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadBookData();
        await LoadChapters();
        await LoadChatLogData();

        // å¦‚æœæœ‰ç« èŠ‚ï¼Œè‡ªåŠ¨é€‰æ‹©ç¬¬ä¸€ä¸ª
        if (chapters.Any())
        {
            await SelectChapter(chapters.First());
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && selectedChapter != null && editorObj != null)
        {
            // åœ¨é¦–æ¬¡æ¸²æŸ“åå°è¯•è®¾ç½®å†…å®¹
            await Task.Delay(500);
            StateHasChanged();
        }
    }

    private async Task LoadBookData()
    {
        currentBook = await BookService.GetBookByIdAsync(BookId);
        if (currentBook == null)
        {
            Navigation.NavigateTo("/books");
        }
    }

    private async Task LoadChapters()
    {
        chapters = await BookChapterService.GetChaptersByBookIdAsync(BookId);
    }

    private async Task LoadChatLogData()
    {
        totalChatLogs = await ChatLogService.GetTotalCountWithFiltersAsync(BookId);
        if (totalChatLogs > 0)
        {
            await LoadCurrentChatLog();
        }
    }

    private async Task LoadCurrentChatLog()
    {
        var chatLogs = await ChatLogService.GetChatLogsWithFiltersAsync(BookId, page: currentChatLogIndex, pageSize: 1);
        currentChatLog = chatLogs.FirstOrDefault() != null
            ? await ChatLogService.GetChatLogByIdAsync(chatLogs.First().Id)
            : null;

        if (currentChatLog != null)
        {
            currentAnalysisResult = await AnalysisService.GetAnalysisResultAsync(currentChatLog.Id);
        }
        else
        {
            currentAnalysisResult = null;
        }
    }

    private async Task SelectChapter(BookChapter chapter)
    {
        // ä¿å­˜å½“å‰ç« èŠ‚çš„æ›´æ”¹
        if (selectedChapter != null && selectedChapter != chapter)
        {
            selectedChapter.Content = currentEditorValue;
            await SaveChapterContent();
        }

        selectedChapter = chapter;
        currentEditorValue = chapter.Content ?? string.Empty;

        // å…ˆè§¦å‘é‡æ–°æ¸²æŸ“
        StateHasChanged();

        // ç­‰å¾…ä¸€æ®µæ—¶é—´è®© Blazor å®Œæˆæ¸²æŸ“
        await Task.Delay(300);
    }

    private async Task SaveChapterContent()
    {
        if (selectedChapter != null)
        {
            await BookChapterService.UpdateChapterAsync(selectedChapter);
        }
    }

    private void OnEditorContentChanged(string newValue)
    {
        if (selectedChapter != null)
        {
            // æ›´æ–°ç« èŠ‚å†…å®¹
            selectedChapter.Content = newValue;

            // é‡ç½®é˜²æŠ–è®¡æ—¶å™¨
            _debounceTimer?.Dispose();
            _debounceTimer = new Timer(async _ =>
            {
                try
                {
                    await InvokeAsync(async () =>
                    {
                        await SaveChapterContent();
                        StateHasChanged();
                    });
                }
                catch
                {
                    // é™é»˜å¤„ç†ä¿å­˜é”™è¯¯
                }
            }, null, TimeSpan.FromSeconds(1), Timeout.InfiniteTimeSpan);
        }
    }





    private void ShowAddChapterModal()
    {
        newChapterForm = new NewChapterForm();
        showAddChapterModal = true;
    }

    private async Task AddChapter()
    {
        if (string.IsNullOrWhiteSpace(newChapterForm.Title))
        {
            MessageService.Error("è¯·è¾“å…¥ç« èŠ‚æ ‡é¢˜");
            return;
        }

        var nextOrder = await BookChapterService.GetNextOrderAsync(BookId);
        var newChapter = await BookChapterService.CreateChapterAsync(BookId, newChapterForm.Title, nextOrder);

        chapters.Add(newChapter);
        selectedChapter = newChapter;
        showAddChapterModal = false;

        MessageService.Success("ç« èŠ‚åˆ›å»ºæˆåŠŸ");
        StateHasChanged();
    }

    private void EditChapterTitle(BookChapter chapter)
    {
        editingChapter = chapter;
        editChapterForm = new EditChapterForm { Title = chapter.Title };
        showEditChapterModal = true;
    }

    private async Task UpdateChapterTitle()
    {
        if (editingChapter == null || string.IsNullOrWhiteSpace(editChapterForm.Title))
        {
            MessageService.Error("è¯·è¾“å…¥ç« èŠ‚æ ‡é¢˜");
            return;
        }

        editingChapter.Title = editChapterForm.Title;
        await BookChapterService.UpdateChapterAsync(editingChapter);

        showEditChapterModal = false;
        MessageService.Success("ç« èŠ‚æ ‡é¢˜æ›´æ–°æˆåŠŸ");
        StateHasChanged();
    }

    private async Task DeleteChapter(BookChapter chapter)
    {
        var confirmed = await JSRuntime.InvokeAsync<bool>("confirm", $"ç¡®å®šè¦åˆ é™¤ç« èŠ‚\"{chapter.Title}\"å—ï¼Ÿ");
        if (!confirmed) return;

        await BookChapterService.DeleteChapterAsync(chapter.Id);
        chapters.Remove(chapter);

        if (selectedChapter?.Id == chapter.Id)
        {
            selectedChapter = null;
        }

        MessageService.Success("ç« èŠ‚åˆ é™¤æˆåŠŸ");
        StateHasChanged();
    }

    private async Task PreviousChatLog()
    {
        if (currentChatLogIndex > 1)
        {
            currentChatLogIndex--;
            await LoadCurrentChatLog();
        }
    }

    private async Task NextChatLog()
    {
        if (currentChatLogIndex < totalChatLogs)
        {
            currentChatLogIndex++;
            await LoadCurrentChatLog();
        }
    }

    private async Task JumpToChatLog(int index)
    {
        if (index >= 1 && index <= totalChatLogs)
        {
            currentChatLogIndex = index;
            await LoadCurrentChatLog();
        }
    }

    private async Task InsertToChapter()
    {
        if (selectedChapter == null || currentAnalysisResult?.MainBody == null) return;

        // åœ¨ç« èŠ‚å†…å®¹æœ«å°¾æ·»åŠ æ–°è¡Œå¹¶æ’å…¥æ­£æ–‡å†…å®¹
        var newContent = currentEditorValue;
        if (!string.IsNullOrEmpty(newContent) && !newContent.EndsWith("\n"))
        {
            newContent += "\n\n";
        }
        else if (!string.IsNullOrEmpty(newContent))
        {
            newContent += "\n";
        }

        newContent += currentAnalysisResult.MainBody;
        currentEditorValue = newContent;
        selectedChapter.Content = newContent;

        await BookChapterService.UpdateChapterAsync(selectedChapter);
        MessageService.Success($"å·²å°†æ¥¼å±‚{currentChatLog?.Index}çš„å†…å®¹æ’å…¥åˆ°ç« èŠ‚ä¸­");
        StateHasChanged();
    }

    private async Task ExportSelectedChapter()
    {
        if (selectedChapter == null || currentBook == null) return;

        var fileName = $"{currentBook.Name}-{selectedChapter.Order}-{selectedChapter.Title}.{exportFormat}";
        var content = $"# ç¬¬{selectedChapter.Order}ç«  {selectedChapter.Title}\n\n{selectedChapter.Content}";

        if (exportFormat == "txt")
        {
            content = ConvertMarkdownToText(content);
        }

        await DownloadFile(fileName, content);
    }

    private void ExportAllChapters()
    {
        if (chapters.Count == 0 || currentBook == null) return;

        // åˆ›å»ºZIPæ–‡ä»¶é€»è¾‘éœ€è¦é¢å¤–çš„NuGetåŒ…ï¼Œè¿™é‡Œå…ˆç®€åŒ–ä¸ºå•ä¸ªæ–‡ä»¶
        MessageService.Info("å¯¼å‡ºå…¨éƒ¨ç« èŠ‚åŠŸèƒ½éœ€è¦è¿›ä¸€æ­¥å®ç°");
    }

    private async Task ExportFullBook()
    {
        if (chapters.Count == 0 || currentBook == null) return;

        var fileName = $"{currentBook.Name}.{exportFormat}";
        var content = string.Join("\n\n---\n\n", chapters.Select(c =>
            $"# ç¬¬{c.Order}ç«  {c.Title}\n\n{c.Content}"));

        if (exportFormat == "txt")
        {
            content = ConvertMarkdownToText(content);
        }

        await DownloadFile(fileName, content);
    }

    private string ConvertMarkdownToText(string markdown)
    {
        // ç®€å•çš„Markdownåˆ°æ–‡æœ¬è½¬æ¢ï¼Œå¯ä»¥ä½¿ç”¨æ›´ä¸“ä¸šçš„åº“
        return markdown
            .Replace("# ", "")
            .Replace("## ", "")
            .Replace("### ", "")
            .Replace("**", "")
            .Replace("*", "")
            .Replace("---", "");
    }

    private async Task DownloadFile(string fileName, string content)
    {
        var bytes = System.Text.Encoding.UTF8.GetBytes(content);
        var base64 = Convert.ToBase64String(bytes);

        await JSRuntime.InvokeVoidAsync("downloadFile", fileName, base64);
    }

    public void Dispose()
    {
        _debounceTimer?.Dispose();
    }
}