@page "/books/{BookId:int}/compose"
@using Novex.Data.Models
@using Novex.Data.Services
@using AntDesign
@using Novex.Web.Components
@inject IBookService BookService
@inject IBookChapterService BookChapterService
@inject IChatLogService ChatLogService
@inject IAnalysisService AnalysisService
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime
@inject IMessageService MessageService
@implements IDisposable

<PageTitle>编纂书目 - @(currentBook?.Name ?? "加载中...")</PageTitle>

<div class="compose-page">
    <!-- 标题栏 -->
    <div style="margin-bottom: 16px;">
        <Row Justify="@RowJustify.SpaceBetween" Align="@RowAlign.Middle">
            <AntDesign.Col>
                <Title Level="2">
                    <Icon Type="edit" style="margin-right: 8px; color: #1890ff;" />
                    编纂书目: @(currentBook?.Name ?? "")
                </Title>
            </AntDesign.Col>
            <AntDesign.Col>
                <Button Type="@ButtonType.Default" Icon="@IconType.Outline.ArrowLeft"
                        OnClick="@(() => Navigation.NavigateTo("/books"))">
                    返回书目管理
                </Button>
            </AntDesign.Col>
        </Row>
    </div>

    <!-- 工具栏 -->
    <div style="margin-bottom: 16px;">
        <Card Size="@CardSize.Small">
            <Space>
                <SpaceItem>
                    <Text>导出格式：</Text>
                </SpaceItem>
                <SpaceItem>
                    <Select TItemValue="string" TItem="string" @bind-Value="exportFormat" Style="width: 120px;">
                        <SelectOption TItemValue="string" TItem="string" Value="@("md")" Label="Markdown"/>
                        <SelectOption TItemValue="string" TItem="string" Value="@("txt")" Label="文本"/>
                    </Select>
                </SpaceItem>
                <SpaceItem>
                    <Button Type="@ButtonType.Primary" Icon="@IconType.Outline.Download"
                            OnClick="ExportSelectedChapter" Disabled="@(selectedChapter == null)">
                        导出选中章节
                    </Button>
                </SpaceItem>
                <SpaceItem>
                    <Button Type="@ButtonType.Default" Icon="@IconType.Outline.Download"
                            OnClick="ExportAllChapters" Disabled="@(chapters.Count == 0)">
                        导出全部章节
                    </Button>
                </SpaceItem>
                <SpaceItem>
                    <Button Type="@ButtonType.Default" Icon="@IconType.Outline.Download"
                            OnClick="ExportFullBook" Disabled="@(chapters.Count == 0)">
                        导出全书
                    </Button>
                </SpaceItem>
            </Space>
        </Card>
    </div>

    <!-- 主要内容区域 -->
    <Row Gutter="16" Style="height: calc(100vh - 240px);">
        <!-- 上半区域 -->
        <AntDesign.Col Span="24" Style="height: 60%;">
            <Row Gutter="16" Style="height: 100%;">
                <!-- 章节列表区域 -->
                <AntDesign.Col Span="6" Style="height: 100%;">
                    <ChapterListComponent Chapters="@chapters"
                                          SelectedChapter="@selectedChapter"
                                          OnSelectChapter="@SelectChapter"
                                          OnAddChapter="@ShowAddChapterModal"
                                          OnEditChapter="@EditChapterTitle"
                                          OnDeleteChapter="@DeleteChapter" />
                </AntDesign.Col>

                <!-- 章节内容区域 -->
                <AntDesign.Col Span="18" Style="height: 100%;">
                    <ChapterContentComponent SelectedChapter="@selectedChapter"
                                             @bind-Value="CurrentEditorValue" />
                </AntDesign.Col>
            </Row>
        </AntDesign.Col>

        <!-- 下半区域：聊天记录区域 -->
        <AntDesign.Col Span="24" Style="height: 40%; margin-top: 16px;">
            <Row Gutter="16" Style="height: 100%;">
                <AntDesign.Col Span="6" Style="height: 100%;">
                    <ChatLogListComponent ChatLogs="@chatLogSummaries"
                                          SelectedChatLogId="@(currentChatLog?.Id ?? 0)"
                                          OnSelectChatLog="@SelectChatLog" />
                </AntDesign.Col>
                <AntDesign.Col Span="18" Style="height: 100%;">
                    <ChatLogComponent BookId="@BookId"
                                      SelectedChapter="@selectedChapter"
                                      CurrentChatLog="@currentChatLog"
                                      CurrentAnalysisResult="@currentAnalysisResult"
                                      @bind-CurrentChatLogIndex="currentChatLogIndex"
                                      TotalChatLogs="@totalChatLogs"
                                      OnPreviousChatLog="@PreviousChatLog"
                                      OnNextChatLog="@NextChatLog"
                                      OnJumpToChatLog="@JumpToChatLog"
                                      OnInsertToChapter="@InsertToChapter"
                                      OnNavigateTo="@(url => Navigation.NavigateTo(url))" />
                </AntDesign.Col>
            </Row>
        </AntDesign.Col>
    </Row>
</div>

<!-- 新增章节模态框 -->
<Modal Title="新增章节" @bind-Visible="showAddChapterModal" OnOk="AddChapter" OnCancel="@(() => showAddChapterModal = false)">
    <Form Model="@newChapterForm">
        <FormItem Label="章节标题">
            <Input @bind-Value="newChapterForm.Title" Placeholder="请输入章节标题"/>
        </FormItem>
    </Form>
</Modal>

<!-- 编辑章节标题模态框 -->
<Modal Title="编辑章节标题" @bind-Visible="showEditChapterModal" OnOk="UpdateChapterTitle" OnCancel="@(() => showEditChapterModal = false)">
    <Form Model="@editChapterForm">
        <FormItem Label="章节标题">
            <Input @bind-Value="editChapterForm.Title" Placeholder="请输入章节标题"/>
        </FormItem>
    </Form>
</Modal>

<style>
.compose-page {
    padding: 24px;
    height: 100vh;
    overflow: hidden;
}
</style>

@code {
    [Parameter] public int BookId { get; set; }

    private Book? currentBook;
    private List<BookChapter> chapters = new();
    private BookChapter? selectedChapter;
    private ChatLog? currentChatLog;
    private ChatLogAnalysisResult? currentAnalysisResult;
    private int currentChatLogIndex = 1;
    private int totalChatLogs = 0;
    private string exportFormat = "md";
    private string _currentEditorValue = string.Empty;
    private Timer? _debounceTimer;
    private List<(int ChatLogId, int Index, string Title, string Summary)> chatLogSummaries = new();

    private string CurrentEditorValue
    {
        get => _currentEditorValue;
        set
        {
            if (_currentEditorValue != value)
            {
                _currentEditorValue = value;
                if (selectedChapter != null)
                {
                    selectedChapter.Content = value;
                    _debounceTimer?.Dispose();
                    _debounceTimer = new Timer(async _ =>
                    {
                        await InvokeAsync(SaveChapterContent);
                    }, null, TimeSpan.FromSeconds(1), Timeout.InfiniteTimeSpan);
                }
            }
        }
    }

    // 模态框相关
    private bool showAddChapterModal = false;
    private bool showEditChapterModal = false;
    private NewChapterForm newChapterForm = new();
    private EditChapterForm editChapterForm = new();
    private BookChapter? editingChapter;

    public class NewChapterForm
    {
        public string Title { get; set; } = string.Empty;
    }

    public class EditChapterForm
    {
        public string Title { get; set; } = string.Empty;
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadBookData();
        await LoadChapters();
        await LoadChatLogData();

        if (chapters.Any())
        {
            await SelectChapter(chapters.First());
        }
    }

    private async Task LoadBookData()
    {
        currentBook = await BookService.GetBookByIdAsync(BookId);
        if (currentBook == null)
        {
            Navigation.NavigateTo("/books");
        }
    }

    private async Task LoadChapters()
    {
        chapters = await BookChapterService.GetChaptersByBookIdAsync(BookId);
    }

    private async Task LoadChatLogData()
    {
        var allLogs = await ChatLogService.GetChatLogsWithFiltersAsync(BookId, pageSize: int.MaxValue);
        totalChatLogs = allLogs.Count;

        foreach (var log in allLogs)
        {
            var analysis = await AnalysisService.GetAnalysisResultAsync(log.Id);
            chatLogSummaries.Add((log.Id, log.Index, analysis?.Title ?? "未分析", analysis?.Summary ?? ""));
        }

        if (totalChatLogs > 0)
        {
            await LoadCurrentChatLog();
        }
    }

    private async Task LoadCurrentChatLog()
    {
        var chatLogs = await ChatLogService.GetChatLogsWithFiltersAsync(BookId, page: currentChatLogIndex, pageSize: 1);
        currentChatLog = chatLogs.FirstOrDefault() != null
            ? await ChatLogService.GetChatLogByIdAsync(chatLogs.First().Id)
            : null;

        if (currentChatLog != null)
        {
            currentAnalysisResult = await AnalysisService.GetAnalysisResultAsync(currentChatLog.Id);
        }
        else
        {
            currentAnalysisResult = null;
        }
        StateHasChanged();
    }

    private async Task SelectChapter(BookChapter chapter)
    {
        if (selectedChapter != null && selectedChapter.Id != chapter.Id)
        {
            await SaveChapterContent();
        }

        selectedChapter = chapter;
        CurrentEditorValue = chapter.Content ?? string.Empty;
        StateHasChanged();
    }

    private async Task SelectChatLog((int ChatLogId, int Index, string Title, string Summary) item)
    {
        await JumpToChatLog(item.Index);
    }

    private async Task SaveChapterContent()
    {
        if (selectedChapter != null)
        {
            await BookChapterService.UpdateChapterAsync(selectedChapter);
        }
    }

    private void ShowAddChapterModal()
    {
        newChapterForm = new NewChapterForm();
        showAddChapterModal = true;
    }

    private async Task AddChapter()
    {
        if (string.IsNullOrWhiteSpace(newChapterForm.Title))
        {
            MessageService.Error("请输入章节标题");
            return;
        }

        var nextOrder = await BookChapterService.GetNextOrderAsync(BookId);
        var newChapter = await BookChapterService.CreateChapterAsync(BookId, newChapterForm.Title, nextOrder);

        chapters.Add(newChapter);
        await SelectChapter(newChapter);
        showAddChapterModal = false;

        MessageService.Success("章节创建成功");
    }

    private void EditChapterTitle(BookChapter chapter)
    {
        editingChapter = chapter;
        editChapterForm = new EditChapterForm { Title = chapter.Title };
        showEditChapterModal = true;
    }

    private async Task UpdateChapterTitle()
    {
        if (editingChapter == null || string.IsNullOrWhiteSpace(editChapterForm.Title))
        {
            MessageService.Error("请输入章节标题");
            return;
        }

        editingChapter.Title = editChapterForm.Title;
        await BookChapterService.UpdateChapterAsync(editingChapter);

        showEditChapterModal = false;
        MessageService.Success("章节标题更新成功");
        StateHasChanged();
    }

    private async Task DeleteChapter(BookChapter chapter)
    {
        var confirmed = await JSRuntime.InvokeAsync<bool>("confirm", $"确定要删除章节\"{chapter.Title}\"吗？");
        if (!confirmed) return;

        await BookChapterService.DeleteChapterAsync(chapter.Id);
        chapters.Remove(chapter);

        if (selectedChapter?.Id == chapter.Id)
        {
            selectedChapter = null;
            CurrentEditorValue = string.Empty;
        }

        MessageService.Success("章节删除成功");
        StateHasChanged();
    }

    private async Task PreviousChatLog()
    {
        if (currentChatLogIndex > 1)
        {
            currentChatLogIndex--;
            await LoadCurrentChatLog();
        }
    }

    private async Task NextChatLog()
    {
        if (currentChatLogIndex < totalChatLogs)
        {
            currentChatLogIndex++;
            await LoadCurrentChatLog();
        }
    }

    private async Task JumpToChatLog(int index)
    {
        if (index >= 1 && index <= totalChatLogs)
        {
            currentChatLogIndex = index;
            await LoadCurrentChatLog();
        }
    }

    private async Task InsertToChapter()
    {
        if (selectedChapter == null || currentAnalysisResult?.MainBody == null) return;

        var newContent = CurrentEditorValue;
        if (!string.IsNullOrEmpty(newContent) && !newContent.EndsWith("\n"))
        {
            newContent += "\n\n";
        }
        else if (!string.IsNullOrEmpty(newContent))
        {
            newContent += "\n";
        }

        newContent += currentAnalysisResult.MainBody;
        CurrentEditorValue = newContent;

        await SaveChapterContent();
        MessageService.Success($"已将楼层{currentChatLog?.Index}的内容插入到章节中");
        StateHasChanged();
    }

    private async Task ExportSelectedChapter()
    {
        if (selectedChapter == null || currentBook == null) return;

        var fileName = $"{currentBook.Name}-{selectedChapter.Order}-{selectedChapter.Title}.{exportFormat}";
        var content = $"# 第{selectedChapter.Order}章 {selectedChapter.Title}\n\n{CurrentEditorValue}";

        if (exportFormat == "txt")
        {
            content = ConvertMarkdownToText(content);
        }

        await DownloadFile(fileName, content);
    }

    private void ExportAllChapters()
    {
        if (chapters.Count == 0 || currentBook == null) return;

        MessageService.Info("导出全部章节功能需要进一步实现");
    }

    private async Task ExportFullBook()
    {
        if (chapters.Count == 0 || currentBook == null) return;

        var fileName = $"{currentBook.Name}.{exportFormat}";
        var content = string.Join("\n\n---\n\n", chapters.Select(c =>
            $"# 第{c.Order}章 {c.Title}\n\n{c.Content}"));

        if (exportFormat == "txt")
        {
            content = ConvertMarkdownToText(content);
        }

        await DownloadFile(fileName, content);
    }

    private string ConvertMarkdownToText(string markdown)
    {
        return markdown
            .Replace("# ", "")
            .Replace("## ", "")
            .Replace("### ", "")
            .Replace("**", "")
            .Replace("*", "")
            .Replace("---", "");
    }

    private async Task DownloadFile(string fileName, string content)
    {
        var bytes = System.Text.Encoding.UTF8.GetBytes(content);
        var base64 = Convert.ToBase64String(bytes);

        await JSRuntime.InvokeVoidAsync("downloadFile", fileName, base64);
    }

    public void Dispose()
    {
        _debounceTimer?.Dispose();
    }
}