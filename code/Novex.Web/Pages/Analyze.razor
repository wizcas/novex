@page "/chatlogs/{bookId:int}/{chatLogId:int}/analyze"
@using Novex.Data.Models
@using Novex.Data.Services
@using Novex.Analyzer
@using Novex.Analyzer.Models
@using Novex.Web.Shared.Components
@using Novex.Web.Components
@using Novex.Web.Services
@inject IChatLogService ChatLogService
@inject IAnalysisService AnalysisService
@inject IBookService BookService
@inject AnalysisRuleBookService RuleBookService
@inject NavigationManager Navigation
@inject IMessageService MessageService
@inject V2RuleEngineService V2RuleEngine

<div style="margin-bottom: 16px;">
  <Breadcrumb>
    <BreadcrumbItem Href="/">
      <Icon Type="home" /> 首页
    </BreadcrumbItem>
    <BreadcrumbItem Href="/books">
      <Icon Type="book" /> 书目管理
    </BreadcrumbItem>
    @if (!string.IsNullOrEmpty(bookName))
    {
      <BreadcrumbItem>
        @bookName
      </BreadcrumbItem>
    }
    <BreadcrumbItem Href="@($"/chatlogs/{BookId}")">
      <Icon Type="message" /> 聊天记录
    </BreadcrumbItem>
    @if (chatLog != null)
    {
      <BreadcrumbItem Href="@($"/chatlogs/{BookId}/{ChatLogId}")">
        第 @chatLog.Index 楼
      </BreadcrumbItem>
    }
    <BreadcrumbItem>
      <Icon Type="bar-chart" /> 分析
    </BreadcrumbItem>
  </Breadcrumb>
</div>

<div style="margin-bottom: 16px;">
  <h3 style="margin: 0;">
    分析对话记录
    @if (!string.IsNullOrEmpty(bookName))
    {
      <span style="font-size: 16px; font-weight: normal; margin-left: 8px; color: #666;">
        - @bookName
      </span>
    }
  </h3>
</div>

<div class="analyze-container">
  @if (chatLog != null)
  {
    <div style="margin-bottom: 16px; display: flex; justify-content: space-between; align-items: center;">
      <Button Type="@ButtonType.Link" OnClick="@GoBack">
        <Icon Type="arrow-left" /> 返回对话记录
      </Button>

      <Space Size="@SpaceSize.Large">
        <SpaceItem>
          <Space>
            <SpaceItem>
              <Button Type="@ButtonType.Default" Size="@ButtonSize.Small" OnClick="@GoPrevious"
                Disabled="@(!hasPrevious || isNavigating)" Loading="@isNavigating">
                <Icon Type="left" /> 上一条
              </Button>
            </SpaceItem>
            <SpaceItem>
              <Button Type="@ButtonType.Default" Size="@ButtonSize.Small" OnClick="@GoNext"
                Disabled="@(!hasNext || isNavigating)" Loading="@isNavigating">
                下一条
                <Icon Type="right" />
              </Button>
            </SpaceItem>
          </Space>
        </SpaceItem>
        <SpaceItem>
          <FloorJumpSelector BookId="@BookId"
                            CurrentFloor="@(chatLog?.Index ?? 0)"
                            MinFloor="@minFloor"
                            MaxFloor="@maxFloor"
                            ShowCurrentFloor="true"
                            Mode="@FloorJumpSelector.JumpMode.ChatLogId"
                            OnJump="@JumpToFloor" />
        </SpaceItem>
        <SpaceItem>
          <Button Type="@ButtonType.Dashed" Size="@ButtonSize.Small" OnClick="@(() => showBatchAnalysisModal = true)">
            <Icon Type="experiment" /> 批量分析
          </Button>
        </SpaceItem>
      </Space>
    </div>

    <Row Gutter="16">
      <AntDesign.Col Span="12">
        <ChatLogViewer ChatLog="@chatLog"
                       Title="原文内容"
                       ShowExtra="true"
                       ContentMaxHeight="600px"
                       @bind-ViewMode="_viewMode" />
      </AntDesign.Col>

      <AntDesign.Col Span="12">
        <Card Title="分析结果" Bordered="true">
          <Form Model="@analysisResult" LabelCol="new ColLayoutParam { Span = 4 }"
            WrapperCol="new ColLayoutParam { Span = 20 }">
            <FormItem Label="标题">
              <Input @bind-Value="@analysisResult.Title" Placeholder="请输入分析标题" MaxLength="200" />
            </FormItem>

            <FormItem Label="摘要">
              <TextArea @bind-Value="@analysisResult.Summary" Placeholder="请输入摘要内容" Rows="4" ShowCount="true"
                MaxLength="500" />
            </FormItem>

            <FormItem Label="正文">
              <TextArea @bind-Value="@analysisResult.MainBody" Placeholder="请输入正文内容" Rows="8" ShowCount="true" />
            </FormItem>

            <FormItem WrapperCol="new ColLayoutParam { Offset = 4, Span = 20 }">
              <Space>
                <SpaceItem>
                  <Button Type="@ButtonType.Primary" OnClick="@AnalyzeContent" Loading="@isAnalyzing">
                    <Icon Type="experiment" /> 分析
                  </Button>
                </SpaceItem>
                <SpaceItem>
                  <Button Type="@ButtonType.Default" OnClick="@SaveAnalysis" Loading="@isSaving">
                    <Icon Type="save" /> 保存
                  </Button>
                </SpaceItem>
                <SpaceItem>
                  <Button Type="@ButtonType.Dashed" OnClick="@ClearAnalysis">
                    <Icon Type="clear" /> 清空
                  </Button>
                </SpaceItem>
              </Space>
            </FormItem>
          </Form>
        </Card>

        <Card Title="规则书" Bordered="true" style="margin-top: 16px;">
          <RuleBookSelector SelectedRuleBookId="selectedRuleBookId"
            SelectedRuleBookIdChanged="OnSelectedRuleBookIdChanged" OnRuleBookSelected="OnRuleBookSelectionChanged"
            Label="选择规则书" Placeholder="请选择分析规则书" ShowDescription="true" ShowManageLink="true" UseFormItem="false" />

          @if (selectedRuleBook == null)
          {
            <div style="color: #666; font-style: italic; margin-top: 16px;">
              <p>当前使用默认分析引擎：</p>
              <ul>
                <li>标题：提取消息前50个字符</li>
                <li>摘要：根据内容长度和复杂度生成</li>
                <li>正文：生成详细分析报告</li>
              </ul>
              <p style="margin-top: 8px; font-size: 12px;">
                <Icon Type="experiment" /> 支持长度分析、情感分析、关键词分析等多种规则
              </p>
            </div>
          }
        </Card>
      </AntDesign.Col>
    </Row>
  }
  else if (isLoading)
  {
    <div style="text-align: center; padding: 50px;">
      <Spin Size="@SpinSize.Large" />
      <div style="margin-top: 16px;">加载中...</div>
    </div>
  }
  else
  {
    <Result Status="@ResultStatus.Error" Title="404" SubTitle="对话记录不存在">
      <Extra>
        <Button Type="@ButtonType.Primary" OnClick="@GoBack">返回</Button>
      </Extra>
    </Result>
  }

  <!-- 批量分析模态框 -->
  <BatchAnalysisModal IsVisible="@showBatchAnalysisModal"
                      IsVisibleChanged="@((visible) => showBatchAnalysisModal = visible)"
                      OnCancel="@(() => showBatchAnalysisModal = false)"
                      OnCompleted="OnBatchAnalysisCompleted"
                      BookId="@BookId" />
</div>

<style>
  .analyze-container {
    padding: 16px;
  }

  .original-content {
    @* height: 600px;
    max-height: 800px; *@
    height:fit-content;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
  }

  .chat-info {
    background: #f5f5f5;
    padding: 12px;
    border-radius: 4px;
    margin-bottom: 12px;
    line-height: 1.6;
  }

  .chat-message {
    line-height: 1.8;
    white-space: pre-wrap;
    word-wrap: break-word;
  }
</style>

@code {
  [Parameter] public int BookId { get; set; }
  [Parameter] public int ChatLogId { get; set; }

  private string _viewMode = "source";
  private ChatLog? chatLog;
  private ChatLogAnalysisResult analysisResult = new();
  private bool isLoading = true;
  private bool isAnalyzing = false;
  private bool isSaving = false;
  private bool isNavigating = false;
  private bool hasPrevious = false;
  private bool hasNext = false;
  private string bookName = "";
  private readonly ChatLogAnalyzer _analyzer = new();

  // 规则书相关变量
  private int? selectedRuleBookId;
  private ChatLogAnalysisRuleBook? selectedRuleBook;

  // 批量分析相关变量
  private bool showBatchAnalysisModal = false;

  // 楼层范围
  private int minFloor = 0;
  private int maxFloor = 100;

  protected override async Task OnInitializedAsync()
  {
    await LoadData();
  }

  protected override async Task OnParametersSetAsync()
  {
    // 当路由参数改变时重新加载数据
    await LoadData();
  }

  private async Task LoadData()
  {
    try
    {
      isLoading = true;
      StateHasChanged();

      chatLog = await ChatLogService.GetChatLogByIdAsync(ChatLogId);
      if (chatLog == null || chatLog.BookId != BookId)
      {
        return;
      }

      // 获取书名
      var book = await BookService.GetBookByIdAsync(BookId);
      bookName = book?.Name ?? "";

      // 尝试加载现有的分析结果
      var existingAnalysis = await AnalysisService.GetAnalysisResultAsync(ChatLogId);
      if (existingAnalysis != null)
      {
        analysisResult = existingAnalysis;
      }
      else
      {
        // 初始化空的分析结果
        analysisResult = new ChatLogAnalysisResult
        {
          ChatLogId = ChatLogId,
          Title = "",
          Summary = "",
          MainBody = ""
        };
      }

      // 检查上一条和下一条记录的存在性
      var previousId = await ChatLogService.GetPreviousChatLogIdAsync(ChatLogId);
      var nextId = await ChatLogService.GetNextChatLogIdAsync(ChatLogId);
      hasPrevious = previousId.HasValue;
      hasNext = nextId.HasValue;

      // 加载楼层范围
      var range = await ChatLogService.GetIndexRangeAsync(BookId);
      minFloor = range.MinIndex;
      maxFloor = range.MaxIndex;

    }
    catch (Exception ex)
    {
      Console.WriteLine($"加载数据时出错: {ex.Message}");
      await MessageService.ErrorAsync($"加载数据失败：{ex.Message}");
    }
    finally
    {
      isLoading = false;
      StateHasChanged();
    }
  }

  private async Task AnalyzeContent()
  {
    if (chatLog == null) return;

    try
    {
      isAnalyzing = true;
      StateHasChanged();

      ChatLogAnalysisResult result;

      if (selectedRuleBook != null)
      {
        // 使用选中的规则书进行分析
        try
        {
          // 尝试使用 V2 规则引擎
          try
          {
            result = await V2RuleEngine.AnalyzeAsync(chatLog.Mes, selectedRuleBook.Content);
          }
          catch (Exception v2Ex)
          {
            Console.WriteLine($"V2 规则引擎分析失败: {v2Ex.Message}");
            // 如果 V2 失败，回退到 V1
            var ruleEngine = new RuleEngine();
            var parsedRuleBook = await Task.Run(() => ruleEngine.ParseRuleBook(selectedRuleBook.Content));
            result = await ruleEngine.ExecuteRulesAsync(chatLog.Mes, parsedRuleBook);
          }
        }
        catch (Exception ruleEx)
        {
          Console.WriteLine($"使用规则书分析失败: {ruleEx.Message}");
          await MessageService.WarningAsync($"规则书分析失败，将使用默认分析：{ruleEx.Message}");
          // 如果规则书分析失败，回退到默认分析
          result = await _analyzer.AnalyzeAsync(chatLog.Mes, "(未知)");
        }
      }
      else
      {
        // 使用默认的 ChatLogAnalyzer 进行分析
        result = await _analyzer.AnalyzeAsync(chatLog.Mes, "(未知)");
      }

      // 设置 ChatLogId 以保持与现有结构的兼容性
      result.ChatLogId = ChatLogId;

      analysisResult.Title = result.Title;
      analysisResult.Summary = result.Summary;
      analysisResult.MainBody = result.MainBody;

      // 先停止loading状态，再显示成功消息
      isAnalyzing = false;
      StateHasChanged();

      // 显示成功消息
      if (selectedRuleBook != null)
      {
        await MessageService.SuccessAsync($"使用规则书「{selectedRuleBook.Name}」分析完成！");
      }
      else
      {
        await MessageService.SuccessAsync("使用默认引擎分析完成！");
      }
    }
    catch (Exception ex)
    {
      Console.WriteLine($"分析内容时出错: {ex.Message}");
      await MessageService.ErrorAsync($"分析失败：{ex.Message}");
      isAnalyzing = false;
      StateHasChanged();
    }
  }

  private async Task SaveAnalysis()
  {
    try
    {
      isSaving = true;
      StateHasChanged();

      // 确保设置了 ChatLogId
      analysisResult.ChatLogId = ChatLogId;

      // 保存分析结果（支持空值）
      var savedResult = await AnalysisService.SaveAnalysisResultAsync(analysisResult);

      // 更新当前分析结果为保存后的结果
      analysisResult = savedResult;

      Console.WriteLine("分析结果保存成功！");
      await MessageService.SuccessAsync("分析结果保存成功！");
      StateHasChanged();
    }
    catch (Exception ex)
    {
      Console.WriteLine($"保存分析结果时出错: {ex.Message}");
      await MessageService.ErrorAsync($"保存失败：{ex.Message}");
    }
    finally
    {
      isSaving = false;
      StateHasChanged();
    }
  }

  private async Task ClearAnalysis()
  {
    analysisResult.Title = "";
    analysisResult.Summary = "";
    analysisResult.MainBody = "";
    await MessageService.InfoAsync("分析结果已清空");
    StateHasChanged();
  }

  private async Task GoPrevious()
  {
    if (isNavigating || !hasPrevious) return;

    try
    {
      isNavigating = true;
      StateHasChanged();

      var previousId = await ChatLogService.GetPreviousChatLogIdAsync(ChatLogId);
      if (previousId.HasValue)
      {
        Navigation.NavigateTo($"/chatlogs/{BookId}/{previousId.Value}/analyze");
      }
    }
    catch (Exception ex)
    {
      Console.WriteLine($"导航到上一条记录时出错: {ex.Message}");
      await MessageService.ErrorAsync($"导航失败：{ex.Message}");
    }
    finally
    {
      isNavigating = false;
      StateHasChanged();
    }
  }

  private async Task GoNext()
  {
    if (isNavigating || !hasNext) return;

    try
    {
      isNavigating = true;
      StateHasChanged();

      var nextId = await ChatLogService.GetNextChatLogIdAsync(ChatLogId);
      if (nextId.HasValue)
      {
        Navigation.NavigateTo($"/chatlogs/{BookId}/{nextId.Value}/analyze");
      }
    }
    catch (Exception ex)
    {
      Console.WriteLine($"导航到下一条记录时出错: {ex.Message}");
      await MessageService.ErrorAsync($"导航失败：{ex.Message}");
    }
    finally
    {
      isNavigating = false;
      StateHasChanged();
    }
  }

  private async Task GoBack()
  {
    try
    {
      // 获取当前记录所在的页码
      var pageNumber = await ChatLogService.GetPageNumberForChatLogAsync(ChatLogId);
      Navigation.NavigateTo($"/chatlogs/{BookId}?page={pageNumber}");
    }
    catch (Exception ex)
    {
      Console.WriteLine($"获取页码时出错: {ex.Message}");
      await MessageService.WarningAsync("无法获取准确页码，将返回第一页");
      // 如果获取页码失败，则回到第一页
      Navigation.NavigateTo($"/chatlogs/{BookId}");
    }
  }

  // 规则书相关方法

  private void OnSelectedRuleBookIdChanged(int? ruleBookId)
  {
    selectedRuleBookId = ruleBookId;
    StateHasChanged();
  }

  private void OnRuleBookSelectionChanged(ChatLogAnalysisRuleBook? ruleBook)
  {
    selectedRuleBook = ruleBook;
    StateHasChanged();
  }

  // 楼层跳转方法
  private void JumpToFloor(int chatLogId)
  {
    Navigation.NavigateTo($"/chatlogs/{BookId}/{chatLogId}/analyze");
  }

  // 批量分析完成回调
  private async Task OnBatchAnalysisCompleted(BatchAnalysisModal.BatchAnalysisResult result)
  {
    // 重新加载当前记录的分析结果
    await LoadData();

    // 显示完成消息
    if (result.ErrorCount > 0)
    {
      await MessageService.WarningAsync($"批量分析完成！成功处理 {result.SuccessCount}/{result.ProcessedCount} 条记录，{result.ErrorCount} 个错误");
    }
    else
    {
      await MessageService.SuccessAsync($"批量分析完成！成功处理 {result.SuccessCount} 条记录");
    }
  }

}