@page "/chatlogs/{bookId:int}/{chatLogId:int}/analyze"
@using Novex.Data.Models
@using Novex.Data.Services
@inject IChatLogService ChatLogService
@inject IAnalysisService AnalysisService
@inject IBookService BookService
@inject NavigationManager Navigation

<div style="margin-bottom: 16px;">
  <h3 style="margin: 0;">
    分析对话记录
    @if (!string.IsNullOrEmpty(bookName))
    {
      <span style="font-size: 16px; font-weight: normal; margin-left: 8px; color: #666;">
        - @bookName
      </span>
    }
  </h3>
</div>

<div class="analyze-container">
  @if (chatLog != null)
  {
    <div style="margin-bottom: 16px; display: flex; justify-content: space-between; align-items: center;">
      <Button Type="@ButtonType.Link" OnClick="@GoBack">
        <Icon Type="arrow-left" /> 返回对话记录
      </Button>

      <Space>
        <SpaceItem>
          <Button Type="@ButtonType.Default" Size="@ButtonSize.Small" OnClick="@GoPrevious"
            Disabled="@(!hasPrevious || isNavigating)" Loading="@isNavigating">
            <Icon Type="left" /> 上一条
          </Button>
        </SpaceItem>
        <SpaceItem>
          <Text Strong="true" style="padding: 0 12px; color: #666;">
            第 @(chatLog?.Index.ToString() ?? "--") 楼
          </Text>
        </SpaceItem>
        <SpaceItem>
          <Button Type="@ButtonType.Default" Size="@ButtonSize.Small" OnClick="@GoNext"
            Disabled="@(!hasNext || isNavigating)" Loading="@isNavigating">
            下一条
            <Icon Type="right" />
          </Button>
        </SpaceItem>
      </Space>
    </div>

    <Row Gutter="16">
      <AntDesign.Col Span="12">
        <Card Title="原文内容" Bordered="true">
          <div class="original-content">
            <div class="chat-info">
              <strong>角色：</strong>@chatLog.Name<br />
              <strong>时间：</strong>@chatLog.SendDate.ToString("yyyy-MM-dd HH:mm:ss")<br />
              <strong>楼层：</strong>@chatLog.Index
            </div>
            <Divider />
            <div class="chat-message">
              @((MarkupString)chatLog.Mes.Replace("\n", "<br />"))
            </div>
          </div>
        </Card>
      </AntDesign.Col>

      <AntDesign.Col Span="12">
        <Card Title="分析结果" Bordered="true">
          <Form Model="@analysisResult" LabelCol="new ColLayoutParam { Span = 4 }"
            WrapperCol="new ColLayoutParam { Span = 20 }">
            <FormItem Label="标题">
              <Input @bind-Value="@analysisResult.Title" Placeholder="请输入分析标题" MaxLength="200" />
            </FormItem>

            <FormItem Label="摘要">
              <TextArea @bind-Value="@analysisResult.Summary" Placeholder="请输入摘要内容" Rows="4" ShowCount="true"
                MaxLength="500" />
            </FormItem>

            <FormItem Label="正文">
              <TextArea @bind-Value="@analysisResult.MainBody" Placeholder="请输入正文内容" Rows="8" ShowCount="true" />
            </FormItem>

            <FormItem WrapperCol="new ColLayoutParam { Offset = 4, Span = 20 }">
              <Space>
                <SpaceItem>
                  <Button Type="@ButtonType.Primary" OnClick="@AnalyzeContent" Loading="@isAnalyzing">
                    <Icon Type="experiment" /> 分析
                  </Button>
                </SpaceItem>
                <SpaceItem>
                  <Button Type="@ButtonType.Default" OnClick="@SaveAnalysis" Loading="@isSaving">
                    <Icon Type="save" /> 保存
                  </Button>
                </SpaceItem>
                <SpaceItem>
                  <Button Type="@ButtonType.Dashed" OnClick="@ClearAnalysis">
                    <Icon Type="clear" /> 清空
                  </Button>
                </SpaceItem>
              </Space>
            </FormItem>
          </Form>
        </Card>

        <Card Title="分析规则" Bordered="true" style="margin-top: 16px;">
          <div style="color: #666; font-style: italic;">
            <p>当前使用 Novex.Analyzer 分析引擎：</p>
            <ul>
              <li>规则类型：(未知) - 通用分析</li>
              <li>标题：提取消息前50个字符</li>
              <li>摘要：根据分析规则生成</li>
              <li>正文：生成详细分析报告</li>
            </ul>
            <p style="margin-top: 8px; font-size: 12px;">
              <Icon Type="experiment" /> 支持长度分析、情感分析、关键词分析等多种规则
            </p>
          </div>
        </Card>
      </AntDesign.Col>
    </Row>
  }
  else if (isLoading)
  {
    <div style="text-align: center; padding: 50px;">
      <Spin Size="@SpinSize.Large" />
      <div style="margin-top: 16px;">加载中...</div>
    </div>
  }
  else
  {
    <Result Status="@ResultStatus.Error" Title="404" SubTitle="对话记录不存在">
      <Extra>
        <Button Type="@ButtonType.Primary" OnClick="@GoBack">返回</Button>
      </Extra>
    </Result>
  }
</div>

<style>
  .analyze-container {
    padding: 16px;
  }

  .original-content {
    max-height: 600px;
    overflow-y: auto;
  }

  .chat-info {
    background: #f5f5f5;
    padding: 12px;
    border-radius: 4px;
    margin-bottom: 12px;
    line-height: 1.6;
  }

  .chat-message {
    line-height: 1.8;
    white-space: pre-wrap;
    word-wrap: break-word;
  }
</style>

@code {
  [Parameter] public int BookId { get; set; }
  [Parameter] public int ChatLogId { get; set; }

  private ChatLog? chatLog;
  private ChatLogAnalysisResult analysisResult = new();
  private bool isLoading = true;
  private bool isAnalyzing = false;
  private bool isSaving = false;
  private bool isNavigating = false;
  private bool hasPrevious = false;
  private bool hasNext = false;
  private string bookName = "";
  private readonly Novex.Analyzer.ChatLogAnalyzer _analyzer = new();

  protected override async Task OnInitializedAsync()
  {
    await LoadData();
  }

  protected override async Task OnParametersSetAsync()
  {
    // 当路由参数改变时重新加载数据
    await LoadData();
  }

  private async Task LoadData()
  {
    try
    {
      isLoading = true;
      StateHasChanged();

      chatLog = await ChatLogService.GetChatLogByIdAsync(ChatLogId);
      if (chatLog == null || chatLog.BookId != BookId)
      {
        return;
      }

      // 获取书名
      var book = await BookService.GetBookByIdAsync(BookId);
      bookName = book?.Name ?? "";

      // 尝试加载现有的分析结果
      var existingAnalysis = await AnalysisService.GetAnalysisResultAsync(ChatLogId);
      if (existingAnalysis != null)
      {
        analysisResult = existingAnalysis;
      }
      else
      {
        // 初始化空的分析结果
        analysisResult = new ChatLogAnalysisResult
        {
          ChatLogId = ChatLogId,
          Title = "",
          Summary = "",
          MainBody = ""
        };
      }

      // 检查上一条和下一条记录的存在性
      var previousId = await ChatLogService.GetPreviousChatLogIdAsync(ChatLogId);
      var nextId = await ChatLogService.GetNextChatLogIdAsync(ChatLogId);
      hasPrevious = previousId.HasValue;
      hasNext = nextId.HasValue;
    }
    catch (Exception ex)
    {
      Console.WriteLine($"加载数据时出错: {ex.Message}");
    }
    finally
    {
      isLoading = false;
      StateHasChanged();
    }
  }

  private async Task AnalyzeContent()
  {
    if (chatLog == null) return;

    try
    {
      isAnalyzing = true;
      StateHasChanged();

      // 使用新的 ChatLogAnalyzer 进行异步分析
      var result = await _analyzer.AnalyzeAsync(chatLog.Mes, "(未知)");
      
      // 设置 ChatLogId 以保持与现有结构的兼容性
      result.ChatLogId = ChatLogId;
      
      analysisResult.Title = result.Title;
      analysisResult.Summary = result.Summary;
      analysisResult.MainBody = result.MainBody;

      StateHasChanged();
    }
    catch (Exception ex)
    {
      Console.WriteLine($"分析内容时出错: {ex.Message}");
    }
    finally
    {
      isAnalyzing = false;
      StateHasChanged();
    }
  }

  private async Task SaveAnalysis()
  {
    try
    {
      isSaving = true;
      StateHasChanged();

      analysisResult.ChatLogId = ChatLogId;
      await AnalysisService.SaveAnalysisResultAsync(analysisResult);

      // 显示保存成功消息（这里可以使用 Ant Design 的 Message 组件）
      StateHasChanged();
    }
    catch (Exception ex)
    {
      Console.WriteLine($"保存分析结果时出错: {ex.Message}");
    }
    finally
    {
      isSaving = false;
      StateHasChanged();
    }
  }

  private void ClearAnalysis()
  {
    analysisResult.Title = "";
    analysisResult.Summary = "";
    analysisResult.MainBody = "";
    StateHasChanged();
  }

  private async Task GoPrevious()
  {
    if (isNavigating || !hasPrevious) return;

    try
    {
      isNavigating = true;
      StateHasChanged();

      var previousId = await ChatLogService.GetPreviousChatLogIdAsync(ChatLogId);
      if (previousId.HasValue)
      {
        Navigation.NavigateTo($"/chatlogs/{BookId}/{previousId.Value}/analyze");
      }
    }
    catch (Exception ex)
    {
      Console.WriteLine($"导航到上一条记录时出错: {ex.Message}");
    }
    finally
    {
      isNavigating = false;
      StateHasChanged();
    }
  }

  private async Task GoNext()
  {
    if (isNavigating || !hasNext) return;

    try
    {
      isNavigating = true;
      StateHasChanged();

      var nextId = await ChatLogService.GetNextChatLogIdAsync(ChatLogId);
      if (nextId.HasValue)
      {
        Navigation.NavigateTo($"/chatlogs/{BookId}/{nextId.Value}/analyze");
      }
    }
    catch (Exception ex)
    {
      Console.WriteLine($"导航到下一条记录时出错: {ex.Message}");
    }
    finally
    {
      isNavigating = false;
      StateHasChanged();
    }
  }

  private async Task GoBack()
  {
    try
    {
      // 获取当前记录所在的页码
      var pageNumber = await ChatLogService.GetPageNumberForChatLogAsync(ChatLogId);
      Navigation.NavigateTo($"/chatlogs/{BookId}?page={pageNumber}");
    }
    catch (Exception ex)
    {
      Console.WriteLine($"获取页码时出错: {ex.Message}");
      // 如果获取页码失败，则回到第一页
      Navigation.NavigateTo($"/chatlogs/{BookId}");
    }
  }
}