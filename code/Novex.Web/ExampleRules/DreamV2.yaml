Version: "2.0"
Description: "集成测试规则 - 处理 Fixture 文件（通用规则，支持多种格式）"

# 规则链：
# 1. 从 plot 标签提取标题和摘要（优先执行，避免内容被修剪）
# 2. 移除 <think>...</think> 块
# 3. 移除内容块标记和内容（<!-- *_CONTENT_START --> 到 <!-- *_CONTENT_END -->）
# 4. 移除 HTML 注释
# 5. 提取 <content>...</content> 内容（如果存在，否则保留全部内容）
# 6. 合并多余空行（2行或以上变为1行）
# 7. 修剪首尾空白

Rules:
  # 第1步：从 plot 标签中提取章节和事件名作为标题
  # 优先执行，确保在内容被修剪前提取
  - Id: "ExtractPlotTitle"
    Name: "从 plot 标签提取标题"
    Processor: "Extraction.ExtractStructuredData"
    Scope: "Source"
    TargetField: "Title"
    Priority: 5
    Enabled: true
    OnError: "Skip"
    Parameters:
      TagName: "plot"
      Fields: "Chapter:当前章节,Event:事件名"
      Separator: "/"

  # 第2步：从 plot 标签中提取摘要
  # 优先执行，确保在内容被修剪前提取
  - Id: "ExtractPlotSummary"
    Name: "从 plot 标签提取摘要"
    Processor: "Extraction.ExtractStructuredData"
    Scope: "Source"
    TargetField: "Summary"
    Priority: 6
    Enabled: true
    OnError: "Skip"
    Parameters:
      TagName: "plot"
      Fields: "Summary:摘要"

  # 第3步：移除思考块 <think>...</think>
  - Id: "RemoveThinkBlocks"
    Name: "移除思考块"
    Processor: "Regex.Replace"
    Scope: "Source"
    Priority: 10
    Enabled: true
    Parameters:
      Pattern: '<think>.*?</think>'
      Replacement: ''
      RegexOptions: "Singleline,IgnoreCase"

  # 第4步：移除 FORUM 内容块（<!-- FORUM_CONTENT_START --> 到 <!-- FORUM_CONTENT_END -->）
  # 移除整个块（包括标记和内容）
  - Id: "RemoveForumContentBlock"
    Name: "移除论坛内容块"
    Processor: "Regex.Replace"
    Scope: "Source"
    Priority: 15
    Enabled: true
    Parameters:
      Pattern: '<!--\s*FORUM_CONTENT_START\s*-->[\s\S]*?<!--\s*FORUM_CONTENT_END\s*-->'
      Replacement: ''
      RegexOptions: "Multiline"

  # 第5步：移除微博内容（<!-- WEIBO_CONTENT_START --> 到 <!-- WEIBO_CONTENT_END -->）块
  - Id: "RemoveWeiboContentBlock"
    Name: "移除微博内容块"
    Processor: "Regex.Replace"
    Scope: "Source"
    Priority: 17
    Enabled: true
    Parameters:
      Pattern: '<!--\s*WEIBO_CONTENT_START\s*-->[\s\S]*?<!--\s*WEIBO_CONTENT_END\s*-->'
      Replacement: ''
      RegexOptions: "Multiline"

  # 第6步：移除 HTML 注释
  - Id: "RemoveHtmlComments"
    Name: "移除 HTML 注释"
    Processor: "Regex.Replace"
    Scope: "Source"
    Priority: 20
    Enabled: true
    Parameters:
      Pattern: '<!--.*?-->'
      Replacement: ''
      RegexOptions: "Singleline"

  # 第7步：提取 <content>...</content> 内容（如果存在）
  # 如果不存在 <content> 标签，则保留全部内容（通过 OnError: Skip）
  - Id: "ExtractContentBlock"
    Name: "提取内容块（如果存在）"
    Processor: "Markup.SelectNode"
    Scope: "Source"
    Priority: 40
    Enabled: true
    OnError: "Skip"
    Parameters:
      XPath: "//content"
      InnerHtml: true

  # 第8步：合并多余空行（2行或以上变为1行）
  - Id: "MergeExcessiveBlankLines"
    Name: "合并多余空行"
    Processor: "Regex.Replace"
    Scope: "Source"
    Priority: 50
    Enabled: true
    Parameters:
      Pattern: "\\n\\n+"
      Replacement: "\\n\\n"
      RegexOptions: "Singleline"

  # 第9步：修剪首尾空白
  - Id: "TrimContent"
    Name: "修剪首尾空白"
    Processor: "Text.Trim"
    Scope: "Source"
    Priority: 100
    Enabled: true

