Version: "1.0"
Description: "Dream Phone 规则 - 使用混合方式处理"

ExtractionRules:
  # 1. 使用 markup 方式提取 plot 标签内容
  - Id: "ExtractPlotContent"
    Name: "提取情节内容"
    MatcherType: "Markup"
    Pattern: "plot"
    Options:
      Multiline: true
      Singleline: true
      Global: false
      MaxMatches: 1
    Action: "Extract"
    Target: "Custom"
    CustomTargetName: "PlotContent"
    Priority: 10
    Enabled: true

  # 2. 使用 markup 方式提取 dream 标签内容
  - Id: "ExtractDreamContent"
    Name: "提取梦境内容"
    MatcherType: "Markup"
    Pattern: "dream"
    Options:
      Multiline: true
      Singleline: true
      Global: false
      MaxMatches: 1
    Action: "Extract"
    Target: "MainBody"
    Priority: 20
    Enabled: true

  # 3. 兜底提取规则 - 如果没有 dream 和 body 标签，提取全部内容
  - Id: "ExtractFullContent"
    Name: "提取全部内容作为正文"
    MatcherType: "Regex"
    Pattern: "^(.*)$"
    Options:
      Multiline: true
      Singleline: true
      Global: false
      MaxMatches: 1
    Action: "Extract"
    Target: "MainBody"
    Priority: 30
    Enabled: true

TransformationRules:
  # 1. 从情节内容提取标题
  - Id: "ExtractTitleFromPlot"
    Name: "提取标题"
    SourceField: "PlotContent"
    TargetField: "Title"
    TransformationType: "RegexExtraction"
    Parameters:
      Pattern: "当前章节: ([^\\n]+).*?事件名:([^\\n\\(]+)"
      Format: "{1}/{2}" # Groups[1] 和 Groups[2] 是捕获组
    Priority: 100
    Enabled: true

  # 2. 从情节内容提取摘要
  - Id: "ExtractSummaryFromPlot"
    Name: "提取摘要"
    SourceField: "PlotContent"
    TargetField: "Summary"
    TransformationType: "RegexExtraction"
    Parameters:
      Pattern: "摘要:([^\\n]*(?:\\n(?!当前章节|个人线|当前角色|长期事件|事件名)[^\\n]*)*)"
      Format: "{1}"
    Priority: 110
    Enabled: true

  # 3. 移除热议内容块
  - Id: "RemoveDiscussionBlocks"
    Name: "移除微博和论坛热议内容"
    SourceField: "MainBody"
    TargetField: "MainBody"
    TransformationType: "RegexExtraction"
    Parameters:
      RemoveMultipleBlocks:
        - start: "【微博热议】"
          end: "[由微博管理器自动生成]"
        - start: "【论坛热议】"
          end: "[由论坛管理器自动生成]"
    Priority: 115
    Enabled: true

  # 4. 清理正文内容 - 移除HTML注释
  - Id: "RemoveHtmlComments"
    Name: "移除HTML注释"
    SourceField: "MainBody"
    TargetField: "MainBody"
    TransformationType: "RemoveHtmlComments"
    Parameters:
      RemoveComments: true
    Priority: 120
    Enabled: true

  # 5. 移除运行块
  - Id: "RemoveRunBlocks"
    Name: "移除运行块"
    SourceField: "MainBody"
    TargetField: "MainBody"
    TransformationType: "RemoveRunBlocks"
    Parameters:
      RemoveRunBlocks: true
    Priority: 130
    Enabled: true

  # 6. 移除XML标签
  - Id: "RemoveXmlTags"
    Name: "移除XML标签"
    SourceField: "MainBody"
    TargetField: "MainBody"
    TransformationType: "RemoveXmlTags"
    Parameters:
      RemoveXmlTags: true
    Priority: 140
    Enabled: true

  # 7. 清理空白字符并限制空行
  - Id: "CleanAndPreserveFormat"
    Name: "清理空白字符并限制连续空行"
    SourceField: "MainBody"
    TargetField: "MainBody"
    TransformationType: "CleanWhitespace"
    Parameters:
      CleanWhitespace: true
      LimitEmptyLines: true
    Priority: 150
    Enabled: true

  # 8. 最终清理步骤 - 标题和摘要
  - Id: "CleanTitleWhitespace"
    Name: "清理标题空白字符"
    SourceField: "Title"
    TargetField: "Title"
    TransformationType: "CleanWhitespace"
    Parameters:
      CleanWhitespace: true
    Priority: 160
    Enabled: true

  - Id: "CleanSummaryWhitespace"
    Name: "清理摘要空白字符"
    SourceField: "Summary"
    TargetField: "Summary"
    TransformationType: "CleanWhitespace"
    Parameters:
      CleanWhitespace: true
    Priority: 170
    Enabled: true

AiGenerationRule:
  Enabled: false
