version: "1.0"
description: "Dream Phone 小说处理规则 - 提取主要故事内容并生成标题摘要"

# 提取规则 - 按优先级执行
extraction_rules:
  # 1. 删除开头的元数据配置
  - id: "remove_metadata_header"
    name: "删除元数据头部"
    matcher_type: "regex"
    pattern: "^-\\s+.*?(?=<dream>|$)"
    options:
      multiline: true
      singleline: true
    action: "remove"
    target: "source"
    priority: 10
    enabled: true

  # 2. 删除HTML风格的注释块
  - id: "remove_html_comments"
    name: "删除HTML注释"
    matcher_type: "regex"
    pattern: "<!--.*?-->"
    options:
      multiline: true
      singleline: true
      global: true
    action: "remove"
    target: "source"
    priority: 20
    enabled: true

  # 3. 提取<dream>标签内的主要内容
  - id: "extract_dream_content"
    name: "提取梦境内容"
    matcher_type: "markup"
    pattern: "<dream>(.*?)</dream>"
    options:
      multiline: true
      singleline: true
    action: "extract"
    target: "main_body"
    priority: 30
    enabled: true
    post_processors:
      - type: "trim_whitespace"
      - type: "format_text"
        parameters:
          remove_extra_newlines: true
          normalize_spaces: true

  # 4. 从推进描述中提取摘要信息
  - id: "extract_summary_from_progression"
    name: "从推进描述提取摘要"
    matcher_type: "regex"
    pattern: "推进：(.*?)(?=\\s*-\\s*耗时|$)"
    options:
      multiline: true
      singleline: true
    action: "extract"
    target: "summary"
    priority: 40
    enabled: true
    post_processors:
      - type: "trim_whitespace"
      - type: "format_text"

  # 5. 删除底部状态信息
  - id: "remove_bottom_metadata"
    name: "删除底部元数据"
    matcher_type: "regex"
    pattern: "<WorldState>.*?</plot>.*?</details>"
    options:
      multiline: true
      singleline: true
    action: "remove"
    target: "source"
    priority: 50
    enabled: true

  # 6. 提取事件名作为潜在标题
  - id: "extract_event_name"
    name: "提取事件名"
    matcher_type: "regex"
    pattern: "事件名:([^(\\n]+)(?:\\([^)]*\\))?"
    options:
      multiline: true
    action: "extract"
    target: "title"
    priority: 60
    enabled: true
    post_processors:
      - type: "trim_whitespace"

# 转换规则 - 对提取的内容进行后处理
transformation_rules:
  # 1. 如果没有提取到标题，使用默认逻辑生成
  - id: "generate_default_title"
    name: "生成默认标题"
    source_field: "summary"
    target_field: "title"
    transformation_type: "custom"
    parameters:
      condition: "title_is_empty"
      max_length: 20
      extract_key_words: true
    priority: 100
    enabled: true

  # 2. 格式化摘要，确保简洁明了
  - id: "format_summary"
    name: "格式化摘要"
    source_field: "summary"
    target_field: "summary"
    transformation_type: "format"
    parameters:
      max_length: 500
      remove_redundant_phrases: true
      enhance_readability: true
    priority: 110
    enabled: true

  # 3. 清理正文内容
  - id: "clean_main_body"
    name: "清理正文内容"
    source_field: "main_body"
    target_field: "main_body"
    transformation_type: "format"
    parameters:
      preserve_formatting: true
      remove_empty_lines: false
      normalize_quotes: true
    priority: 120
    enabled: true

# AI生成规则（可选）
ai_generation_rule:
  enabled: false
  provider: "custom"
  model: "gpt-4"
  system_prompt: |
    你是一个专业的小说编辑助手。请根据提供的小说片段，生成合适的标题和摘要。

    要求：
    - 标题要简洁有力，突出关键情节或人物关系
    - 摘要要概括主要情节，不超过200字
    - 保持客观中性的语调

  user_prompt_template: |
    请为以下小说片段生成标题和摘要：

    原文：
    {main_body}

    请以JSON格式返回：
    {
      "title": "标题",
      "summary": "摘要"
    }

  parameters:
    temperature: 0.7
    max_tokens: 300

  targets:
    - "title"
    - "summary"

  priority: 1000
