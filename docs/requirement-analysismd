# Novex 项目需求分析文档 (更新版)

## 1. 项目概述

Novex 是一个专业的 SillyTavern 聊天记录管理与编纂系统。旨在将分散的、非结构化的 `jsonl` 聊天记录，通过强大的分析引擎和灵活的编纂工具，转化为结构清晰、内容精炼的电子书或小说章节。

项目利用 .NET 9 和 Blazor Server 技术栈，结合 Ant Design UI 框架，提供了一个从数据导入、内容分析、章节编纂到最终导出的完整工作流。其核心特色是基于 YAML 的可自定义规则引擎，以及集成的 AI 辅助创作功能。

## 2. 核心功能模块

### 2.1. 数据导入与管理

该模块负责将原始聊天数据导入系统，并按“书目”进行组织。

- **书目管理**: 系统以“书目”为单位组织所有数据。用户可以创建、删除、重命名和清空书目。
- **导入功能**: 
  - 支持从 SillyTavern 导出的 `jsonl` 文件导入聊天记录。
  - 导入时必须选择或创建一个关联的书目。
  - 系统能智能解析 `jsonl` 文件，只提取包含 `name` 字段的有效对话记录。
  - 导入过程会完整替换目标书目下的所有现有记录，以确保数据一致性。
- **数据存储**: 
  - 聊天记录（`ChatLog`）与书目（`Book`）在数据库中为一对多关系。
  - 每条记录保留其在源文件中的原始顺序（`Index` 楼层号）。

### 2.2. 内容分析引擎 (Novex.Analyzer)

这是项目的核心，一个高度可配置的分析引擎，负责将原始对话（`Mes`）处理成结构化的内容（标题、摘要、正文）。

- **规则驱动**: 引擎的行为由用户自定义的 YAML “规则书”驱动。
- **规则书管理**: 
  - 用户可以在 UI 上创建、编辑、删除和管理规则书 (`ChatLogAnalysisRuleBook`)。
  - 规则书包含版本、描述及核心规则内容。
- **多阶段处理流程**: 
  1.  **提取 (Extraction)**: 根据规则从原文中提取或移除特定内容。支持 `Regex` 和 `Markup` (HTML/XML) 两种匹配方式。
  2.  **转换 (Transformation)**: 对提取出的数据进行二次加工，如格式化、截断、清理空白、移除特定块等。
  3.  **后处理 (Post-Processing)**: 在所有转换完成后执行的最终处理步骤。一个关键实现是 **摘要回退 (SummaryFallback)**，当未提取到摘要时，可自动从正文生成摘要。
- **模块化处理器**: 引擎内部实现了一系列可重用的处理器（`IPostProcessor`, `ITransformationProcessor`），如 `RegexExtractionProcessor`、`CleanWhitespaceProcessor` 等，具有良好的扩展性。

### 2.3. 聊天记录分析

此功能允许用户对单条或多条聊天记录应用规则书，生成并保存分析结果。

- **单条分析**: 在 `/chatlogs/{bookId}/{chatLogId}/analyze` 页面，用户可以：
  - 查看原文和渲染后的效果。
  - 从下拉列表中选择一个已保存的规则书。
  - 点击“分析”按钮，调用分析引擎处理当前记录。
  - 手动编辑生成的标题、摘要和正文。
  - 将分析结果（`ChatLogAnalysisResult`）保存到数据库。
- **批量分析**: 
  - 提供批量分析模态框，允许用户选择一个规则书对指定楼层范围内的记录进行批量处理。
  - 支持“跳过已分析的记录”和“覆盖已有分析结果”两种模式。
  - 实时显示处理进度、成功率和错误信息。

### 2.4. 书目编纂

这是将分析后的内容整理成书的核心功能，位于 `/books/{BookId}/compose` 页面。

- **三栏式布局**: 
  1.  **左侧**: 章节列表和聊天记录分析列表。
  2.  **中间**: 选中章节的 Markdown 内容编辑器。
  3.  **右侧**: 选中的单条聊天记录的详细分析结果。
- **章节管理**: 
  - 用户可以创建、重命名、删除和拖拽排序章节。
  - 所有章节操作实时保存到数据库 (`BookChapters`)。
- **内容编辑**: 
  - 提供一个基于 CodeMirror 的 Markdown 编辑器，支持语法高亮和实时编辑。
  - 编辑器内容与选中章节绑定，并采用防抖机制（debounce）自动保存，避免频繁写入数据库。
- **内容插入**: 用户可以浏览聊天记录的分析结果，并通过“插入到章节”按钮，将当前记录的正文（`MainBody`）追加到章节内容的末尾。
- **AI 辅助创作**: 
  - **标题生成**: 在编辑章节标题时，提供“AI 生成”功能，可根据章节内容，调用已配置的 LLM API 生成多个标题建议。
  - **提示词管理**: 用户可以在设置页面管理用于 AI 标题生成的不同风格的提示词（`AITitlePrompt`）。
- **导出功能**: 
  - 支持将单个章节、所有章节（打包为 ZIP）或全书导出为 `Markdown` 或 `TXT` 文件。
  - 导出的文件会自动添加章节序号和标题。

### 2.5. 系统设置

提供统一的设置页面 (`/settings`)，用于配置系统级参数。

- **LLM API 设置**: 
  - 用户可以配置一个 OpenAI 兼容标准的 API 地址和密钥。
  - 提供“获取模型”功能，动态从用户提供的 API 地址加载可用的模型列表，并允许用户选择一个作为默认模型。
  - 所有设置自动保存，无需手动点击保存按钮。
- **提示词管理**: 
  - 提供一个界面，用于增、删、改、查用于 AI 标题生成的提示词模板。
  - 支持软删除，以备将来恢复。

## 3. 数据模型 (Data Models)

- **Book**: 书目，作为聊天记录的顶层容器。
- **ChatLog**: 单条聊天记录，包含原始消息、发送者、时间等。
- **ChatLogAnalysisResult**: 存储对单条 `ChatLog` 的分析结果（标题、摘要、正文）。
- **BookChapter**: 书目的章节，包含标题、顺序和编纂后的 Markdown 内容。
- **ChatLogAnalysisRuleBook**: 用户自定义的 YAML 分析规则书。
- **LLMSetting**: 存储第三方大语言模型服务的 API 配置。
- **AITitlePrompt**: 存储用于 AI 标题生成的不同风格的提示词模板。

## 4. 技术栈

- **后端**: .NET 9, C#
- **数据库**: Entity Framework Core, SQLite
- **前端**: Blazor Server
- **UI 框架**: Ant Design Blazor
- **编辑器**: CodeMirror 6 (通过 TypeScript 和 esbuild 构建)
- **数据格式**: YAML (用于规则书), JSONL (用于导入)

## 5. 总结

Novex 项目从一个简单的聊天记录查看器，演变为一个功能强大的内容处理与创作辅助平台。它通过灵活的规则引擎实现了对非结构化数据的高度自定义处理，并通过集成 AI 服务，为小说创作和内容整理提供了智能化支持。整个系统架构清晰，模块化程度高，具有良好的可维护性和扩展性。
