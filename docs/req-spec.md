# 主要功能描述

读取 SillyTavern 导出的聊天记录文件，提取+结构化处理对话内容，剔除不必要信息。

# 架构

底层技术：dotnet (最新)
语言：C#
数据库：FCore + SQLite
前端：Blazor Server
UI 框架：Ant Design Blazor

# 功能1：读取聊天记录

## 1.1 读取 SillyTavern 导出的 Jsonl 文件

1. 读取 SillyTavern 导出的 Jsonl 文件，每行代表一条聊天记录。
2. 只读取包含 `name` 字段的条目。
3. 将读取的聊天记录写入一个类型名为 `ChatLog` 的对象，提取每条记录的：
    1. `name`：角色名称
    2. `mes`：对话内容
    3. `send_date`：发送时间
    4. `preview`：预览内容，内容为 `{Name} {SendDate} {Mes 的前 30 个字符}`。
4. 为每个 `ChatLog` 分配一个ID。
4. 根据每条记录在源文件中的位置，从0开始分配一个递增的序号（也称为“楼层”） `Index`。
5. 将所有 `ChatLog` 对象存储在一个列表中，按 Index 排序。
6. 使用 EFCore 创建一个本地数据库，将排序后的聊天记录存储在数据库名为 `ChatLogs` 的表中。
7. 提供一个接口，允许用户查询特定角色的聊天记录。返回数据中不包括完整的Mes。
8. 提供一个接口，允许用户按分页查找所有聊天记录。返回数据中不包括完整的Mes。
9. 提供一个接口，允许用户通过ID查询单条聊天记录，返回完整的Mes。
10. 创建一个Blazor Server前端，允许用户通过网页界面进行上述查询操作。
11. 在前端页面上显示查询结果，分页显示每页50条记录。
12. 在前端页面查看聊天记录详情的modal中，提供前后翻页按钮，用于跳转到上一条或下一条记录。
13. 在前端页面的查询结果列表中，用不同背景颜色区分不同角色的记录。同时，预览文字也用不同的颜色来区分 Name 和 SendDate，避免和
    Mes 混淆。
14. 允许在聊天记录列表中，指定 Index 范围来查看记录。

## 1.2 按书目组织聊天记录

1. 每个在导入JSONL文件时，允许用户选择一个书目。
    1. 应提供一个带搜索功能的下拉列表，列出所有已有书目，供用户选择。也允许用户通过搜索框模糊搜索已有书目。
    2. 也允许用户输入一个新的书目名称，创建一个新的书目。具体交互为：用户在下拉列表的搜索框中输入名称后，若没有完全匹配的选项，则显示一个选项“创建新书目：{用户输入的名称}”，用户选择该选项后，即创建一个新书目。
2. 将聊天记录按书目名称进行分组，存储在数据库中。书目和聊天记录以一对多的关系存储。
3. 提供接口，允许用户按书目名称查询聊天记录。
4. 在前端页面上，用户只能按书目浏览和查询聊天记录。
5. 在前端页面上，提供一个下拉列表，列出所有已有书目，供用户选择。也允许用户通过搜索框模糊搜索已有书目。
6. 在前端页面上，提供一个书目管理页面，允许用户查看、添加、删除书目。其中查看书目会跳转到对应的聊天记录列表页面。
7. 用户可以在书目管理页面中，选择清空一本书中的所有聊天记录。

# 功能2：整理聊天记录

## 2.1 聊天记录分析页面

1. 提供一个Analyze页面，URL应该是 `/chatlogs/<bookId>/<chatLogId>/analyze`，允许对单独一条聊天记录进行分析。
2. 页面提供一个原文显示框（只读），显示该条聊天记录的完整内容。
3. 页面提供一个分析结果区域，包括：
   1. 标题，可编辑
   2. 摘要，可编辑
   3. 正文内容，可编辑
4. 页面提供一个规则描述区域（暂时留空，具体实现方式待定）
5. 点击分析后，调用一个模拟的分析函数，生成一个摘要和正文内容，显示在对应的区域中。
   1. (目前暂时使用模拟函数，后续可替换为实际的AI分析接口)
6. 允许用户编辑摘要和正文内容，并最终选择保存到数据表ChatLogAnalysisResults中。
   1. 标题保存到 `ChatLogAnalysisResults` 的 `Title` 字段中。
   2. 正文内容保存到 `ChatLogAnalysisResults` 的 `MainBody` 字段中。
   3. 摘要保存到 `ChatLogAnalysisResults` 的 `Summary` 字段中。
   4. `ChatLogAnalysisResult` 和 `ChatLog` 以一对一的关系存储。
   5. 删除 `ChatLog` 或清空书目时，同时删除对应的 `ChatLogAnalysisResult`。

## 2.2 聊天记录分析算法

1. 分析算法应基于预定义的规则和模板，提取聊天记录中的关键信息，生成结构化的分析结果。
2. 分析结果应包括：
   1. 标题：聊天中可以被当作是标题的正文外内容。
   2. 摘要：对聊天记录内容的简要总结，突出主要观点和情节的内容。
   3. 正文内容：聊天记录中除去系统信息、辅助信息等非对话内容后的纯对话内容。
3. 分析规则（下文称为规则书）应支持用户自定义，允许用户通过前端页面输入和保存规则书。
   1. 规则书使用 YAML 格式编写，并能在运行时被解析为结构化数据。
   2. 规则书以字符串形式存储在数据库表 `ChatLogAnalysisRuleBooks` 中，可以在前端页面进行编辑和更新。规则书拥有以下字段：
      1. `Id`：规则书的唯一标识符。
      2. `Name`：规则书的名称。
      3. `Description`：规则书的描述信息。
      4. `Content`：规则书的具体内容，以 YAML 格式存储。
   3. 规则书可以被多个书目共享和复用。
      1. 在进行分析时，用户可以选择使用哪个规则。
      2. 选中的规则书的内容会被传递给分析算法 (`AnalyzeAsync` 方法的 `rules` 参数)，指导分析过程。
4. 分析器应支持多种处理方式，且这这些方式可能会在同一条记录中混合使用：
   1. 正则表达式提取：使用用户提供的规则中的正则表达式，从聊天记录中提取/删除特定模式的文本。
   2. Markup 提取：使用用户提供的规则中的 Markup 语法，从聊天记录中提取/删除特定格式的文本。
   3. AI自动生成：使用预定义的模板和规则，调用AI接口生成摘要和正文内容。（目前暂时使用模拟函数，后续可替换为实际的AI分析接口）

# 功能3：书目编纂

1. 提供一个书目编纂页面，URL应该是 `/books/<bookId>/compose`，允许对某本书中的所有聊天记录进行编纂。
2. 页面中提供三个区域：
   1. 工具栏：包括添加导出选中章节、导出全部章节、导出全书三个按钮。
   2. 上半区域：
      1. 左侧区域：章节列表区域
      2. 右侧区域：章节内容区域
   3. 下半区域：聊天记录区域
3. 章节列表和章节内容进行任何修改后，直接写入数据库。

## 3.1 章节列表区域

1. 章节列表区域显示当前书目的所有章节，按顺序排列。它是一个 Virtualized 列表，支持大量章节的高效显示。
2. 允许用户添加、删除、重命名章节。
3. 允许用户拖拽章节以调整顺序。
4. 允许用户选择某个章节，选中后该章节高亮显示，并在章节内容区域显示该章节内容。
5. 章节信息存储在数据库表 `BookChapters` 中，字段包括：
   1. `Id`：章节的唯一标识符。
   2. `BookId`：所属书目的ID。
   3. `Title`：章节标题。
   4. `Content`：章节内容，存储编纂后的Markdown文本。
   5. `Order`：章节顺序，用于排序显示。
6. 可以编辑章节标题，保存后更新数据库。

## 3.2 章节内容区域

1. 章节内容区域显示选中章节的内容，允许用户编辑。
2. 章节内容为一个 Markdown 编辑器，支持基本的 Markdown 语法，并进行语法高亮。

## 3.3 聊天记录区域

1. 聊天记录区域显示当前书目的单条聊天记录的分析结果，从第一条开始。
2. 显示聊天记录的标题、摘要和正文内容。
3. 提供前后翻页按钮，用于跳转到上一条或下一条记录。
4. 提供一个跳转输入框，允许用户输入楼层号，按回车后跳转到对应楼层的记录。
5. 提供一个“插入到章节”按钮，点击后将当前记录的正文内容插入到章节内容区域的末尾，新起一段的位置上。
   说明：“新起一段”指的是在章节内容的最后加一个新行（当前末尾内容后空一行），然后再插入正文内容。

## 3.4 导出

1. 导出时，允许用户选择是导出 md 文件还是 txt 文件。如果是 txt 文件，则将 Markdown 格式转换为纯文本格式。
2. 导出每一章时，都要在其开头加上章节标题，格式为 `第{ChapterOrder}章 {ChapterTitle}`。

### 3.4.1 导出选中章节

1. 点击“导出章节”后将当前章节内容导出为一个 Markdown 文件。
2. 文件名为 `{BookName}-{ChapterOrder}-{ChapterTitle}.{md|txt}`，其中 `BookName` 是书名，`ChapterOrder` 是章节顺序，`ChapterTitle` 是章节标题。

### 3.4.2 导出全部章节

1. 点击“导出全部章节”后将当前书目的所有章节内容分别导出为多个 Markdown 文件，打包成一个 ZIP 文件供下载。
2. 每一章的导出规则同 “3.4.1 导出章节”。

### 3.4.3 导出全书

1. 点击“导出全书”后将当前书目的所有章节内容合并后导出为一个 Markdown 文件。
2. 文件名为 `{BookName}.{md|txt}`，其中 `BookName` 是书名。
3. 章节之间使用 `\n\n---\n\n` 进行分隔。
