# 主要功能描述

读取 SillyTavern 导出的聊天记录文件，提取+结构化处理对话内容，剔除不必要信息。

# 架构

底层技术：dotnet (最新)
语言：C#
数据库：FCore + SQLite
前端：Blazor Server
UI 框架：Ant Design Blazor

# 功能1：读取聊天记录

## 1.1 读取 SillyTavern 导出的 Jsonl 文件

1. 读取 SillyTavern 导出的 Jsonl 文件，每行代表一条聊天记录。
2. 只读取包含 `name` 字段的条目。
3. 将读取的聊天记录写入一个类型名为 `ChatLog` 的对象，提取每条记录的：
    1. `name`：角色名称
    2. `mes`：对话内容
    3. `send_date`：发送时间
    4. `preview`：预览内容，内容为 `{Name} {SendDate} {Mes 的前 30 个字符}`。
4. 为每个 `ChatLog` 分配一个ID。
4. 根据每条记录在源文件中的位置，从0开始分配一个递增的序号（也称为“楼层”） `Index`。
5. 将所有 `ChatLog` 对象存储在一个列表中，按 Index 排序。
6. 使用 EFCore 创建一个本地数据库，将排序后的聊天记录存储在数据库名为 `ChatLogs` 的表中。
7. 提供一个接口，允许用户查询特定角色的聊天记录。返回数据中不包括完整的Mes。
8. 提供一个接口，允许用户按分页查找所有聊天记录。返回数据中不包括完整的Mes。
9. 提供一个接口，允许用户通过ID查询单条聊天记录，返回完整的Mes。
10. 创建一个Blazor Server前端，允许用户通过网页界面进行上述查询操作。
11. 在前端页面上显示查询结果，分页显示每页50条记录。
12. 在前端页面查看聊天记录详情的modal中，提供前后翻页按钮，用于跳转到上一条或下一条记录。
13. 在前端页面的查询结果列表中，用不同背景颜色区分不同角色的记录。同时，预览文字也用不同的颜色来区分 Name 和 SendDate，避免和
    Mes 混淆。
14. 允许在聊天记录列表中，指定 Index 范围来查看记录。

## 1.2 按书目组织聊天记录

1. 每个在导入JSONL文件时，允许用户选择一个书目。
    1. 应提供一个带搜索功能的下拉列表，列出所有已有书目，供用户选择。也允许用户通过搜索框模糊搜索已有书目。
    2. 也允许用户输入一个新的书目名称，创建一个新的书目。具体交互为：用户在下拉列表的搜索框中输入名称后，若没有完全匹配的选项，则显示一个选项“创建新书目：{用户输入的名称}”，用户选择该选项后，即创建一个新书目。
2. 将聊天记录按书目名称进行分组，存储在数据库中。书目和聊天记录以一对多的关系存储。
3. 提供接口，允许用户按书目名称查询聊天记录。
4. 在前端页面上，用户只能按书目浏览和查询聊天记录。
5. 在前端页面上，提供一个下拉列表，列出所有已有书目，供用户选择。也允许用户通过搜索框模糊搜索已有书目。
6. 在前端页面上，提供一个书目管理页面，允许用户查看、添加、删除书目。其中查看书目会跳转到对应的聊天记录列表页面。
7. 用户可以在书目管理页面中，选择清空一本书中的所有聊天记录。

# 功能2：整理聊天记录

## 2.1 分析聊天记录

1. 提供一个Analyze页面，URL应该是 `/chatlogs/<bookId>/<chatLogId>/analyze`，允许对单独一条聊天记录进行分析。
2. 页面提供一个原文显示框（只读），显示该条聊天记录的完整内容。
3. 页面提供一个分析结果区域，包括：
   1. 标题，可编辑
   2. 摘要，可编辑
   3. 正文内容，可编辑
4. 页面提供一个规则描述区域（暂时留空，具体实现方式待定）
5. 点击分析后，调用一个模拟的分析函数，生成一个摘要和正文内容，显示在对应的区域中。
   1. (目前暂时使用模拟函数，后续可替换为实际的AI分析接口)
6. 允许用户编辑摘要和正文内容，并最终选择保存到数据表ChatLogAnalysisResults中。
   1. 标题保存到 `ChatLogAnalysisResults` 的 `Title` 字段中。
   2. 正文内容保存到 `ChatLogAnalysisResults` 的 `MainBody` 字段中。
   3. 摘要保存到 `ChatLogAnalysisResults` 的 `Summary` 字段中。
   4. `ChatLogAnalysisResult` 和 `ChatLog` 以一对一的关系存储。
   5. 删除 `ChatLog` 或清空书目时，同时删除对应的 `ChatLogAnalysisResult`。
